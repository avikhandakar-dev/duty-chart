var Me=Object.defineProperty;var Ae=(L,z,T)=>z in L?Me(L,z,{enumerable:!0,configurable:!0,writable:!0,value:T}):L[z]=T;var D=(L,z,T)=>Ae(L,typeof z!="symbol"?z+"":z,T);(function(){"use strict";const L=r=>r>="0"&&r<="9",z=r=>r>="a"&&r<="z"||r>="A"&&r<="Z"||r==="_"||r==="$";class T{constructor(e){D(this,"pos",0);this.input=e}next(){const e=this.input,n=e.length;for(;this.pos<n&&/\s/.test(e[this.pos]??"");)this.pos++;if(this.pos>=n)return{type:"eof",pos:this.pos};const t=this.pos,s=e[this.pos];if(L(s)||s==="."&&L(e[this.pos+1]??"")){let m=s===".";for(this.pos++;this.pos<n;){const h=e[this.pos];if(L(h))this.pos++;else if(h==="."&&!m)m=!0,this.pos++;else break}if(e[this.pos]==="e"||e[this.pos]==="E"){let p=this.pos+1;(e[p]==="+"||e[p]==="-")&&p++;const l=p;for(;p<n&&L(e[p]);)p++;p>l&&(this.pos=p)}return{type:"number",value:e.slice(t,this.pos),pos:t}}if(z(s)){for(this.pos++;this.pos<n;){const p=e[this.pos];if(z(p)||L(p))this.pos++;else break}const m=e.slice(t,this.pos),h=m.toLowerCase();return h==="and"?{type:"and",pos:t}:h==="or"?{type:"or",pos:t}:h==="not"?{type:"not",pos:t}:h==="crossesabove"?{type:"crossesAbove",pos:t}:h==="crossesbelow"?{type:"crossesBelow",pos:t}:h==="true"||h==="false"?{type:"number",value:h==="true"?"1":"0",pos:t}:{type:"identifier",value:m,pos:t}}switch(this.pos++,s){case">":return e[this.pos]==="="?(this.pos++,{type:"gte",pos:t}):{type:"gt",pos:t};case"<":return e[this.pos]==="="?(this.pos++,{type:"lte",pos:t}):{type:"lt",pos:t};case"=":{if(e[this.pos]==="=")return this.pos++,{type:"eq",pos:t};throw new Error(`Unexpected '=' at ${t}, expected '=='`)}case"!":{if(e[this.pos]==="=")return this.pos++,{type:"neq",pos:t};throw new Error(`Unexpected '!' at ${t}, expected '!='`)}case"(":return{type:"lparen",pos:t};case")":return{type:"rparen",pos:t};case",":return{type:"comma",pos:t};default:throw new Error(`Unexpected character "${s}" at position ${t}`)}}}class I extends Error{constructor(e,n){super(e),this.position=n,this.name="ConditionParseError"}}class te{constructor(e){D(this,"current");this.tokenizer=e,this.current=e.next()}cur(){return this.current.type}eat(e){if(this.current.type!==e)throw new I(`Expected ${e} but found ${this.current.type}`,this.current.pos);const n=this.current;return this.current=this.tokenizer.next(),n}match(e){return this.current.type===e?(this.current=this.tokenizer.next(),!0):!1}parseCondition(){const e=this.parseOr();if(this.current.type!=="eof")throw new I("Unexpected input after end of condition",this.current.pos);return e}parseOr(){let e=this.parseAnd();for(;this.current.type==="or";){this.eat("or");const n=this.parseAnd();e={kind:"Logical",op:"or",left:e,right:n}}return e}parseAnd(){let e=this.parsePrimary();for(;this.current.type==="and";){this.eat("and");const n=this.parsePrimary();e={kind:"Logical",op:"and",left:e,right:n}}return e}parsePrimary(){if(this.current.type==="lparen"){this.eat("lparen");const e=this.parseOr();return this.eat("rparen"),e}if(this.current.type==="not")return this.eat("not"),{kind:"Negation",expr:this.parsePrimary()};if(this.current.type==="identifier"){const e=this.eat("identifier");if(this.cur()==="lparen"){this.eat("lparen");const h=[];if(this.cur()!=="rparen")for(;h.push(this.parseValue()),!!this.match("comma"););return this.eat("rparen"),String(e.value||"").toLowerCase()==="between"&&h.length===3?{kind:"Between",value:h[0],a:h[1],b:h[2]}:{kind:"Call",name:String(e.value||""),args:h}}const n={kind:"SeriesRef",name:String(e.value||"")};{const h=this.cur();if(h==="crossesAbove"||h==="crossesBelow"){const p=this.current;if(this.current=this.tokenizer.next(),n.kind!=="SeriesRef")throw new I("`crossesAbove/crossesBelow` left side must be a series name",p.pos);const l=this.parseValue();return{kind:"Cross",dir:p.type==="crossesAbove"?"above":"below",left:n,right:l}}}{const h=this.cur();if(h!=="gt"&&h!=="lt"&&h!=="gte"&&h!=="lte"&&h!=="eq"&&h!=="neq")return{kind:"Comparison",op:">",left:n,right:{kind:"NumberLiteral",value:0}}}const t=this.current;this.current=this.tokenizer.next();let s=">";t.type==="lt"?s="<":t.type==="gte"?s=">=":t.type==="lte"?s="<=":t.type==="eq"&&(s="==");const m=this.parseValue();return t.type==="neq"?{kind:"Logical",op:"or",left:{kind:"Comparison",op:">",left:n,right:m},right:{kind:"Comparison",op:"<",left:n,right:m}}:{kind:"Comparison",op:s,left:n,right:m}}return this.parseAtomCondition()}parseAtomCondition(){const e=this.parseValue();if(this.current.type==="crossesAbove"||this.current.type==="crossesBelow"){const h=this.current;if(this.current=this.tokenizer.next(),e.kind!=="SeriesRef")throw new I("`crossesAbove/crossesBelow` left side must be a series name",h.pos);const p=this.parseValue();return{kind:"Cross",dir:h.type==="crossesAbove"?"above":"below",left:e,right:p}}if(this.current.type!=="gt"&&this.current.type!=="lt"&&this.current.type!=="gte"&&this.current.type!=="lte"&&this.current.type!=="eq"&&this.current.type!=="neq")return{kind:"Comparison",op:">",left:e,right:{kind:"NumberLiteral",value:0}};const n=this.current;let t;switch(n.type){case"gt":t=">";break;case"lt":t="<";break;case"gte":t=">=";break;case"lte":t="<=";break;case"eq":t="==";break;case"neq":t="==";break;default:t=">";break}this.current=this.tokenizer.next();const s=this.parseValue(),m={kind:"Comparison",op:t,left:e,right:s};return n.type==="neq"?{kind:"Logical",op:"or",left:{kind:"Comparison",op:">",left:e,right:s},right:{kind:"Comparison",op:"<",left:e,right:s}}:m}parseSeriesRef(){if(this.current.type!=="identifier")throw new I("Expected series name",this.current.pos);const e=this.current;return this.current=this.tokenizer.next(),{kind:"SeriesRef",name:e.value||""}}parseValue(){if(this.current.type==="number"){const e=this.current;this.current=this.tokenizer.next();const n=Number(e.value);if(!Number.isFinite(n))throw new I("Invalid number literal",e.pos);return{kind:"NumberLiteral",value:n}}if(this.current.type==="identifier"){const e=this.current;if(this.current=this.tokenizer.next(),this.current.type==="lparen"){this.eat("lparen");const n=[];if(this.current.type!=="rparen")for(;n.push(this.parseValue()),!!this.match("comma"););return this.eat("rparen"),{kind:"ValueCall",name:String(e.value||""),args:n}}return{kind:"SeriesRef",name:String(e.value||"")}}throw new I(`Expected number or identifier but found ${this.current.type}`,this.current.pos)}}function W(r){return new te(new T(r)).parseCondition()}class J extends Error{constructor(e){super(e),this.name="ConditionEngineError"}}function re(r){return r.replace(/\s+/g,"_").toLowerCase()}function E(r,e){const n=re(e),t=r[n];if(t)return t;const s=n.replace(/_/g,"");if(s&&r[s])return r[s];if(s){const h=Object.keys(r).find(p=>p.replace(/_/g,"")===s);if(h&&r[h])return r[n]=r[h],r[n]}const m=Object.keys(r).slice(0,24).join(", ");throw new J(`Series "${e}" not found; available series: ${m}${Object.keys(r).length>24?", ...":""}`)}function ne(r){const e=Object.entries(r);if(!e.length)return 0;const n=e[0][1].length;for(const[,t]of e)if(t.length!==n)throw new J("All series must have the same length");return n}function P(r,e,n){var t,s,m,h,p,l;if(r.kind==="NumberLiteral")return r.value;if(r.kind==="SeriesRef")return E(n,r.name)[e];if(r.kind==="ValueCall"){const a=String(r.name||"").toLowerCase(),u=r.args;if(a==="lowest"||a==="highest"){const o=u[0],i=u[1],c=E(n,o.name||String(o)),w=Math.max(1,Math.floor(i.value??Number(i.name)??1)),d=Math.max(0,e-w+1);let g=a==="lowest"?1/0:-1/0;for(let f=d;f<=e;f++){const N=c[f];Number.isFinite(N)&&(a==="lowest"?g=Math.min(g,N):g=Math.max(g,N))}return Number.isFinite(g)?g:NaN}if(a==="lag"||a==="prev"){const o=u[0],i=u[1],c=E(n,o.name||String(o)),w=Math.max(1,Math.floor((i==null?void 0:i.value)??Number(i==null?void 0:i.name)??1)),d=e-w;return d>=0?c[d]:NaN}if(a==="change"){const o=u[0],i=u[1],c=E(n,o.name||String(o)),w=Math.max(1,Math.floor((i==null?void 0:i.value)??Number(i==null?void 0:i.name)??1)),d=e-w,g=c[e],f=d>=0?c[d]:NaN;return Number.isFinite(g)&&Number.isFinite(f)?g-f:NaN}if(a==="abs"){const o=P(u[0],e,n);return Math.abs(o)}if(a==="add"||a==="sub"||a==="mul"||a==="div"){const o=P(u[0],e,n),i=P(u[1],e,n);return[o,i].every(Number.isFinite)?a==="add"?o+i:a==="sub"?o-i:a==="mul"?o*i:i===0?NaN:o/i:NaN}if(a==="min"||a==="max"){const o=P(u[0],e,n),i=P(u[1],e,n);return[o,i].every(Number.isFinite)?a==="min"?Math.min(o,i):Math.max(o,i):NaN}if(a==="sma"){const o=((t=u[0])==null?void 0:t.name)||String(u[0]),i=((s=u[1])==null?void 0:s.value)??Number((m=u[1])==null?void 0:m.name),c=Math.max(1,Math.floor(Number(i)||0)),w=E(n,o);if(!Number.isFinite(w[e]))return NaN;let d=0,g=0;const f=Math.max(0,e-c+1);for(let N=f;N<=e;N++){const F=w[N];Number.isFinite(F)&&(d+=F,g++)}return g?d/g:NaN}if(a==="ema"){const o=((h=u[0])==null?void 0:h.name)||String(u[0]),i=((p=u[1])==null?void 0:p.value)??Number((l=u[1])==null?void 0:l.name),c=Math.max(1,Math.floor(Number(i)||0)),w=E(n,o),d=2/(c+1);let g;for(let f=0;f<=e;f++){const N=w[f];Number.isFinite(N)&&(g===void 0?g=N:g=N*d+g*(1-d))}return g??NaN}return NaN}return NaN}function se(r,e,n){const t=P(r.left,e,n),s=P(r.right,e,n);if(!Number.isFinite(t)||!Number.isFinite(s))return!1;switch(r.op){case">":return t>s;case"<":return t<s;case">=":return t>=s;case"<=":return t<=s;case"==":return Math.abs(t-s)<1e-9;default:return!1}}function ie(r,e,n){if(e===0)return!1;const t=E(n,r.left.name);let s,m;if(r.right.kind==="NumberLiteral")s=r.right.value,m=r.right.value;else{const l=E(n,r.right.name);s=l[e-1],m=l[e]}const h=t[e-1],p=t[e];return!Number.isFinite(h)||!Number.isFinite(s)||!Number.isFinite(p)||!Number.isFinite(m)?!1:r.dir==="above"?h<=s&&p>m:h>=s&&p<m}function oe(r,e,n){return r.op==="and"?B(r.left,e,n)&&B(r.right,e,n):B(r.left,e,n)||B(r.right,e,n)}function ae(r,e,n){let t=-1/0;for(let s=e;s<=n;s++){const m=r[s];Number.isFinite(m)&&m>t&&(t=m)}return t}function ce(r,e,n){let t=1/0;for(let s=e;s<=n;s++){const m=r[s];Number.isFinite(m)&&m<t&&(t=m)}return t}function j(r,e=1){if(!r)return e;if(r.kind==="NumberLiteral")return Number(r.value)||e;const n=r.name?String(r.name):"",t=Number(n);return Number.isFinite(t)?t:e}function ue(r,e,n,t){var p,l;const s=r.toLowerCase(),m=a=>P(a,n,t),h=a=>{const u=a?m(a):NaN;return Number.isFinite(u)?Math.max(0,u):0};if(s==="higherhigh"){const a=Math.max(1,Math.floor(j(e[0],1))),u=E(t,"high"),o=Math.max(0,n-a),i=ae(u,o,Math.max(0,n-1));return Number.isFinite(u[n])&&u[n]>i}if(s==="lowerlow"){const a=Math.max(1,Math.floor(j(e[0],1))),u=E(t,"low"),o=Math.max(0,n-a),i=ce(u,o,Math.max(0,n-1));return Number.isFinite(u[n])&&u[n]<i}if(s==="swinghigh"){const a=Math.max(1,Math.floor(j(e[0],3))),u=E(t,"high"),o=u[n];if(!Number.isFinite(o))return!1;for(let i=n-a;i<=n+a;i++){if(i===n)continue;const c=u[i];if(Number.isFinite(c)&&c>=o)return!1}return!0}if(s==="swinglow"){const a=Math.max(1,Math.floor(j(e[0],3))),u=E(t,"low"),o=u[n];if(!Number.isFinite(o))return!1;for(let i=n-a;i<=n+a;i++){if(i===n)continue;const c=u[i];if(Number.isFinite(c)&&c<=o)return!1}return!0}if(s==="volspike"){const a=Math.max(1,j(e[0],1)),u=E(t,"volume"),i=Math.max(0,n-20+1),c=(()=>{let w=0,d=0;for(let g=i;g<=n;g++){const f=u[g];Number.isFinite(f)&&(w+=f,d++)}return d?w/d:NaN})();return Number.isFinite(u[n])&&Number.isFinite(c)&&u[n]>a*c}if(s==="atrspike"){const a=Math.max(1,j(e[0],1)),u=E(t,"high"),o=E(t,"low"),i=E(t,"close"),c=14,w=b=>{const _=u[b],x=o[b],S=i[b-1];let M=Math.max(0,_-x);return Number.isFinite(S)&&(M=Math.max(M,Math.abs(_-S),Math.abs(x-S))),M};let d=NaN,g=0;for(let b=0;b<=n;b++){const _=w(b);g+=_,b===c-1?d=g/c:b>=c&&(d=(d*(c-1)+_)/c)}let f=NaN,N=0,F=0;for(let b=Math.max(0,n-c+1);b<=n;b++){const _=w(b);N+=_,F++}return f=F?N/F:NaN,Number.isFinite(d)&&Number.isFinite(f)&&d>a*f}if(s==="trend"){const a=String(((p=e[0])==null?void 0:p.name)||"").toLowerCase()||"up",u=E(t,"close"),i=Math.max(0,n-10+1),c=(()=>{let w=0,d=0,g=0,f=0,N=0;for(let b=i;b<=n;b++){const _=b-i,x=u[b];Number.isFinite(x)&&(w+=_,d+=x,g+=_*_,f+=_*x,N++)}const F=N*g-w*w;return F===0||N===0?0:(N*f-w*d)/F})();return a==="up"?c>0:c<0}if(s==="crossover"||s==="crossunder"){const a=e[0],u=e[1],o=h(e[2]),i=E(t,a.name||String(a));let c,w;if(u.kind==="NumberLiteral")c=u.value,w=u.value;else{const f=E(t,u.name||String(u));c=f[n-1],w=f[n]}const d=i[n-1],g=i[n];return[d,g,c,w].every(Number.isFinite)?s==="crossover"?d<=c+o&&g>w+o:d>=c-o&&g<w-o:!1}if(s==="rising"||s==="falling"){const a=E(t,((l=e[0])==null?void 0:l.name)||String(e[0])),u=Math.max(1,Math.floor(j(e[1],3))),o=Math.max(0,n-u+1);let i=0,c=0,w=0,d=0,g=0;for(let F=o;F<=n;F++){const b=F-o,_=a[F];Number.isFinite(_)&&(i+=b,c+=_,w+=b*b,d+=b*_,g++)}const f=g*w-i*i,N=f===0||g===0?0:(g*d-i*c)/f;return s==="rising"?N>0:N<0}if(s==="above"||s==="below"){const a=m(e[0]),u=m(e[1]),o=h(e[2]);return!Number.isFinite(a)||!Number.isFinite(u)?!1:s==="above"?a>u+o:a<u-o}return!1}function B(r,e,n){switch(r.kind){case"Comparison":return se(r,e,n);case"Cross":return ie(r,e,n);case"Logical":return oe(r,e,n);case"Negation":return!B(r.expr,e,n);case"Between":{const t=r,s=P(t.value,e,n),m=P(t.a,e,n),h=P(t.b,e,n);if(![s,m,h].every(Number.isFinite))return!1;const p=Math.min(m,h),l=Math.max(m,h);return s>=p&&s<=l}case"Call":{const t=r;return ue(String(t.name||""),t.args||[],e,n)}default:return!1}}function le(r,e){const n=ne(e),t=new Uint8Array(n);for(let s=0;s<n;s++)t[s]=B(r,s,e)?1:0;return t}const O=r=>r>="0"&&r<="9",Q=r=>r>="a"&&r<="z"||r>="A"&&r<="Z"||r==="_"||r==="$";class he{constructor(e){D(this,"pos",0);this.input=e}next(){const e=this.input,n=e.length;for(;this.pos<n&&/\s/.test(e[this.pos]??"");)this.pos++;if(this.pos>=n)return{type:"eof",start:this.pos,end:this.pos};const t=e[this.pos],s=this.pos;if(t==='"'||t==="'"){const m=t;this.pos++;let h="",p=!1;for(;this.pos<n;){const l=e[this.pos];if(this.pos++,p){switch(l){case"n":h+=`
`;break;case"t":h+="	";break;case"r":h+="\r";break;case"\\":case"'":case'"':h+=l;break;default:h+=l;break}p=!1;continue}if(l==="\\"){p=!0;continue}if(l===m)break;h+=l}return{type:"string",value:h,start:s,end:this.pos}}if(O(t)||t==="."&&O(e[this.pos+1]??"")){let m=t===".";for(this.pos++;this.pos<n;){const h=e[this.pos];if(O(h))this.pos++;else if(h==="."&&!m)m=!0,this.pos++;else break}if(e[this.pos]==="e"||e[this.pos]==="E"){let p=this.pos+1;(e[p]==="+"||e[p]==="-")&&p++;const l=p;for(;p<n&&O(e[p]);)p++;p>l&&(this.pos=p)}return{type:"number",value:e.slice(s,this.pos),start:s,end:this.pos}}if(Q(t)){for(this.pos++;this.pos<n;){const p=e[this.pos];if(Q(p)||O(p))this.pos++;else break}const m=e.slice(s,this.pos),h=m.toLowerCase();return h==="and"?{type:"and",start:s,end:this.pos}:h==="or"?{type:"or",start:s,end:this.pos}:h==="not"?{type:"not",start:s,end:this.pos}:h==="true"||h==="false"?{type:"boolean",value:h,start:s,end:this.pos}:{type:"identifier",value:m,start:s,end:this.pos}}switch(this.pos++,t){case">":return e[this.pos]==="="?(this.pos++,{type:"gte",start:s,end:this.pos}):{type:"gt",start:s,end:this.pos};case"<":return e[this.pos]==="="?(this.pos++,{type:"lte",start:s,end:this.pos}):{type:"lt",start:s,end:this.pos};case"=":if(e[this.pos]==="=")return this.pos++,{type:"eq",start:s,end:this.pos};throw new Error(`Unexpected '=' at position ${s}`);case"!":if(e[this.pos]==="=")return this.pos++,{type:"neq",start:s,end:this.pos};throw new Error(`Unexpected '!' at position ${s}`);case"+":return{type:"plus",start:s,end:this.pos};case"-":return{type:"minus",start:s,end:this.pos};case"*":return{type:"star",start:s,end:this.pos};case"/":return{type:"slash",start:s,end:this.pos};case"%":return{type:"percent",start:s,end:this.pos};case"(":return{type:"lparen",start:s,end:this.pos};case")":return{type:"rparen",start:s,end:this.pos};case",":return{type:"comma",start:s,end:this.pos};case"?":return{type:"qmark",start:s,end:this.pos};case":":return{type:"colon",start:s,end:this.pos};default:throw new Error(`Unexpected character "${t}" at position ${s}`)}}}class R extends Error{constructor(e,n){super(e),this.position=n,this.name="ParseError"}}class fe{constructor(e){D(this,"current");this.tokenizer=e,this.current=e.next()}eat(e){if(this.current.type!==e)throw new R(`Expected ${e} but found ${this.current.type}`,this.current.start);const n=this.current;return this.current=this.tokenizer.next(),n}match(e){return this.current.type===e?(this.current=this.tokenizer.next(),!0):!1}parseExpression(){return this.parseTernary()}parseTernary(){const e=this.parseOr();if(this.current.type==="qmark"){this.current=this.tokenizer.next();const n=this.parseExpression();this.eat("colon");const t=this.parseExpression();return{kind:"CallExpression",callee:"iff",args:[e,n,t]}}return e}parseOr(){let e=this.parseAnd();for(;this.current.type==="or";){this.current=this.tokenizer.next();const n=this.parseAnd();e={kind:"BinaryExpression",operator:"or",left:e,right:n}}return e}parseAnd(){let e=this.parseComparison();for(;this.current.type==="and";){this.current=this.tokenizer.next();const n=this.parseComparison();e={kind:"BinaryExpression",operator:"and",left:e,right:n}}return e}parseComparison(){let e=this.parseAddSub();for(;this.current.type==="gt"||this.current.type==="lt"||this.current.type==="gte"||this.current.type==="lte"||this.current.type==="eq"||this.current.type==="neq";){const n=this.current;this.current=this.tokenizer.next();const t=this.parseAddSub();let s="==";n.type==="gt"?s=">":n.type==="lt"?s="<":n.type==="gte"?s=">=":n.type==="lte"?s="<=":n.type==="neq"&&(s="!="),e={kind:"BinaryExpression",operator:s,left:e,right:t}}return e}parseAddSub(){let e=this.parseTerm();for(;this.current.type==="plus"||this.current.type==="minus";){const n=this.current;this.current=this.tokenizer.next();const t=this.parseTerm();e={kind:"BinaryExpression",operator:n.type==="plus"?"+":"-",left:e,right:t}}return e}parseTerm(){let e=this.parseFactor();for(;this.current.type==="star"||this.current.type==="slash"||this.current.type==="percent";){const n=this.current;this.current=this.tokenizer.next();const t=this.parseFactor();e={kind:"BinaryExpression",operator:n.type==="star"?"*":n.type==="slash"?"/":"%",left:e,right:t}}return e}parseFactor(){if(this.current.type==="not")return this.current=this.tokenizer.next(),{kind:"UnaryExpression",operator:"not",expr:this.parseFactor()};if(this.current.type==="plus"||this.current.type==="minus"){const e=this.current.type==="minus";this.current=this.tokenizer.next();const n=this.parseFactor();return e?{kind:"BinaryExpression",operator:"*",left:{kind:"NumberLiteral",value:-1},right:n}:n}return this.parsePrimary()}parsePrimary(){const e=this.current;switch(e.type){case"number":{this.current=this.tokenizer.next();const n=Number(e.value);if(!Number.isFinite(n))throw new R("Invalid number literal",e.start);return{kind:"NumberLiteral",value:n}}case"string":return this.current=this.tokenizer.next(),{kind:"StringLiteral",value:String(e.value??"")};case"boolean":return this.current=this.tokenizer.next(),{kind:"NumberLiteral",value:String(e.value||"").toLowerCase()==="true"?1:0};case"identifier":{this.current=this.tokenizer.next();const n=(e.value||"").toString();if(this.current.type==="lparen"){this.eat("lparen");const t=[];if(this.current.type!=="rparen")for(;t.push(this.parseExpression()),!!this.match("comma"););return this.eat("rparen"),{kind:"CallExpression",callee:n,args:t}}return{kind:"Identifier",name:n}}case"lparen":{this.eat("lparen");const n=this.parseExpression();return this.eat("rparen"),n}default:throw new R(`Unexpected token ${e.type}`,e.start)}}}function pe(r){const e=new fe(new he(r)),n=e.parseExpression();if(e.current.type!=="eof")throw new R("Unexpected input after end of expression",e.current.start);return n}function q(r){if(!r)return 0;let e=2166136261;for(let t=0;t<r.length;t++)e^=r.charCodeAt(t),e=Math.imul(e,16777619);const n=e>>>0;return n===0?1:n}function X(r){return Number.isFinite(r)?r.toFixed(2):""}function me(r,e){if(!Number.isFinite(r))return"";if(!e)return X(r);const n=String(e),t=n.includes("%"),s=n.split(".");let m=0;s.length>1&&(m=s[1].replace(/[^0-9#]/g,"").length);const h=t?r*100:r,p=m>0?h.toFixed(m):String(Math.round(h));return t?`${p}%`:p}class y extends Error{constructor(e){super(e),this.name="ExpressionEngineError"}}function ge(r,e){var m;const n=r.replace(/\s+/g,"_").toLowerCase();if(n==="na"||n==="nan")return NaN;if(n==="pi")return Math.PI;if(n==="e")return Math.E;if(e.selfKey&&e.selfOut&&n===e.selfKey){if(e.selfMode==="current"){const p=e.selfOut[e.index];if(Number.isFinite(p))return p}const h=e.index-1;return h>=0?e.selfOut[h]:NaN}const t=e.series[n];if(t)return t[e.index]??NaN;const s=(m=e.scalars)==null?void 0:m[n];if(typeof s=="number"&&Number.isFinite(s))return s;throw new y(`Unknown identifier "${r}"`)}function de(r){const e=r.match(/^(line|label|box|table)_get_([a-z0-9_]+)$/i);return e?{kind:e[1].toLowerCase(),prop:e[2].toLowerCase()}:null}function we(r){const e=r.match(/^strategy_(closedtrades|opentrades)_([a-z0-9_]+)$/i);return e?{kind:e[1].toLowerCase(),prop:e[2].toLowerCase()}:null}const be={profit_pct:"profit_percent",pnl:"profit",max_profit:"max_runup",max_profit_pct:"max_runup_percent",max_profit_percent:"max_runup_percent",max_runup_pct:"max_runup_percent",max_drawdown_pct:"max_drawdown_percent",max_loss:"max_drawdown",max_loss_pct:"max_drawdown_percent",max_loss_percent:"max_drawdown_percent"};function Ne(r){const e=r.toLowerCase();return be[e]??e}function ye(r,e,n,t,s){const m=Ne(n),h=r.strategy;if(!h)return NaN;if(s<0)return NaN;if(e==="closedtrades"){const S=h.closedTrades||[];if(!S.length)return 0;const M=r.series.strategy_closedtrades,A=M?M[t]:NaN,V=(typeof A=="number"&&Number.isFinite(A)?Math.floor(A):0)-1-s;if(V<0||V>=S.length)return 0;const k=S[V];switch(m){case"entry_price":return k.entryPrice;case"entry_time":return k.entryTimestamp;case"entry_bar_index":return k.entryIndex;case"exit_price":return k.exitPrice;case"exit_time":return k.exitTimestamp;case"exit_bar_index":return k.exitIndex;case"size":return k.qty;case"profit":return Number.isFinite(k.pnl)?k.pnl:0;case"profit_percent":return Number.isFinite(k.pnlPct)?k.pnlPct:0;case"max_runup":return typeof k.mfePct!="number"||!Number.isFinite(k.mfePct)?0:k.mfePct/100*k.entryPrice*k.qty;case"max_runup_percent":return typeof k.mfePct=="number"&&Number.isFinite(k.mfePct)?k.mfePct:0;case"max_drawdown":return typeof k.maePct!="number"||!Number.isFinite(k.maePct)?0:k.maePct/100*k.entryPrice*k.qty;case"max_drawdown_percent":return typeof k.maePct=="number"&&Number.isFinite(k.maePct)?k.maePct:0;case"is_long":return k.side==="long"?1:0;case"is_short":return k.side==="short"?1:0;case"entry_id":return q(String(k.entryOrderId??k.entrySignalId??""));case"exit_id":return q(String(k.exitOrderId??k.exitSignalId??""));default:return 0}}const p=h.openTradesByBar||[];if(t<0||t>=p.length)return 0;const l=p[t]||[];if(s>=l.length)return 0;const a=l[s],u=r.series.close,o=u&&Number.isFinite(u[t])?u[t]:NaN,i=a.qty,c=a.entryPrice,w=c>0&&i>0?c*i:NaN,d=Number.isFinite(o)&&Number.isFinite(c)?a.side==="long"?(o-c)*i:(c-o)*i:NaN,g=Number.isFinite(w)&&w!==0?d/w*100:NaN,f=a.maxFav,N=a.maxAdv,F=Number.isFinite(c)&&Number.isFinite(i)&&Number.isFinite(f)?a.side==="long"?(f-c)*i:(c-f)*i:NaN,b=Number.isFinite(c)&&c>0&&Number.isFinite(f)?a.side==="long"?(f-c)/c*100:(c-f)/c*100:NaN,_=Number.isFinite(c)&&Number.isFinite(i)&&Number.isFinite(N)?a.side==="long"?(N-c)*i:(c-N)*i:NaN,x=Number.isFinite(c)&&c>0&&Number.isFinite(N)?a.side==="long"?(N-c)/c*100:(c-N)/c*100:NaN;switch(m){case"entry_price":return c;case"entry_time":return a.entryTimestamp;case"entry_bar_index":return a.entryIndex;case"size":return i;case"profit":return Number.isFinite(d)?d:0;case"profit_percent":return Number.isFinite(g)?g:0;case"max_runup":return Number.isFinite(F)?F:0;case"max_runup_percent":return Number.isFinite(b)?b:0;case"max_drawdown":return Number.isFinite(_)?_:0;case"max_drawdown_percent":return Number.isFinite(x)?x:0;case"is_long":return a.side==="long"?1:0;case"is_short":return a.side==="short"?1:0;case"entry_id":return q(String(a.entryOrderId??a.entrySignalId??""));default:return 0}}function C(r,e){var n;switch(r.kind){case"NumberLiteral":return r.value;case"StringLiteral":return q(r.value);case"Identifier":return ge(r.name,e);case"UnaryExpression":{if(r.operator==="not"){const t=C(r.expr,e);return Number.isFinite(t)&&t!==0?0:1}return NaN}case"BinaryExpression":{const t=C(r.left,e),s=C(r.right,e);switch(r.operator){case"+":return t+s;case"-":return t-s;case"*":return t*s;case"/":return s===0?NaN:t/s;case"%":return s===0?NaN:t%s;case">":return Number.isFinite(t)&&Number.isFinite(s)&&t>s?1:0;case"<":return Number.isFinite(t)&&Number.isFinite(s)&&t<s?1:0;case">=":return Number.isFinite(t)&&Number.isFinite(s)&&t>=s?1:0;case"<=":return Number.isFinite(t)&&Number.isFinite(s)&&t<=s?1:0;case"==":return Number.isFinite(t)&&Number.isFinite(s)&&Math.abs(t-s)<1e-9?1:0;case"!=":return Number.isFinite(t)&&Number.isFinite(s)&&Math.abs(t-s)>=1e-9?1:0;case"and":return Number.isFinite(t)&&t!==0&&Number.isFinite(s)&&s!==0?1:0;case"or":return Number.isFinite(t)&&t!==0||Number.isFinite(s)&&s!==0?1:0;default:return NaN}}case"CallExpression":{const t=r.callee.toLowerCase(),s=de(t);if(s&&e.draw){const l=r.args[0];let a="";if(l&&l.kind==="Identifier"&&(a=l.name),l&&l.kind==="StringLiteral"&&(a=l.value),!a)return NaN;const u=e.draw.get(s.kind,s.prop,a,e.index);return typeof u=="string"?q(u):typeof u=="number"&&Number.isFinite(u)?u:NaN}const m=we(t);if(m){if(!e.strategy)return NaN;if(!r.args.length)throw new y(`${r.callee} expects (index)`);const l=C(r.args[0],e),a=Number.isFinite(l)?Math.floor(l):NaN;return Number.isFinite(a)?ye(e,m.kind,m.prop,e.index,a):NaN}const h=r.args[0],p=r.args[1];if(t==="nz"){if(r.args.length<1||r.args.length>2)throw new y("nz expects (x[, fallback])");const l=C(h,e);return Number.isFinite(l)?l:r.args.length===2?C(p,e):0}if(t==="iff"||t==="iif"||t==="if"){if(r.args.length!==3)throw new y(`${r.callee} expects (cond, a, b)`);const l=C(h,e),a=Number.isFinite(l)&&l!==0,u=C(r.args[1],e),o=C(r.args[2],e);return a?u:o}if(t==="tostring"||t==="format"||t==="upper"||t==="lower"||t==="trim"||t==="replace"||t==="replace_all"||t==="contains"||t==="startswith"||t==="endswith"||t==="length"||t==="substring"||t==="repeat"){const l=o=>Number.isFinite(o)?String(o):"",a=o=>q(o),u=o=>{var w;const i=r.args[o];if(!i)return"";if(i.kind==="StringLiteral")return i.value;if(i.kind==="Identifier"){const d=i.name.replace(/\s+/g,"_").toLowerCase(),g=(w=e.strings)==null?void 0:w[d];if(typeof g=="string")return g}const c=C(i,e);return l(c)};if(t==="tostring"){if(r.args.length<1||r.args.length>2)throw new y("tostring expects (x[, format])");const o=C(r.args[0],e),i=r.args[1];let c="";if(i){if(i.kind==="StringLiteral")c=i.value;else if(i.kind==="Identifier"){const d=i.name.replace(/\s+/g,"_").toLowerCase(),g=(n=e.strings)==null?void 0:n[d];typeof g=="string"&&(c=g)}}const w=me(o,c||void 0);return a(w)}if(t==="format"){if(r.args.length<1)throw new y("format expects (fmt, ...)");const o=u(0),i=r.args.slice(1).map(w=>X(C(w,e))),c=o.replace(/\{(\d+)\}/g,(w,d)=>i[Number(d)]??"");return a(c.replace(/{{/g,"{").replace(/}}/g,"}"))}if(t==="upper")return a(u(0).toUpperCase());if(t==="lower")return a(u(0).toLowerCase());if(t==="trim")return a(u(0).trim());if(t==="replace"||t==="replace_all"){if(r.args.length<3)throw new y("replace expects (s, from, to)");const o=u(0),i=u(1),c=u(2);return a(o.split(i).join(c))}if(t==="contains"){if(r.args.length<2)throw new y("contains expects (s, sub)");const o=u(0),i=u(1);return o.includes(i)?1:0}if(t==="startswith"){if(r.args.length<2)throw new y("startswith expects (s, sub)");const o=u(0),i=u(1);return o.startsWith(i)?1:0}if(t==="endswith"){if(r.args.length<2)throw new y("endswith expects (s, sub)");const o=u(0),i=u(1);return o.endsWith(i)?1:0}if(t==="length"){if(r.args.length!==1)throw new y("length expects (s)");return u(0).length}if(t==="substring"){if(r.args.length<2)throw new y("substring expects (s, from[, to])");const o=u(0),i=C(r.args[1],e),c=r.args.length>2?C(r.args[2],e):NaN,w=Math.max(0,Math.floor(i)),d=Number.isFinite(c)?Math.max(w,Math.floor(c)):void 0;return a(d==null?o.slice(w):o.slice(w,d))}if(t==="repeat"){if(r.args.length<2)throw new y("repeat expects (s, count)");const o=u(0),i=Math.max(0,Math.floor(C(r.args[1],e)));return a(o.repeat(i))}}if(t==="add"||t==="sub"||t==="mul"||t==="div"){if(r.args.length!==2)throw new y(`${r.callee} expects 2 arguments`);const l=C(h,e),a=C(p,e);return t==="add"?l+a:t==="sub"?l-a:t==="mul"?l*a:a===0?NaN:l/a}if(t==="min"||t==="max"){if(r.args.length!==2)throw new y(`${r.callee} expects 2 arguments`);const l=C(h,e),a=C(p,e);return t==="min"?Math.min(l,a):Math.max(l,a)}if(t==="abs"){if(r.args.length!==1)throw new y("abs expects 1 argument");return Math.abs(C(h,e))}if(t==="pow"){if(r.args.length!==2)throw new y("pow expects 2 arguments");const l=C(h,e),a=C(p,e);return Math.pow(l,a)}if(t==="sqrt"||t==="log"||t==="log10"||t==="exp"||t==="floor"||t==="ceil"||t==="round"||t==="sin"||t==="cos"||t==="tan"||t==="asin"||t==="acos"||t==="atan"||t==="sign"){if(r.args.length!==1)throw new y(`${r.callee} expects 1 argument`);const l=C(h,e);switch(t){case"sqrt":return Math.sqrt(l);case"log":return Math.log(l);case"log10":return Math.log10(l);case"exp":return Math.exp(l);case"floor":return Math.floor(l);case"ceil":return Math.ceil(l);case"round":return Math.round(l);case"sin":return Math.sin(l);case"cos":return Math.cos(l);case"tan":return Math.tan(l);case"asin":return Math.asin(l);case"acos":return Math.acos(l);case"atan":return Math.atan(l);default:return Math.sign(l)}}if(t==="cum"||t==="cumsum"){if(r.args.length!==1)throw new y(`${r.callee} expects 1 argument`);const l=h;if(l.kind!=="Identifier")throw new y(`${r.callee} expects a series identifier`);const a=l.name.replace(/\s+/g,"_").toLowerCase(),u=e.series[a];if(!u)throw new y(`Unknown identifier "${l.name}"`);let o=0;for(let i=0;i<=e.index;i++){const c=u[i];Number.isFinite(c)&&(o+=c)}return o}if(t==="barssince"){if(r.args.length!==1)throw new y("barssince expects (condition)");const l=h;if(l.kind!=="Identifier")throw new y("barssince expects a series identifier");const a=l.name.replace(/\s+/g,"_").toLowerCase(),u=e.series[a];if(!u)throw new y(`Unknown identifier "${l.name}"`);for(let o=e.index;o>=0;o--){const i=u[o];if(Number.isFinite(i)&&i!==0)return e.index-o}return NaN}if(t==="tr"){if(r.args.length!==0&&r.args.length!==3)throw new y("tr expects () or (high, low, close)");const l=(g,f)=>{if(!g){const b=e.series[f];if(!b)throw new y(`Unknown identifier "${f}"`);return b}if(g.kind!=="Identifier")throw new y("tr expects series identifiers");const N=g.name.replace(/\s+/g,"_").toLowerCase(),F=e.series[N];if(!F)throw new y(`Unknown identifier "${g.name}"`);return F},a=l(r.args[0],"high"),u=l(r.args[1],"low"),o=l(r.args[2],"close"),i=a[e.index],c=u[e.index],w=e.index>0?o[e.index-1]:NaN;let d=Math.max(0,i-c);return Number.isFinite(w)&&(d=Math.max(d,Math.abs(i-w),Math.abs(c-w))),d}if(t==="prev"||t==="lag"||t==="change"){if(r.args.length!==2)throw new y(`${r.callee} expects (series, n)`);const l=h;if(l.kind!=="Identifier")throw new y(`${r.callee} expects first argument to be a series identifier`);const a=l.name.replace(/\s+/g,"_").toLowerCase(),u=C(p,e),o=Math.max(1,Math.floor(u)),i=e.index-o,c=g=>{if(g<0)return NaN;if(e.selfKey&&e.selfOut&&a===e.selfKey)return e.selfOut[g]??NaN;const f=e.series[a];if(!f)throw new y(`Unknown identifier "${l.name}"`);return f[g]??NaN};if(t==="prev"||t==="lag")return c(i);const w=c(e.index),d=c(i);return Number.isFinite(w)&&Number.isFinite(d)?w-d:NaN}if(t==="crossover"||t==="crossunder"){if(r.args.length<2||r.args.length>3)throw new y(`${r.callee} expects (series, series[, tol])`);const l=h;if(l.kind!=="Identifier")throw new y(`${r.callee} expects first argument to be a series identifier`);const a=l.name.replace(/\s+/g,"_").toLowerCase(),u=e.series[a];if(!u)throw new y(`Unknown identifier "${l.name}"`);const o=r.args[1];let i=null,c=NaN;if(o.kind==="Identifier"){const F=o.name.replace(/\s+/g,"_").toLowerCase();if(i=e.series[F]||null,!i){const b=Number(o.name);c=Number.isFinite(b)?b:NaN}}else c=C(o,e);const w=r.args[2]?Math.max(0,C(r.args[2],e)):0;if(e.index<=0)return 0;const d=u[e.index-1],g=u[e.index],f=i?i[e.index-1]:c,N=i?i[e.index]:c;return[d,g,f,N].every(Number.isFinite)?t==="crossover"?d<=f+w&&g>N+w?1:0:d>=f-w&&g<N-w?1:0:0}throw new y(`Unknown function "${r.callee}"`)}default:return NaN}}function ke(r,e,n,t){var u;const s=Object.entries(e),m=((u=s[0])==null?void 0:u[1].length)??0;for(const[,o]of s)if(o.length!==m)throw new y("All base series must have the same length");const h=(()=>{if(!n||typeof n!="object")return;const o={};return Object.entries(n).forEach(([i,c])=>{const w=i.replace(/\s+/g,"_").toLowerCase();if(typeof c=="number"&&Number.isFinite(c)){o[w]=c;return}if(typeof c=="string"){const d=Number(c);o[w]=Number.isFinite(d)?d:q(c)}}),Object.keys(o).length?o:void 0})(),p=(()=>{if(!n||typeof n!="object")return;const o={};return Object.entries(n).forEach(([i,c])=>{typeof c=="string"&&(o[i.replace(/\s+/g,"_").toLowerCase()]=c)}),Object.keys(o).length?o:void 0})();let l;try{l=pe(r)}catch(o){throw o instanceof R?new y(`Syntax error at position ${o.position}: ${o.message}`):o}const a=new Float32Array(m);for(let o=0;o<m;o++){const i={series:e,scalars:h,strings:p,length:m,index:o,strategy:t};a[o]=C(l,i)}return a}function ve(r){const e=String(r||"");let n="",t=null,s=0;const m=p=>/[A-Za-z_$]/.test(p),h=p=>/[A-Za-z0-9_$]/.test(p);for(;s<e.length;){const p=e[s];if(t){n+=p,p===t&&e[s-1]!=="\\"&&(t=null),s+=1;continue}if(p==="'"||p==='"'){t=p,n+=p,s+=1;continue}if(m(p)){let l=s+1;for(;l<e.length&&h(e[l]);)l+=1;const a=e.slice(s,l);let u=l;for(;u<e.length&&/\s/.test(e[u]);)u+=1;if(e[u]==="["){let o=u+1;for(;o<e.length&&/\s/.test(e[o]);)o+=1;let i=1;e[o]==="-"&&(i=-1,o+=1);let c=o;for(;c<e.length&&/[0-9]/.test(e[c]);)c+=1;const w=e.slice(o,c);for(;c<e.length&&/\s/.test(e[c]);)c+=1;if(w&&e[c]==="]"){const d=i*Number(w);if(Number.isFinite(d)&&d>=1){n+=`prev(${a}, ${Math.floor(d)})`,s=c+1;continue}if(Number.isFinite(d)&&d===0){n+=a,s=c+1;continue}}}n+=a,s=l;continue}n+=p,s+=1}return n}function Fe(r){if(!r)return 0;let e=2166136261;for(let t=0;t<r.length;t++)e^=r.charCodeAt(t),e=Math.imul(e,16777619);const n=e>>>0;return n===0?1:n}function _e(r){const e=String(r||"");let n="",t=0;for(;t<e.length;){const s=e[t];if(s==='"'||s==="'"){const m=s;t+=1;let h="",p=!1;for(;t<e.length;){const l=e[t];if(p){h+=l,p=!1,t+=1;continue}if(l==="\\"){p=!0,t+=1;continue}if(l===m){t+=1;break}h+=l,t+=1}n+=String(Fe(h));continue}n+=s,t+=1}return n}function Y(r){let e=String(r||"").replace(/\bta\./g,"").replace(/\bmath\./g,"").replace(/\bstr\./g,"").replace(/\b(barstate|timeframe|syminfo|strategy)\.([A-Za-z0-9_]+)/gi,(n,t,s)=>`${String(t).toLowerCase()}_${s}`);return e=_e(e),ve(e)}function Se(r){return r==="entry_long"||r==="exit_long"||r==="entry_short"||r==="exit_short"||r==="alert"||r==="cancel"||r==="cancel_all"}self.onmessage=r=>{var w,d;const e=r.data,n=[],t=[];if(!e||!e.signals||!e.condSeries){const g={id:(e==null?void 0:e.id)||"unknown",signals:[],errors:["Invalid request"]};self.postMessage(g);return}const s=e.condSeries,m=e.params&&typeof e.params=="object"?e.params:void 0,h=e.bars||[],p=h.length||(((w=Object.values(s)[0])==null?void 0:w.length)??0),l={};Object.entries(s).forEach(([g,f])=>{const N=g.replace(/\s+/g,"_").toLowerCase();if(f instanceof Float32Array){l[N]=f;return}const F=new Float32Array(p);for(let b=0;b<p;b++)F[b]=(f==null?void 0:f[b])??NaN;l[N]=F});const a=new Map,u=new Map,o=g=>{const f=String(g||"").replace(/\$\{([^}]+)\}/g,(b,_)=>{var S;const x=(m==null?void 0:m[_])??(m==null?void 0:m[(S=_==null?void 0:_.toLowerCase)==null?void 0:S.call(_)]);return x==null?b:String(x)}),N=Y(f);if(!N)return null;const F=a.get(N);if(F)return F;try{const b=ke(N,l,m);return a.set(N,b),b}catch(b){return t.push(`Expression error for signal: ${(b==null?void 0:b.message)||String(b)}`),null}},i=g=>{const f=String(g||"").replace(/\$\{([^}]+)\}/g,(x,S)=>{var A;const M=(m==null?void 0:m[S])??(m==null?void 0:m[(A=S==null?void 0:S.toLowerCase)==null?void 0:A.call(S)]);return M==null?x:String(M)}),N=Y(f);if(!N)return null;const F=u.get(N);if(F)return F;const b=o(f);if(!b)return null;const _=new Uint8Array(p);for(let x=0;x<p;x++){const S=b[x];_[x]=Number.isFinite(S)&&S!==0?1:0}return u.set(N,_),_};for(let g=0;g<e.signals.length;g++){const f=e.signals[g];if(!Se(String(f==null?void 0:f.type))){t.push(`Unknown signal type: ${String(f==null?void 0:f.type)}`);continue}const N=String((f==null?void 0:f.id)||g),F=(f==null?void 0:f.orderId)!=null&&String(f.orderId).trim()?String(f.orderId).trim():void 0,b=String((f==null?void 0:f.whenExpr)||"").trim(),_=String((f==null?void 0:f.when)||"").trim();if(!b&&!_){t.push(`Empty condition for ${f.type}`);continue}let x,S;if(b){const v=i(b);if(!v)continue;S=v}else{try{const v=_.replace(/\/\/.*$/,"").replace(/#.*$/,"").replace(/[,;]+\s*$/,"").replace(/\b(and|or)\b\s*$/i,"").replace(/\bcrosses\s+above\b/gi,"crossesAbove").replace(/\bcrosses\s+below\b/gi,"crossesBelow").trim();try{x=W(v)}catch{const U=v.match(/^(\w+)\s*(crossesAbove|crossesBelow)\s*(\w+|[-+]?\d+(?:\.\d+)?)$/i);if(U){const G=U[1],xe=U[2],Ee=U[3],$e=`${G} ${xe==="crossesBelow"?"<":">"} ${Ee}`;x=W($e)}else x=W(v)}}catch(v){t.push(`Condition parse error for ${f.type}: ${(v==null?void 0:v.message)||String(v)}`);continue}try{S=le(x,s)}catch(v){t.push(`Condition eval error for ${f.type}: ${(v==null?void 0:v.message)||String(v)}`);continue}}const M=String((f==null?void 0:f.cooldownExpr)||"").trim(),A=M?o(M):null;if(A){for(let v=0;v<p;v++){const $=A[v];if(Number.isFinite($)&&(!Number.isInteger($)||$<0)){t.push(`cooldownExpr must be a non-negative integer for ${f.type}`),S=null;break}}if(!S)continue}const Z=f==null?void 0:f.cooldownBars,V=typeof Z=="number"&&Number.isFinite(Z)?Math.max(0,Math.floor(Z)):0,k=String((f==null?void 0:f.scoreExpr)||"").trim(),K=k?o(k):null;if(K){for(let v=0;v<p;v++){const $=K[v];if(Number.isFinite($)&&(!Number.isInteger($)||$<0||$>10)){t.push(`scoreExpr must be an integer 0..10 for ${f.type}`),S=null;break}}if(!S)continue}const H=f==null?void 0:f.score,Ce=typeof H=="number"&&Number.isFinite(H)?H:null;let ee=0;for(let v=0;v<p;v++){const $=A&&Number.isFinite(A[v])?Math.max(0,Math.floor(A[v])):V;if($>0&&v<ee||!S[v])continue;const U=((d=h[v])==null?void 0:d.timestamp)??Date.now(),G=K&&Number.isFinite(K[v])?K[v]:Ce;n.push({type:f.type,index:v,timestamp:U,signalId:N,orderId:F,order:f.order,score:G??null}),$>0&&(ee=v+$)}}const c={id:e.id,signals:n,errors:t.length?t:void 0};self.postMessage(c)}})();
