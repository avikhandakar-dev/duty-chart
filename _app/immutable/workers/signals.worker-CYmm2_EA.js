var oi=Object.defineProperty;var ai=(J,Q,ge)=>Q in J?oi(J,Q,{enumerable:!0,configurable:!0,writable:!0,value:ge}):J[Q]=ge;var gn=(J,Q,ge)=>ai(J,typeof Q!="symbol"?Q+"":Q,ge);(function(){"use strict";const J=n=>n>="0"&&n<="9",Q=n=>n>="a"&&n<="z"||n>="A"&&n<="Z"||n==="_"||n==="$";class ge{constructor(e){gn(this,"pos",0);this.input=e}next(){const e=this.input,s=e.length;for(;this.pos<s&&/\s/.test(e[this.pos]??"");)this.pos++;if(this.pos>=s)return{type:"eof",start:this.pos,end:this.pos};const i=e[this.pos],a=this.pos;if(i==='"'||i==="'"){const c=i;this.pos++;let t="",h=!1;for(;this.pos<s;){const m=e[this.pos];if(this.pos++,h){switch(m){case"n":t+=`
`;break;case"t":t+="	";break;case"r":t+="\r";break;case"\\":case"'":case'"':t+=m;break;default:t+=m;break}h=!1;continue}if(m==="\\"){h=!0;continue}if(m===c)break;t+=m}return{type:"string",value:t,start:a,end:this.pos}}if(J(i)||i==="."&&J(e[this.pos+1]??"")){let c=i===".";for(this.pos++;this.pos<s;){const t=e[this.pos];if(J(t))this.pos++;else if(t==="."&&!c)c=!0,this.pos++;else break}if(e[this.pos]==="e"||e[this.pos]==="E"){let h=this.pos+1;(e[h]==="+"||e[h]==="-")&&h++;const m=h;for(;h<s&&J(e[h]);)h++;h>m&&(this.pos=h)}return{type:"number",value:e.slice(a,this.pos),start:a,end:this.pos}}if(Q(i)){for(this.pos++;this.pos<s;){const h=e[this.pos];if(Q(h)||J(h))this.pos++;else break}const c=e.slice(a,this.pos),t=c.toLowerCase();return t==="and"?{type:"and",start:a,end:this.pos}:t==="or"?{type:"or",start:a,end:this.pos}:t==="not"?{type:"not",start:a,end:this.pos}:t==="true"||t==="false"?{type:"boolean",value:t,start:a,end:this.pos}:{type:"identifier",value:c,start:a,end:this.pos}}switch(this.pos++,i){case".":return{type:"dot",start:a,end:this.pos};case">":return e[this.pos]==="="?(this.pos++,{type:"gte",start:a,end:this.pos}):{type:"gt",start:a,end:this.pos};case"<":return e[this.pos]==="="?(this.pos++,{type:"lte",start:a,end:this.pos}):{type:"lt",start:a,end:this.pos};case"=":if(e[this.pos]==="=")return this.pos++,{type:"eq",start:a,end:this.pos};throw new Error(`Unexpected '=' at position ${a}`);case"!":if(e[this.pos]==="=")return this.pos++,{type:"neq",start:a,end:this.pos};throw new Error(`Unexpected '!' at position ${a}`);case"+":return{type:"plus",start:a,end:this.pos};case"-":return{type:"minus",start:a,end:this.pos};case"*":return{type:"star",start:a,end:this.pos};case"/":return{type:"slash",start:a,end:this.pos};case"%":return{type:"percent",start:a,end:this.pos};case"(":return{type:"lparen",start:a,end:this.pos};case")":return{type:"rparen",start:a,end:this.pos};case",":return{type:"comma",start:a,end:this.pos};case"?":return{type:"qmark",start:a,end:this.pos};case":":return{type:"colon",start:a,end:this.pos};case"[":return{type:"lbracket",start:a,end:this.pos};case"]":return{type:"rbracket",start:a,end:this.pos};default:throw new Error(`Unexpected character "${i}" at position ${a}`)}}}class me extends Error{constructor(e,s){super(e),this.position=s,this.name="ParseError"}}class Et{constructor(e){gn(this,"current");this.tokenizer=e,this.current=e.next()}eat(e){if(this.current.type!==e)throw new me(`Expected ${e} but found ${this.current.type}`,this.current.start);const s=this.current;return this.current=this.tokenizer.next(),s}match(e){return this.current.type===e?(this.current=this.tokenizer.next(),!0):!1}parseExpression(){return this.parseTernary()}parseTernary(){const e=this.parseOr();if(this.current.type==="qmark"){this.current=this.tokenizer.next();const s=this.parseExpression();this.eat("colon");const i=this.parseExpression();return{kind:"CallExpression",callee:"iff",args:[e,s,i]}}return e}parseOr(){let e=this.parseAnd();for(;this.current.type==="or";){this.current=this.tokenizer.next();const s=this.parseAnd();e={kind:"BinaryExpression",operator:"or",left:e,right:s}}return e}parseAnd(){let e=this.parseComparison();for(;this.current.type==="and";){this.current=this.tokenizer.next();const s=this.parseComparison();e={kind:"BinaryExpression",operator:"and",left:e,right:s}}return e}parseComparison(){let e=this.parseAddSub();for(;this.current.type==="gt"||this.current.type==="lt"||this.current.type==="gte"||this.current.type==="lte"||this.current.type==="eq"||this.current.type==="neq";){const s=this.current;this.current=this.tokenizer.next();const i=this.parseAddSub();let a="==";s.type==="gt"?a=">":s.type==="lt"?a="<":s.type==="gte"?a=">=":s.type==="lte"?a="<=":s.type==="neq"&&(a="!="),e={kind:"BinaryExpression",operator:a,left:e,right:i}}return e}parseAddSub(){let e=this.parseTerm();for(;this.current.type==="plus"||this.current.type==="minus";){const s=this.current;this.current=this.tokenizer.next();const i=this.parseTerm();e={kind:"BinaryExpression",operator:s.type==="plus"?"+":"-",left:e,right:i}}return e}parseTerm(){let e=this.parseFactor();for(;this.current.type==="star"||this.current.type==="slash"||this.current.type==="percent";){const s=this.current;this.current=this.tokenizer.next();const i=this.parseFactor();e={kind:"BinaryExpression",operator:s.type==="star"?"*":s.type==="slash"?"/":"%",left:e,right:i}}return e}parseFactor(){if(this.current.type==="not")return this.current=this.tokenizer.next(),{kind:"UnaryExpression",operator:"not",expr:this.parseFactor()};if(this.current.type==="plus"||this.current.type==="minus"){const e=this.current.type==="minus";this.current=this.tokenizer.next();const s=this.parseFactor();return e?{kind:"BinaryExpression",operator:"*",left:{kind:"NumberLiteral",value:-1},right:s}:s}return this.parsePostfix(this.parsePrimary())}parsePostfix(e){var i;let s=e;for(;;){if(this.current.type==="dot"){if(this.current=this.tokenizer.next(),this.current.type!=="identifier")throw new me("Expected identifier after '.'",this.current.start);const a=((i=this.current.value)==null?void 0:i.toString())??"";this.current=this.tokenizer.next(),s={kind:"MemberExpression",object:s,property:{kind:"Identifier",name:a}};continue}if(this.current.type==="lbracket"){this.current=this.tokenizer.next();const a=this.parseExpression();this.eat("rbracket"),s={kind:"IndexExpression",object:s,index:a};continue}break}return s}parsePrimary(){const e=this.current;switch(e.type){case"number":{this.current=this.tokenizer.next();const s=Number(e.value);if(!Number.isFinite(s))throw new me("Invalid number literal",e.start);return{kind:"NumberLiteral",value:s}}case"string":return this.current=this.tokenizer.next(),{kind:"StringLiteral",value:String(e.value??"")};case"boolean":return this.current=this.tokenizer.next(),{kind:"NumberLiteral",value:String(e.value||"").toLowerCase()==="true"?1:0};case"identifier":{this.current=this.tokenizer.next();const s=(e.value||"").toString();if(this.current.type==="lparen"){this.eat("lparen");const i=[];if(this.current.type!=="rparen")for(;i.push(this.parseExpression()),!!this.match("comma"););return this.eat("rparen"),{kind:"CallExpression",callee:s,args:i}}return{kind:"Identifier",name:s}}case"lparen":{this.eat("lparen");const s=this.parseExpression();return this.eat("rparen"),s}default:throw new me(`Unexpected token ${e.type}`,e.start)}}}function We(n){const e=new Et(new ge(n)),s=e.parseExpression();if(e.current.type!=="eof")throw new me("Unexpected input after end of expression",e.current.start);return s}function He(n,e){const s=[];let i=0;for(let a=0;a<n.length;a++){const c=n[a];i+=c??0,a>=e&&(i-=n[a-e]??0),s.push(a>=e-1?i/e:void 0)}return s}function Ye(n,e){const s=[],i=2/(e+1);let a;for(let c=0;c<n.length;c++){const t=n[c];if(t==null){s.push(void 0);continue}a=a===void 0?t:t*i+a*(1-i),s.push(a)}return s}function It(n,e){const s=new Array(n.length);let i=0,a;for(let c=0;c<n.length;c++){const t=n[c],h=e[c]??0;if(a===void 0||t===void 0){s[c]=void 0,a=t;continue}t>a?i+=h:t<a&&(i-=h),s[c]=i,a=t}return s}function Lt(n,e,s,i){const a=s.length,c=new Array(a);for(let m=0;m<a;m++)c[m]=((n[m]??s[m]??0)+(e[m]??s[m]??0)+(s[m]??0))/3;const t=He(c.map(m=>m),i).map(m=>m),h=new Array(a);for(let m=0;m<a;m++){if(m<i-1){h[m]=void 0;continue}let d=0;for(let l=m-i+1;l<=m;l++)d+=Math.abs(c[l]-t[m]);d=d/i;const r=.015*d;h[m]=r===0?void 0:(c[m]-t[m])/r}return h}function Ct(n,e,s,i,a){const c=s.length,t=new Array(c),h=new Array(c);for(let d=0;d<c;d++)h[d]=((n[d]??s[d]??0)+(e[d]??s[d]??0)+(s[d]??0))/3;const m=new Array(c);for(let d=0;d<c;d++)m[d]=h[d]*(i[d]??0);for(let d=0;d<c;d++){if(d<a){t[d]=void 0;continue}let r=0,l=0;for(let f=d-a+1;f<=d;f++)h[f]>=h[f-1]?r+=m[f]:l+=m[f];const u=l===0?1/0:r/l;t[d]=100-100/(1+u)}return t}function Rt(n,e,s){const i=n.map(m=>m??NaN),a=He(i,e),c=[];for(let m=0;m<i.length;m++){if(m<e-1){c.push(void 0);continue}let d=0;for(let u=m-e+1;u<=m;u++)d+=i[u];const r=d/e;let l=0;for(let u=m-e+1;u<=m;u++){const f=i[u]-r;l+=f*f}c.push(Math.sqrt(l/e))}const t=new Array(i.length),h=new Array(i.length);for(let m=0;m<i.length;m++){const d=a[m],r=c[m];t[m]=d===void 0||r===void 0?void 0:d+s*r,h[m]=d===void 0||r===void 0?void 0:d-s*r}return{mid:a,upper:t,lower:h}}function Ut(n,e,s){const i=n.length,a=new Array(i);let c=0;for(let t=0;t<i;t++){const h=n[t],m=e[t]??0;if(h==null){a[t]=void 0;continue}const d=m/Math.max(1,e[t-1]??m);c=(c*(s-1)+h*d)/s,a[t]=c}return a}function x(n){if(!n)return 0;let e=2166136261;for(let i=0;i<n.length;i++)e^=n.charCodeAt(i),e=Math.imul(e,16777619);const s=e>>>0;return s===0?1:s}function wn(n){return Number.isFinite(n)?n.toFixed(2):""}function Pt(n,e){if(!Number.isFinite(n))return"";if(!e)return wn(n);const s=String(e),i=s.includes("%"),a=s.split(".");let c=0;a.length>1&&(c=a[1].replace(/[^0-9#]/g,"").length);const t=i?n*100:n,h=c>0?t.toFixed(c):String(Math.round(t));return i?`${h}%`:h}class b extends Error{constructor(e){super(e),this.name="ExpressionEngineError"}}function W(n,e){const s=n.length,i=new Float32Array(s);let a=0;for(let c=0;c<s;c++){const t=n[c];if(Number.isFinite(t)&&(a+=t),c>=e){const h=n[c-e];Number.isFinite(h)&&(a-=h)}i[c]=c>=e-1?a:NaN}return i}function Nn(n,e,s){const i=n.length,a=new Float32Array(i),c=e-1,t=s==="rising";for(let h=0;h<i;h++){if(h<c){a[h]=NaN;continue}let m=!0,d=!0;const r=h-c;for(let l=r;l<=h;l++){const u=n[l];if(!Number.isFinite(u)){d=!1;break}if(l===r)continue;const f=n[l-1];if(!Number.isFinite(f)){d=!1;break}(t?!(u>f):!(u<f))&&(m=!1)}a[h]=d?m?1:0:NaN}return a}function bn(n,e,s){let i=-1/0;for(let a=e;a<=s;a++){const c=n[a];Number.isFinite(c)&&c>i&&(i=c)}return i}function pn(n,e,s){let i=1/0;for(let a=e;a<=s;a++){const c=n[a];Number.isFinite(c)&&c<i&&(i=c)}return i}function qt(n,e){const s=n.length,i=new Float32Array(s),a=Math.max(1,Math.floor(e));for(let c=0;c<s;c++){const t=c-a,h=n[c],m=t>=0?n[t]:NaN;i[c]=Number.isFinite(h)&&Number.isFinite(m)?h-m:NaN}return i}function Me(n,e){const s=n.length,i=new Float32Array(s),a=Math.max(1,Math.floor(e));for(let c=0;c<s;c++){const t=c-a,h=n[c],m=t>=0?n[t]:NaN;!Number.isFinite(h)||!Number.isFinite(m)||m===0?i[c]=NaN:i[c]=(h-m)/m*100}return i}function jt(n,e){const s=n.length,i=new Float32Array(s),a=Math.max(1,Math.floor(e));for(let c=0;c<s;c++){const t=c-a,h=n[c],m=t>=0?n[t]:NaN;i[c]=Number.isFinite(h)&&Number.isFinite(m)?h-m:NaN}return i}function Y(n){const e=new Array(n.length);for(let s=0;s<n.length;s++){const i=n[s];e[s]=Number.isFinite(i)?i:void 0}return e}function ee(n){const e=new Float32Array(n.length);for(let s=0;s<n.length;s++){const i=n[s];e[s]=i==null||!Number.isFinite(i)?NaN:i}return e}function Dt(n,e,s,i){const a=Y(n),c=Ye(a,e),t=Ye(a,s),h=new Array(a.length);for(let r=0;r<a.length;r++){const l=c[r],u=t[r];h[r]=l==null||u==null?void 0:l-u}const m=Ye(h,i),d=new Array(a.length);for(let r=0;r<a.length;r++){const l=h[r],u=m[r];d[r]=l==null||u==null?void 0:l-u}return{line:ee(h),signal:ee(m),hist:ee(d)}}function Ot(n,e,s,i,a){const c=s.length,t=new Array(c);for(let r=0;r<c;r++){const l=Math.max(0,r-i+1);let u=-1/0,f=1/0;for(let w=l;w<=r;w++){const k=Number.isFinite(n[w])?n[w]:s[w],F=Number.isFinite(e[w])?e[w]:s[w];Number.isFinite(k)&&k>u&&(u=k),Number.isFinite(F)&&F<f&&(f=F)}const o=s[r],g=u-f;!Number.isFinite(o)||!Number.isFinite(u)||!Number.isFinite(f)||g===0?t[r]=void 0:t[r]=100*((o-f)/g)}const h=t.map(r=>r??NaN),m=He(h,a),d=new Array(c);for(let r=0;r<c;r++){const l=m[r];d[r]=Number.isFinite(l)?l:void 0}return{k:ee(t),d:ee(d)}}function kn(n,e,s,i){const a=s.length,c=new Float32Array(a);for(let t=0;t<a;t++){const h=Math.max(0,t-i+1);let m=-1/0,d=1/0,r=!1;for(let f=h;f<=t;f++){const o=Number.isFinite(n[f])?n[f]:s[f],g=Number.isFinite(e[f])?e[f]:s[f];Number.isFinite(o)&&(o>m&&(m=o),r=!0),Number.isFinite(g)&&(g<d&&(d=g),r=!0)}const l=s[t],u=m-d;if(!r||!Number.isFinite(l)||!Number.isFinite(m)||!Number.isFinite(d)||u===0){c[t]=NaN;continue}c[t]=-100*((m-l)/u)}return c}function Ie(n,e,s){const i=ct(n,s),a=ft(e,s),c=n.length,t=new Float32Array(c),h=new Float32Array(c);for(let m=0;m<c;m++){const d=i[m],r=a[m];if(!Number.isFinite(d)||!Number.isFinite(r)){t[m]=NaN,h[m]=NaN;continue}t[m]=100*((s-d)/s),h[m]=100*((s-r)/s)}return{up:t,down:h}}function Tt(n,e,s){const{up:i,down:a}=Ie(n,e,s),c=i.length,t=new Float32Array(c);for(let h=0;h<c;h++){const m=i[h],d=a[h];t[h]=Number.isFinite(m)&&Number.isFinite(d)?m-d:NaN}return t}function re(n,e,s,i,a){const c=s.length,t=new Float32Array(c),h=new Float32Array(c),m=new Float32Array(c);for(let w=0;w<c;w++){const k=n[w],F=e[w],M=s[w];if(!Number.isFinite(k)||!Number.isFinite(F)||!Number.isFinite(M)){t[w]=NaN,h[w]=NaN,m[w]=NaN;continue}if(w===0){t[w]=Math.max(0,k-F),h[w]=0,m[w]=0;continue}const N=n[w-1],p=e[w-1],v=s[w-1];if(!Number.isFinite(N)||!Number.isFinite(p)||!Number.isFinite(v)){t[w]=NaN,h[w]=NaN,m[w]=NaN;continue}const y=k-N,_=p-F;h[w]=y>_&&y>0?y:0,m[w]=_>y&&_>0?_:0;const S=k-F,C=Math.abs(k-v),L=Math.abs(F-v);t[w]=Math.max(0,S,C,L)}const d=ke(t,i),r=ke(h,i),l=ke(m,i),u=new Float32Array(c),f=new Float32Array(c),o=new Float32Array(c);for(let w=0;w<c;w++){const k=d[w],F=r[w],M=l[w];if(!Number.isFinite(k)||k===0||!Number.isFinite(F)||!Number.isFinite(M)){u[w]=NaN,f[w]=NaN,o[w]=NaN;continue}u[w]=100*(F/k),f[w]=100*(M/k);const N=u[w]+f[w];o[w]=N===0?NaN:100*(Math.abs(u[w]-f[w])/N)}const g=ke(o,a);return{plus:u,minus:f,adx:g}}function Fn(n,e){const s=n.length,i=new Float32Array(s);for(let a=0;a<s;a++){const c=n[a],t=e[a],h=c+t;i[a]=Number.isFinite(c)&&Number.isFinite(t)&&h!==0?100*(Math.abs(c-t)/h):NaN}return i}function vn(n,e,s,i){const a=n.length,c=new Float32Array(a),t=Math.max(1,s+1),h=new Array(t);let m=0,d=0;const r=i||(l=>Number.isFinite(l)&&l!==0);for(let l=0;l<a;l++){const u=n[l];if(r(u)&&(h[d]=l,d=(d+1)%t,m<t&&(m+=1)),m>s){const f=h[(d-1-s+t)%t],o=e[f];c[l]=Number.isFinite(o)?o:NaN}else c[l]=NaN}return c}function yn(n,e){if(!Number.isFinite(n)||!Number.isFinite(e)||!Number.isInteger(n)||!Number.isInteger(e)||n<1||e<1)throw new b("pivot left/right must be positive integers");return{left:n,right:e}}function Bt(n,e,s,i){const a=n.length,c=new Float32Array(a);for(let t=0;t<a;t++){const h=t-s;if(h-e<0){c[t]=NaN;continue}const m=n[h];if(!Number.isFinite(m)){c[t]=NaN;continue}const d=h-e,r=h+s;let l=!0;for(let u=d;u<=r;u++){const f=n[u];if(!Number.isFinite(f)){l=!1;break}if(i==="high"){if(f>m){l=!1;break}}else if(f<m){l=!1;break}}c[t]=l?m:NaN}return c}const _n="time function args must be integers",Mn="timestamp month out of range";function Xe(n){return Number.isFinite(n)?(new Date(n).getUTCDay()+6)%7+1:NaN}function Ze(n,e){if(!Number.isFinite(n))return NaN;const s=new Date(n);switch(e){case"year":return s.getUTCFullYear();case"month":return s.getUTCMonth()+1;case"hour":return s.getUTCHours();case"minute":return s.getUTCMinutes();default:return s.getUTCSeconds()}}function oe(n){if(!Number.isFinite(n)||!Number.isInteger(n))throw new b(_n)}function $n(n){for(let e=0;e<n.length;e++){const s=n[e];if(Number.isFinite(s)&&!Number.isInteger(s))throw new b(_n)}}function An(n,e,s,i,a,c){if(oe(n),oe(e),oe(s),oe(i),oe(a),oe(c),e<1||e>12)throw new b(Mn);return Date.UTC(n,e-1,s,i,a,c)}function Sn(n){var i,a;const e=(i=n.scalars)==null?void 0:i.__bardurationms;if(Number.isFinite(e)&&e>0)return e;const s=(a=n.series)==null?void 0:a.time;if(s&&s.length>1)for(let c=s.length-1;c>0;c--){const t=s[c],h=s[c-1];if(!Number.isFinite(t)||!Number.isFinite(h))continue;const m=t-h;if(Number.isFinite(m)&&m>0)return m}return 0}function En(n){var s;const e=(s=n.scalars)==null?void 0:s.__nowms;return Number.isFinite(e)?e:Date.now()}const Le="session.isin session must be in HHMM-HHMM",Je="session.isin time must be a number",In=new Map;function Ln(n){const e=String(n||"").trim(),s=In.get(e);if(s)return s;const i=e.match(/^(\d{2})(\d{2})-(\d{2})(\d{2})$/);if(!i)throw new b(Le);const a=Number(i[1]),c=Number(i[2]),t=Number(i[3]),h=Number(i[4]);if(![a,c,t,h].every(Number.isFinite)||a<0||a>23||t<0||t>23||c<0||c>59||h<0||h>59)throw new b(Le);const m=a*60+c,d=t*60+h,r={start:m,end:d};return In.set(e,r),r}function Qe(n){const e=new Date(n);return e.getUTCHours()*60+e.getUTCMinutes()}function xe(n,e,s){return e<=s?n>=e&&n<=s:n>=e||n<=s}function $(n,e){if(n.kind==="series")return n.value;const s=new Float32Array(e.length);return s.fill(n.value),s}function I(n){if(n.kind==="scalar")return n.value;const e=n.value;return e.length?e[e.length-1]:NaN}function $e(n,e){const s=n.length,i=new Float32Array(s);for(let a=0;a<s;a++)i[a]=e(n[a]);return i}function Ce(n,e,s){const i=n.length,a=new Float32Array(i);for(let c=0;c<i;c++)a[c]=s(n[c],e[c]);return a}const zt="unsafe division: divisor is 0/na",ae="math domain error: sqrt/log/pow/asin/acos",Cn="ternary branches must both be numeric or both non-numeric",Ae="history index must be integer >= 0",Rn="array index must be integer >= 0",Vt="array index must be an integer",Gt="Negative array index not allowed",Kt="array.set index must be within array size",Un="array.push value must be a string",Wt="condition is na; treated as false",Re="condition must be bool or number",Ht="math.mod divisor is 0/na",Yt="math.fmod divisor is 0/na",Xt="atr length must be integer >= 1",Pn="williamsr length must be integer >= 1",qn="aroon length must be integer >= 1",jn="dmi length must be integer >= 1",Dn="dmi smoothing must be integer >= 1",On="adx length must be integer >= 1",Tn="plus_di length must be integer >= 1",Bn="minus_di length must be integer >= 1",zn="dx length must be integer >= 1",Vn="aroonosc length must be integer >= 1",Gn="highest length must be integer >= 1",Kn="lowest length must be integer >= 1",Wn="sum length must be integer >= 1",Hn="rising length must be integer >= 1",Yn="falling length must be integer >= 1",Ue="valuewhen occurrence must be integer >= 0",Zt=new Set(["syminfo","strategy","barstate","timeframe"]),Se=n=>{const e=[];let s=n;for(;s.kind==="MemberExpression";)e.unshift(s.property.name),s=s.object;if(s.kind!=="Identifier")return null;const i=s.name.toLowerCase();return Zt.has(i)?[i,...e].join("_"):null},le=n=>Number.isFinite(n)?n===0?0:1:NaN,en=n=>{const e=le(n);return Number.isFinite(e)?e===0?1:0:NaN},we=(n,e)=>{const s=le(n);if(s===0)return 0;const i=le(e);return s===1?i:i===0?0:Number.isFinite(i)?NaN:NaN},Ne=(n,e)=>{const s=le(n);if(s===1)return 1;const i=le(e);return s===0?i:i===1?1:Number.isFinite(i)?NaN:NaN},ue=(n,e,s)=>Number.isFinite(n)?n!==0:(e&&s&&e.emitOnce(s,Wt),!1),nn=(n,e,s)=>ue(n,e==null?void 0:e.diagnostics,s),q=(n,e,s)=>{var i;(i=n==null?void 0:n.diagnostics)==null||i.emitOnce(e,s)},Jt=n=>Number.isFinite(n)&&Math.floor(n)===n,tn=n=>n===">"||n==="<"||n===">="||n==="<="||n==="=="||n==="!=",be=(n,e,s,i)=>s?Number.isFinite(n)?!Number.isFinite(e)||e===0?(q(i,"div_zero",zt),NaN):n/e:NaN:e===0?NaN:n/e,Xn=(n,e,s,i)=>s&&(!Number.isFinite(n)||!Number.isFinite(e)||e===0)?(q(i,"fmod_div_zero",Yt),NaN):n%e,Zn=(n,e,s,i)=>s&&(!Number.isFinite(n)||!Number.isFinite(e)||e===0)?(q(i,"mod_div_zero",Ht),NaN):(n%e+e)%e,sn=(n,e,s,i)=>{if(!s)return Math.pow(n,e);if(!Number.isFinite(n)||!Number.isFinite(e))return q(i,"math_domain",ae),NaN;if(n<0&&!Jt(e))return q(i,"math_domain",ae),NaN;const a=Math.pow(n,e);return Number.isFinite(a)?a:(q(i,"math_domain",ae),NaN)},Jn=(n,e,s)=>e&&(!Number.isFinite(n)||n<0)?(q(s,"math_domain",ae),NaN):Math.sqrt(n),Qn=(n,e,s)=>{if(!e)return Math.log(n);if(!Number.isFinite(n)||n<=0)return q(s,"math_domain",ae),NaN;const i=Math.log(n);return Number.isFinite(i)?i:NaN},xn=(n,e,s)=>{if(!e)return Math.log10(n);if(!Number.isFinite(n)||n<=0)return q(s,"math_domain",ae),NaN;const i=Math.log10(n);return Number.isFinite(i)?i:NaN},et=(n,e,s)=>e&&(!Number.isFinite(n)||n<-1||n>1)?(q(s,"math_domain",ae),NaN):Math.asin(n),nt=(n,e,s)=>e&&(!Number.isFinite(n)||n<-1||n>1)?(q(s,"math_domain",ae),NaN):Math.acos(n),tt=(n,e)=>{if(!e)return Math.tan(n);if(!Number.isFinite(n))return NaN;const s=Math.tan(n);return Number.isFinite(s)?s:NaN},st=(n,e)=>{if(!e)return Math.exp(n);if(!Number.isFinite(n))return NaN;const s=Math.exp(n);return Number.isFinite(s)?s:NaN},ce=(n,e,s,i)=>!Number.isFinite(n)||!Number.isInteger(n)||n<0?(q(i,e,s),NaN):n,Pe=(n,e,s)=>!Number.isFinite(n)||!Number.isInteger(n)?(q(s,`${e}:int`,Vt),NaN):n<0?(q(s,`${e}:neg`,Gt),NaN):n,rn=(n,e,s,i)=>{const a=Pe(n,s,i);return!Number.isFinite(a)||!Number.isFinite(e)?0:a>=e?(q(i,`${s}:oob`,Kt),0):1},B=(n,e,s,i)=>!Number.isFinite(n)||!Number.isInteger(n)||n<1?(q(i,e,s),NaN):n,H=n=>{const e=new Float32Array(n);return e.fill(NaN),e},Qt=new Set(["tostring","format","upper","lower","trim","replace","replace_all","contains","startswith","endswith","length","substring","repeat"]),xt=new Set(["tostring","format","upper","lower","trim","replace","replace_all","substring","repeat"]),it=new WeakMap,j=n=>{const e=it.get(n);if(e)return e;let s="";switch(n.kind){case"NumberLiteral":s=`n:${n.value}`;break;case"StringLiteral":s=`s:${n.value}`;break;case"Identifier":s=`id:${n.name}`;break;case"UnaryExpression":s=`u:${n.operator}:${j(n.expr)}`;break;case"BinaryExpression":s=`b:${n.operator}:${j(n.left)}:${j(n.right)}`;break;case"CallExpression":s=`c:${n.callee}:${n.args.map(j).join(",")}`;break;case"MemberExpression":s=`m:${j(n.object)}:${n.property.name}`;break;case"IndexExpression":s=`i:${j(n.object)}:${j(n.index)}`;break;default:s="expr"}return it.set(n,s),s},ne=n=>{switch(n.kind){case"Identifier":return n.name;case"NumberLiteral":return Number.isFinite(n.value)?String(n.value):"na";case"StringLiteral":return JSON.stringify(n.value);case"MemberExpression":return`${ne(n.object)}.${n.property.name}`;case"IndexExpression":return`${ne(n.object)}[${ne(n.index)}]`;case"CallExpression":return`${n.callee}(${n.args.map(ne).join(", ")})`;case"UnaryExpression":return`${n.operator} ${ne(n.expr)}`;case"BinaryExpression":return`${ne(n.left)} ${n.operator} ${ne(n.right)}`;default:return"expr"}},rt=(n,e)=>{q(n,`member:${j(e)}`,`Unsupported member access: ${ne(e)}`)},ot=(n,e)=>{q(n,`index:${j(e)}`,`Unsupported indexing: ${ne(e)}`)},at=new WeakMap,te=n=>{const e=at.get(n);if(e!=null)return e;let s=!1;switch(n.kind){case"StringLiteral":s=!0;break;case"CallExpression":{const i=n.callee.toLowerCase();if(xt.has(i)){s=!0;break}(i==="iff"||i==="iif"||i==="if")&&n.args.length===3&&(s=te(n.args[1])||te(n.args[2]));break}default:s=!1}return at.set(n,s),s},fe=(n,e,s)=>`cond:${e!=null&&e.selfKey?e.selfKey:"cond"}:${j(n)}:${s}`,es=(n,e)=>{let s=!1;const i=a=>{if(!s)switch(a.kind){case"Identifier":{const c=a.name.replace(/\s+/g,"_").toLowerCase();e.series[c]&&(s=!0);return}case"MemberExpression":{const c=Se(a);if(c){const t=c.replace(/\s+/g,"_").toLowerCase();e.series[t]&&(s=!0);return}i(a.object);return}case"IndexExpression":i(a.object),i(a.index);return;case"UnaryExpression":i(a.expr);return;case"BinaryExpression":i(a.left),i(a.right);return;case"CallExpression":a.args.forEach(c=>i(c));return;default:return}};return i(n),s},pe=n=>{switch(n.kind){case"StringLiteral":return"nonNumeric";case"NumberLiteral":return"numeric";case"Identifier":{const e=n.name.replace(/\s+/g,"_").toLowerCase();return e==="true"||e==="false"?"nonNumeric":"numeric"}case"MemberExpression":{const e=Se(n);if(e){const s=e.replace(/\s+/g,"_").toLowerCase();if(s==="true"||s==="false")return"nonNumeric"}return"numeric"}case"IndexExpression":return"numeric";case"UnaryExpression":return n.operator==="not"?"nonNumeric":"numeric";case"BinaryExpression":return tn(n.operator)||n.operator==="and"||n.operator==="or"?"nonNumeric":"numeric";case"CallExpression":{const e=n.callee.toLowerCase();if((e==="iff"||e==="iif"||e==="if")&&n.args.length===3){const s=pe(n.args[1]),i=pe(n.args[2]);return s===i?s:"numeric"}return Qt.has(e)?"nonNumeric":"numeric"}default:return"numeric"}};function lt(n,e,s,i){var f;const a=e.kind==="series",c=s.kind==="series",t=((f=i.scalars)==null?void 0:f.__pinev2)===1,h=t&&tn(n),m=o=>Number.isFinite(o)&&o!==0;if(!a&&!c){const o=e.value,g=s.value;if(h&&(!Number.isFinite(o)||!Number.isFinite(g)))return{kind:"scalar",value:NaN};switch(n){case"+":return{kind:"scalar",value:o+g};case"-":return{kind:"scalar",value:o-g};case"*":return{kind:"scalar",value:o*g};case"/":return{kind:"scalar",value:be(o,g,t,i)};case"%":return{kind:"scalar",value:g===0?NaN:o%g};case">":return{kind:"scalar",value:Number.isFinite(o)&&Number.isFinite(g)&&o>g?1:0};case"<":return{kind:"scalar",value:Number.isFinite(o)&&Number.isFinite(g)&&o<g?1:0};case">=":return{kind:"scalar",value:Number.isFinite(o)&&Number.isFinite(g)&&o>=g?1:0};case"<=":return{kind:"scalar",value:Number.isFinite(o)&&Number.isFinite(g)&&o<=g?1:0};case"==":return{kind:"scalar",value:Number.isFinite(o)&&Number.isFinite(g)&&Math.abs(o-g)<1e-9?1:0};case"!=":return{kind:"scalar",value:Number.isFinite(o)&&Number.isFinite(g)&&Math.abs(o-g)>=1e-9?1:0};case"and":return{kind:"scalar",value:t?we(o,g):m(o)&&m(g)?1:0};case"or":return{kind:"scalar",value:t?Ne(o,g):m(o)||m(g)?1:0}}}const d=$(e,i),r=$(s,i),l=i.length,u=new Float32Array(l);for(let o=0;o<l;o++){const g=d[o],w=r[o];if(h&&(!Number.isFinite(g)||!Number.isFinite(w))){u[o]=NaN;continue}switch(n){case"+":u[o]=g+w;break;case"-":u[o]=g-w;break;case"*":u[o]=g*w;break;case"/":u[o]=be(g,w,t,i);break;case"%":u[o]=w===0?NaN:g%w;break;case">":u[o]=Number.isFinite(g)&&Number.isFinite(w)&&g>w?1:0;break;case"<":u[o]=Number.isFinite(g)&&Number.isFinite(w)&&g<w?1:0;break;case">=":u[o]=Number.isFinite(g)&&Number.isFinite(w)&&g>=w?1:0;break;case"<=":u[o]=Number.isFinite(g)&&Number.isFinite(w)&&g<=w?1:0;break;case"==":u[o]=Number.isFinite(g)&&Number.isFinite(w)&&Math.abs(g-w)<1e-9?1:0;break;case"!=":u[o]=Number.isFinite(g)&&Number.isFinite(w)&&Math.abs(g-w)>=1e-9?1:0;break;case"and":u[o]=t?we(g,w):m(g)&&m(w)?1:0;break;case"or":u[o]=t?Ne(g,w):m(g)||m(w)?1:0;break}}return{kind:"series",value:u}}function ns(n,e){var d;if(!(((d=e.scalars)==null?void 0:d.__pinev2)===1)||n.operator!=="and"&&n.operator!=="or")return lt(n.operator,se(n.left,e),se(n.right,e),e);const i=se(n.left,e),a=n.operator;if(i.kind==="scalar"){const r=le(i.value);if(a==="and"&&r===0)return{kind:"scalar",value:0};if(a==="or"&&r===1)return{kind:"scalar",value:1};const l=se(n.right,e);if(l.kind==="scalar")return{kind:"scalar",value:a==="and"?we(r,l.value):Ne(r,l.value)};const u=$(l,e),f=new Float32Array(u.length);for(let o=0;o<u.length;o++){const g=u[o];f[o]=a==="and"?we(r,g):Ne(r,g)}return{kind:"series",value:f}}const c=$(i,e),t=c.length,h=new Float32Array(t),m={series:e.series,scalars:e.scalars,strings:e.strings,draw:e.draw,diagnostics:e.diagnostics,strategy:e.strategy,loopRuntime:e.loopRuntime,funcRuntime:e.funcRuntime,length:t,index:0};for(let r=0;r<t;r++){const l=c[r],u=le(l);if(a==="and"&&u===0){h[r]=0;continue}if(a==="or"&&u===1){h[r]=1;continue}m.index=r;const f=R(n.right,m);h[r]=a==="and"?we(l,f):Ne(l,f)}return{kind:"series",value:h}}function K(n,e){const s=n.length,i=new Float32Array(s);let a=0,c=0;for(let t=0;t<s;t++){const h=n[t];if(Number.isFinite(h)&&(a+=h,c+=1),t>=e){const m=n[t-e];Number.isFinite(m)&&(a-=m,c-=1)}t>=e-1?i[t]=c>0?a/c:NaN:i[t]=NaN}return i}function z(n,e){const s=n.length,i=new Float32Array(s),a=2/(e+1);let c;for(let t=0;t<s;t++){const h=n[t];if(!Number.isFinite(h)){i[t]=c===void 0?NaN:c;continue}if(c===void 0||!Number.isFinite(c)){c=h,i[t]=h;continue}c=h*a+c*(1-a),i[t]=c}return i}function on(n,e,s){const i=n.length,a=new Float32Array(i);let c=NaN;for(let t=0;t<i;t++){const h=n[t],m=e[t],d=s[t];let r=Math.max(0,h-m);Number.isFinite(c)&&(r=Math.max(r,Math.abs(h-c),Math.abs(m-c))),a[t]=r,c=d}return a}function ke(n,e){const s=n.length,i=new Float32Array(s);let a,c=0,t=0;for(let h=0;h<s;h++){const m=n[h];if(a===void 0){if(Number.isFinite(m)&&(c+=m,t+=1),t<e){i[h]=NaN;continue}a=c/e,i[h]=a;continue}Number.isFinite(m)&&(a=(a*(e-1)+m)/e),i[h]=a}return i}function ut(n,e){const s=n.length,i=new Float32Array(s);let a,c=0,t=0,h=!1;const m=[],d=[];for(let r=0;r<s;r++){const l=n[r];if(!Number.isFinite(l)){i[r]=NaN;continue}if(a===void 0){a=l,i[r]=NaN;continue}if(!Number.isFinite(a)){a=l,i[r]=NaN;continue}const u=l-a;a=l;const f=u>0?u:0,o=u<0?-u:0;if(h)c=(c*(e-1)+f)/e,t=(t*(e-1)+o)/e;else{m.push(f),d.push(o);const g=m.length,w=Math.max(1,Math.min(e,g));c=m.reduce((k,F)=>k+F,0)/w,t=d.reduce((k,F)=>k+F,0)/w,g>=e&&(h=!0)}if(t===0)i[r]=100;else{const g=c/t;i[r]=100-100/(1+g)}}return i}function an(n,e){const s=n.length,i=new Float32Array(s);for(let a=0;a<s;a++){if(a<e-1){i[a]=NaN;continue}let c=0,t=0;for(let d=a-e+1;d<=a;d++){const r=n[d];Number.isFinite(r)&&(c+=r,t+=1)}if(t<2){i[a]=NaN;continue}const h=c/t;let m=0;for(let d=a-e+1;d<=a;d++){const r=n[d];if(!Number.isFinite(r))continue;const l=r-h;m+=l*l}i[a]=Math.sqrt(m/t)}return i}function qe(n,e){const s=n.length,i=new Float32Array(s);for(let a=0;a<s;a++){if(a<e-1){i[a]=NaN;continue}let c=0,t=0;for(let h=0;h<e;h++){const m=n[a-h],d=e-h;Number.isFinite(m)&&(c+=m*d,t+=d)}i[a]=t>0?c/t:NaN}return i}function ts(n,e){const s=z(n,e),i=z(s,e),a=n.length,c=new Float32Array(a);for(let t=0;t<a;t++){const h=s[t],m=i[t];c[t]=Number.isFinite(h)&&Number.isFinite(m)?2*h-m:NaN}return c}function ss(n,e){const s=z(n,e),i=z(s,e),a=z(i,e),c=n.length,t=new Float32Array(c);for(let h=0;h<c;h++){const m=s[h],d=i[h],r=a[h];t[h]=Number.isFinite(m)&&Number.isFinite(d)&&Number.isFinite(r)?3*m-3*d+r:NaN}return t}function is(n,e){const s=Math.ceil((e+1)/2),i=Math.floor((e+1)/2);return K(K(n,s),i)}function rs(n,e){const s=n.length,i=new Float32Array(s);for(let a=0;a<s;a++){if(a<e-1){i[a]=NaN;continue}let c=0,t=0;for(let h=0;h<e;h++){const m=n[a-h];if(!Number.isFinite(m))continue;const d=Math.min(h+1,e-h);c+=m*d,t+=d}i[a]=t>0?c/t:NaN}return i}function os(n,e){const s=Math.max(1,Math.floor(e/2)),i=Math.max(1,Math.round(Math.sqrt(e))),a=qe(n,s),c=qe(n,e),t=n.length,h=new Float32Array(t);for(let m=0;m<t;m++){const d=a[m],r=c[m];h[m]=Number.isFinite(d)&&Number.isFinite(r)?2*d-r:NaN}return qe(h,i)}function as(n,e,s,i){const a=n.length,c=new Float32Array(a),t=2/(s+1),h=2/(i+1);let m=NaN;for(let d=0;d<a;d++){const r=n[d];if(!Number.isFinite(r)||d<e){c[d]=NaN;continue}const l=n[d-e];if(!Number.isFinite(l)){c[d]=NaN;continue}let u=0,f=!0;for(let k=d-e+1;k<=d;k++){const F=n[k],M=n[k-1];if(!Number.isFinite(F)||!Number.isFinite(M)){f=!1;break}u+=Math.abs(F-M)}if(!f||u===0){c[d]=NaN;continue}const g=Math.abs(r-l)/u,w=Math.pow(g*(t-h)+h,2);Number.isFinite(m)||(m=r),m=m+w*(r-m),c[d]=m}return c}function ls(n,e,s,i){const a=n.length,c=new Float32Array(a),t=s*(e-1),h=e/i,m=[];for(let d=0;d<e;d++){const r=Math.exp(-((d-t)*(d-t))/(2*h*h));m.push(r)}for(let d=0;d<a;d++){if(d<e-1){c[d]=NaN;continue}let r=0,l=0;for(let u=0;u<e;u++){const f=n[d-e+1+u];if(!Number.isFinite(f))continue;const o=m[u];r+=f*o,l+=o}c[d]=l>0?r/l:NaN}return c}function us(n,e,s){const i=z(n,e),a=z(i,e),c=z(a,e),t=z(c,e),h=z(t,e),m=z(h,e),d=s,r=d*d,l=r*d,u=-l,f=3*r+3*l,o=-6*r-3*d-3*l,g=1+3*d+l+3*r,w=n.length,k=new Float32Array(w);for(let F=0;F<w;F++){const M=c[F],N=h[F],p=m[F],v=t[F];k[F]=Number.isFinite(M)&&Number.isFinite(v)&&Number.isFinite(N)&&Number.isFinite(p)?u*p+f*N+o*v+g*M:NaN}return k}function ln(n,e,s,i){const a=on(n,e,s),c=a.length,t=new Float32Array(c);let h=0;for(let m=0;m<c;m++)h+=a[m],m===i-1?t[m]=h/i:m>=i?t[m]=(t[m-1]*(i-1)+a[m])/i:t[m]=NaN;return t}function cs(n,e,s,i){const a=ln(n,e,s,i),c=a.length,t=new Float32Array(c);for(let h=0;h<c;h++){const m=a[h],d=s[h];t[h]=Number.isFinite(m)&&Number.isFinite(d)&&d!==0?m/d*100:NaN}return t}function fs(n,e){const s=n.length,i=new Float32Array(s),a=[],c=[];for(let t=0;t<s;t++){const h=n[t],m=t>0?n[t-1]:NaN;if(!Number.isFinite(h)||!Number.isFinite(m))a.push(0),c.push(0);else{const u=h-m;a.push(u>0?u:0),c.push(u<0?-u:0)}if(t<e){i[t]=NaN;continue}let d=0,r=0;for(let u=t-e+1;u<=t;u++)d+=a[u],r+=c[u];const l=d+r;i[t]=l===0?NaN:100*(d-r)/l}return i}function hs(n,e,s){const i=n.length,a=new Float32Array(i);for(let l=0;l<i;l++){const u=n[l],f=l>0?n[l-1]:NaN;a[l]=Number.isFinite(u)&&Number.isFinite(f)?u-f:NaN}const c=z(a,e),t=z(c,s),h=new Float32Array(i);for(let l=0;l<i;l++)h[l]=Math.abs(a[l]);const m=z(h,e),d=z(m,s),r=new Float32Array(i);for(let l=0;l<i;l++){const u=t[l],f=d[l];r[l]=Number.isFinite(u)&&Number.isFinite(f)&&f!==0?100*u/f:NaN}return r}function ms(n,e,s,i){const a=ut(n,e),c=Fe(a,e),t=ve(a,e),h=n.length,m=new Float32Array(h);for(let r=0;r<h;r++){const l=a[r],u=c[r],f=t[r],o=u-f;m[r]=Number.isFinite(l)&&Number.isFinite(o)&&o!==0?(l-f)/o*100:NaN}let d=m;return s&&s>1&&(d=K(d,s)),i&&i>1&&(d=K(d,i)),d}function ds(n,e,s){const i=z(n,e),a=z(n,s),c=n.length,t=new Float32Array(c);for(let h=0;h<c;h++){const m=i[h],d=a[h];t[h]=Number.isFinite(m)&&Number.isFinite(d)&&d!==0?(m-d)/d*100:NaN}return t}function gs(n,e){const s=n.length,i=new Float32Array(s);for(let h=0;h<s;h++)i[h]=(n[h]+e[h])/2;const a=K(i,5),c=K(i,34),t=new Float32Array(s);for(let h=0;h<s;h++){const m=a[h],d=c[h];t[h]=Number.isFinite(m)&&Number.isFinite(d)?m-d:NaN}return t}function ws(n,e){const s=z(n,e),i=z(s,e),a=z(i,e),c=n.length,t=new Float32Array(c);t[0]=NaN;for(let h=1;h<c;h++){const m=a[h-1],d=a[h];t[h]=Number.isFinite(m)&&Number.isFinite(d)&&m!==0?(d/m-1)*100:NaN}return t}function Ns(n,e){const s=K(n,e),i=an(n,e),a=n.length,c=new Float32Array(a);for(let t=0;t<a;t++){const h=s[t],m=i[t],d=n[t];c[t]=Number.isFinite(d)&&Number.isFinite(h)&&Number.isFinite(m)&&m!==0?(d-h)/m:NaN}return c}function bs(n,e,s,i){const a=s.length,c=new Float32Array(a);let t=0;for(let h=0;h<a;h++){const m=n[h],d=e[h],r=s[h],l=i[h];if(!Number.isFinite(m)||!Number.isFinite(d)||!Number.isFinite(r)){c[h]=NaN;continue}const u=m-d,f=Number.isFinite(u)&&u!==0?(2*r-m-d)/u:0;Number.isFinite(l)&&(t+=f*l),c[h]=t}return c}function ps(n,e,s,i,a){const c=s.length,t=new Float32Array(c);for(let r=0;r<c;r++){const l=n[r],u=e[r],f=s[r],o=i[r];if(!Number.isFinite(l)||!Number.isFinite(u)||!Number.isFinite(f)){t[r]=NaN;continue}const g=l-u,w=Number.isFinite(g)&&g!==0?(2*f-l-u)/g:0;t[r]=Number.isFinite(o)?w*o:NaN}const h=W(t,a),m=W(i,a),d=new Float32Array(c);for(let r=0;r<c;r++){const l=h[r],u=m[r];d[r]=Number.isFinite(l)&&Number.isFinite(u)&&u!==0?l/u:NaN}return d}function ks(n,e,s,i,a){const c=s.length,t=ln(n,e,s,i),h=new Float32Array(c),m=new Float32Array(c);let d=NaN,r=NaN,l=!0;for(let u=0;u<c;u++){const f=n[u],o=e[u],g=s[u],w=t[u];if(!Number.isFinite(f)||!Number.isFinite(o)||!Number.isFinite(w)){h[u]=NaN,m[u]=NaN;continue}const k=(f+o)/2,F=k+a*w,M=k-a*w;if(d=Number.isFinite(d)?Math.min(F,d):F,r=Number.isFinite(r)?Math.max(M,r):M,!Number.isFinite(g)){h[u]=NaN,m[u]=NaN;continue}l?g<r?(l=!1,d=F,h[u]=d,m[u]=-1):(h[u]=r,m[u]=1):g>d?(l=!0,r=M,h[u]=r,m[u]=1):(h[u]=d,m[u]=-1)}return{line:h,dir:m}}function Fs(n,e,s,i,a){const c=z(s,i),t=ln(n,e,s,i),h=s.length,m=new Float32Array(h),d=new Float32Array(h);for(let r=0;r<h;r++){const l=c[r],u=t[r];m[r]=Number.isFinite(l)&&Number.isFinite(u)?l+a*u:NaN,d[r]=Number.isFinite(l)&&Number.isFinite(u)?l-a*u:NaN}return{mid:c,upper:m,lower:d}}function vs(n,e,s){const i=Fe(n,s),a=ve(e,s),c=n.length,t=new Float32Array(c);for(let h=0;h<c;h++){const m=i[h],d=a[h];t[h]=Number.isFinite(m)&&Number.isFinite(d)?(m+d)/2:NaN}return{upper:i,lower:a,mid:t}}function ys(n,e,s,i,a){const c=n.length,t=new Float32Array(c);if(!c)return t;let h=!0;c>1&&Number.isFinite(n[1])&&Number.isFinite(n[0])&&(h=n[1]>=n[0]);let m=s,d=h?n[0]:e[0],r=h?e[0]:n[0];t[0]=r;for(let l=1;l<c;l++){const u=n[l],f=e[l];if(!Number.isFinite(u)||!Number.isFinite(f)){t[l]=NaN;continue}if(r=r+m*(d-r),h){const o=e[l-1],g=l>1?e[l-2]:o;Number.isFinite(o)&&(r=Math.min(r,o)),Number.isFinite(g)&&(r=Math.min(r,g)),f<r?(h=!1,r=d,d=f,m=s):u>d&&(d=u,m=Math.min(m+i,a))}else{const o=n[l-1],g=l>1?n[l-2]:o;Number.isFinite(o)&&(r=Math.max(r,o)),Number.isFinite(g)&&(r=Math.max(r,g)),u>r?(h=!0,r=d,d=u,m=s):f<d&&(d=f,m=Math.min(m+i,a))}t[l]=r}return t}function _s(n,e){const s=n.length,i=new Float32Array(s);for(let a=0;a<s;a++){if(a<e-1){i[a]=NaN;continue}let c=0,t=0,h=!0;for(let m=0;m<e;m++){const d=n[a-m];if(!Number.isFinite(d)){h=!1;break}const r=m+1;c+=d,t+=d*r}if(!h||c===0){i[a]=NaN;continue}i[a]=-(t/c)+(e+1)/2}return i}function Ms(n,e,s,i,a,c){const t=Fe(n,i),h=ve(e,i),m=s.length,d=new Float32Array(m);for(let f=0;f<m;f++){const o=s[f],g=t[f],w=h[f],k=g-w;d[f]=Number.isFinite(o)&&Number.isFinite(g)&&Number.isFinite(w)&&k!==0?(o-w)/k*100:NaN}const r=K(d,a),l=K(r,c),u=new Float32Array(m);for(let f=0;f<m;f++){const o=r[f],g=l[f];u[f]=Number.isFinite(o)&&Number.isFinite(g)?3*o-2*g:NaN}return{k:r,d:l,j:u}}function $s(n,e,s,i,a,c,t,h,m,d){const r=Me(n,e),l=Me(n,s),u=Me(n,i),f=Me(n,a),o=K(r,c),g=K(l,t),w=K(u,h),k=K(f,m),F=n.length,M=new Float32Array(F);for(let p=0;p<F;p++){const v=o[p],y=g[p],_=w[p],S=k[p];M[p]=Number.isFinite(v)&&Number.isFinite(y)&&Number.isFinite(_)&&Number.isFinite(S)?v+2*y+3*_+4*S:NaN}const N=K(M,d);return{kst:M,signal:N}}function As(n,e,s,i,a,c){const t=s.length,h=new Float32Array(t),m=new Float32Array(t);let d=NaN;for(let k=0;k<t;k++){const F=n[k],M=e[k],N=s[k];if(!Number.isFinite(F)||!Number.isFinite(M)||!Number.isFinite(N)){h[k]=NaN,m[k]=NaN,d=N;continue}const p=Math.min(M,Number.isFinite(d)?d:M),v=Math.max(F,Number.isFinite(d)?d:F);h[k]=N-p,m[k]=v-p,d=N}const r=W(h,i),l=W(h,a),u=W(h,c),f=W(m,i),o=W(m,a),g=W(m,c),w=new Float32Array(t);for(let k=0;k<t;k++){const F=r[k],M=l[k],N=u[k],p=f[k],v=o[k],y=g[k];if(!Number.isFinite(F)||!Number.isFinite(M)||!Number.isFinite(N)||!Number.isFinite(p)||!Number.isFinite(v)||!Number.isFinite(y)||p===0||v===0||y===0){w[k]=NaN;continue}const _=F/p,S=M/v,C=N/y;w[k]=100*(4*_+2*S+C)/7}return w}function Ss(n,e,s){const i=K(n,e),a=an(n,e),c=n.length,t=new Float32Array(c);for(let h=0;h<c;h++){const m=i[h],d=a[h];t[h]=Number.isFinite(m)&&Number.isFinite(d)&&m!==0?2*s*d/m:NaN}return t}function Es(n,e,s){const i=n.length,a=new Float32Array(i);let c=s;a[0]=c;for(let t=1;t<i;t++){const h=n[t],m=n[t-1],d=e[t],r=e[t-1];if(!Number.isFinite(h)||!Number.isFinite(m)||!Number.isFinite(d)||!Number.isFinite(r)||m===0){a[t]=c;continue}d>r&&(c=c+(h-m)/m*c),a[t]=c}return a}function Is(n,e,s){const i=n.length,a=new Float32Array(i);let c=s;a[0]=c;for(let t=1;t<i;t++){const h=n[t],m=n[t-1],d=e[t],r=e[t-1];if(!Number.isFinite(h)||!Number.isFinite(m)||!Number.isFinite(d)||!Number.isFinite(r)||m===0){a[t]=c;continue}d<r&&(c=c+(h-m)/m*c),a[t]=c}return a}function Ls(n,e,s,i){const a=s.length,c=new Float32Array(a),t=new Float32Array(a);for(let f=0;f<a;f++){if(f===0){c[f]=NaN,t[f]=NaN;continue}const o=n[f],g=e[f],w=n[f-1],k=e[f-1];c[f]=Number.isFinite(o)&&Number.isFinite(k)?Math.abs(o-k):NaN,t[f]=Number.isFinite(g)&&Number.isFinite(w)?Math.abs(g-w):NaN}const h=on(n,e,s),m=W(c,i),d=W(t,i),r=W(h,i),l=new Float32Array(a),u=new Float32Array(a);for(let f=0;f<a;f++){const o=m[f],g=d[f],w=r[f];l[f]=Number.isFinite(o)&&Number.isFinite(w)&&w!==0?o/w:NaN,u[f]=Number.isFinite(g)&&Number.isFinite(w)&&w!==0?g/w:NaN}return{plus:l,minus:u}}function Fe(n,e){const s=n.length,i=new Float32Array(s);for(let a=0;a<s;a++){let c=-1/0,t=!1;const h=Math.max(0,a-e+1);for(let m=h;m<=a;m++){const d=n[m];Number.isFinite(d)&&(t=!0,d>c&&(c=d))}i[a]=t?c:NaN}return i}function ve(n,e){const s=n.length,i=new Float32Array(s);for(let a=0;a<s;a++){let c=1/0,t=!1;const h=Math.max(0,a-e+1);for(let m=h;m<=a;m++){const d=n[m];Number.isFinite(d)&&(t=!0,d<c&&(c=d))}i[a]=t?c:NaN}return i}function ct(n,e){const s=n.length,i=new Float32Array(s);for(let a=0;a<s;a++){if(a<e-1){i[a]=NaN;continue}let c=-1/0,t=NaN;for(let h=0;h<e;h++){const m=a-h,d=n[m];Number.isFinite(d)&&d>c&&(c=d,t=h)}i[a]=Number.isFinite(t)?t:NaN}return i}function ft(n,e){const s=n.length,i=new Float32Array(s);for(let a=0;a<s;a++){if(a<e-1){i[a]=NaN;continue}let c=1/0,t=NaN;for(let h=0;h<e;h++){const m=a-h,d=n[m];Number.isFinite(d)&&d<c&&(c=d,t=h)}i[a]=Number.isFinite(t)?t:NaN}return i}function Cs(n,e){const s=n.length,i=new Float32Array(s);for(let a=0;a<s;a++){if(a<e-1){i[a]=NaN;continue}let c=0,t=0,h=0;const m=a-e+1;for(let l=m;l<=a;l++){const u=n[l];Number.isFinite(u)&&(c+=u,t+=u*u,h+=1)}if(h<2){i[a]=NaN;continue}const d=c/h,r=t/h-d*d;i[a]=Number.isFinite(r)?r:NaN}return i}function Rs(n,e,s){const i=n.length,a=new Float32Array(i);for(let c=0;c<i;c++){if(c<s-1){a[c]=NaN;continue}let t=0,h=0,m=0,d=0,r=0,l=0;const u=c-s+1;for(let M=u;M<=c;M++){const N=n[M],p=e[M];!Number.isFinite(N)||!Number.isFinite(p)||(t+=N,h+=p,m+=N*N,d+=p*p,r+=N*p,l+=1)}if(l<2){a[c]=NaN;continue}const f=t/l,o=h/l,g=r/l-f*o,w=m/l-f*f,k=d/l-o*o,F=Math.sqrt(w*k);a[c]=F>0?g/F:NaN}return a}function Us(n,e,s){const i=n.length,a=new Float32Array(i),c=Math.max(1,Math.floor(e)),t=Math.floor(s),h=(c-1)*c/2,m=(c-1)*c*(2*c-1)/6,d=c*m-h*h;for(let r=0;r<i;r++){if(r<c-1||d===0){a[r]=NaN;continue}let l=0,u=0,f=0;for(let k=0;k<c;k++){const F=r-(c-1-k),M=n[F];Number.isFinite(M)&&(l+=M,u+=M*k,f+=1)}if(f<2){a[r]=NaN;continue}const o=(c*u-h*l)/d,g=(l-o*h)/c,w=c-1+t;a[r]=g+o*w}return a}function ht(n,e){var d;const s=e.funcRuntime;if(s){const r=s.funcs.get(n.callee.toLowerCase());if(r){const l=e.length,u=new Float32Array(l),f={series:e.series,scalars:e.scalars,strings:e.strings,diagnostics:e.diagnostics,draw:e.draw,strategy:e.strategy,loopRuntime:e.loopRuntime,funcRuntime:e.funcRuntime,length:l,index:0};for(let o=0;o<l;o++)f.index=o,u[o]=wt(r,n,f);return{kind:"series",value:u}}}const i=((d=e.scalars)==null?void 0:d.__pinev2)===1,a=pt(n.callee.toLowerCase(),i),c=Nt(a);if(c){if(!e.draw)return{kind:"scalar",value:NaN};const r=n.args[0];let l="";if(r&&r.kind==="Identifier"&&(l=r.name),r&&r.kind==="StringLiteral"&&(l=r.value),!l)return{kind:"scalar",value:NaN};const u=e.length,f=new Float32Array(u);for(let o=0;o<u;o++){const g=e.draw.get(c.kind,c.prop,l,o);typeof g=="string"?f[o]=x(g):typeof g=="number"&&Number.isFinite(g)?f[o]=g:f[o]=NaN}return{kind:"series",value:f}}const t=n.args.map(r=>se(r,e)),h=bt(a);if(h){if(!e.strategy)return{kind:"scalar",value:NaN};if(!t.length)throw new b(`${n.callee} expects (index)`);const r=$(t[0],e),l=e.length,u=new Float32Array(l);for(let f=0;f<l;f++){const o=r[f],g=Number.isFinite(o)?Math.floor(o):NaN;if(!Number.isFinite(g)){u[f]=NaN;continue}u[f]=kt(e,h.kind,h.prop,f,g)}return{kind:"series",value:u}}const m=()=>{if(t.length!==2)throw new b(`${a} expects (series, period)`);const r=$(t[0],e),l=Math.max(1,Math.floor(I(t[1])));return[r,l]};switch(a){case"__hist_index":case"__arr_index":{if(t.length!==1)throw new b(`${n.callee} expects (index)`);const r=t[0];if(!i)return r;const l=a==="__hist_index"?"history_index":"array_index",u=a==="__hist_index"?Ae:Rn;if(r.kind==="scalar")return{kind:"scalar",value:ce(r.value,l,u,e)};const f=$(r,e),o=new Float32Array(e.length);for(let g=0;g<o.length;g++)o[g]=ce(f[g],l,u,e);return{kind:"series",value:o}}case"__arr_index_str":{if(t.length!==1)throw new b(`${n.callee} expects (index)`);const r=t[0];if(!i)return r;const l=`arr_idx_str:${j(n)}`;if(r.kind==="scalar")return{kind:"scalar",value:Pe(r.value,l,e)};const u=$(r,e),f=new Float32Array(e.length);for(let o=0;o<f.length;o++)f[o]=Pe(u[o],l,e);return{kind:"series",value:f}}case"__arr_set_guard":{if(t.length!==2)throw new b(`${n.callee} expects (index, size)`);if(!i)return{kind:"scalar",value:1};const r=t[0],l=t[1],u=`arr_set_guard:${j(n)}`;if(r.kind==="scalar"&&l.kind==="scalar")return{kind:"scalar",value:rn(r.value,l.value,u,e)};const f=$(r,e),o=$(l,e),g=new Float32Array(e.length);for(let w=0;w<g.length;w++)g[w]=rn(f[w],o[w],u,e);return{kind:"series",value:g}}case"__arr_str_valid":{if(t.length!==1)throw new b(`${n.callee} expects (value)`);if(!i)return{kind:"scalar",value:1};const r=te(n.args[0]);return r||q(e,`arr_str_val:${j(n)}`,Un),{kind:"scalar",value:r?1:0}}case"__str_num":{if(t.length!==1)throw new b(`${n.callee} expects (value)`);return t[0]}case"iff":case"iif":case"if":{if(t.length!==3)throw new b(`${n.callee} expects (cond, a, b)`);const r=t[0],l=t[1],u=t[2],f=n.args[0];if(i){const _=pe(n.args[1]),S=pe(n.args[2]);if(_!==S){if(q(e,"ternary_type",Cn),r.kind==="scalar"&&l.kind==="scalar"&&u.kind==="scalar")return{kind:"scalar",value:NaN};const C=new Float32Array(e.length);return C.fill(NaN),{kind:"series",value:C}}}const o=i&&te(f),g=i?fe(f,e,"na"):void 0;o&&q(e,fe(f,e,"type"),Re);const w=r.kind==="series",k=l.kind==="series",F=u.kind==="series";if(!w&&!k&&!F){const _=r.value;return o?{kind:"scalar",value:u.value}:{kind:"scalar",value:nn(_,e,g)?l.value:u.value}}const M=$(r,e),N=$(l,e),p=$(u,e),v=e.length,y=new Float32Array(v);for(let _=0;_<v;_++){if(o){y[_]=p[_];continue}const S=M[_],C=nn(S,e,g);y[_]=C?N[_]:p[_]}return{kind:"series",value:y}}case"nz":{if(t.length<1||t.length>2)throw new b("nz expects (series[, fallback])");const r=t[0],l=t[1]??{kind:"scalar",value:0};if(r.kind==="scalar"&&l.kind==="scalar")return{kind:"scalar",value:Number.isFinite(r.value)?r.value:l.value};const u=$(r,e),f=$(l,e),o=e.length,g=new Float32Array(o);for(let w=0;w<o;w++){const k=u[w];g[w]=Number.isFinite(k)?k:f[w]}return{kind:"series",value:g}}case"between":{if(t.length!==3)throw new b("between expects (x, a, b)");const r=$(t[0],e),l=$(t[1],e),u=$(t[2],e),f=e.length,o=new Float32Array(f);for(let g=0;g<f;g++){const w=r[g],k=l[g],F=u[g];if(!Number.isFinite(w)||!Number.isFinite(k)||!Number.isFinite(F)){o[g]=i?NaN:0;continue}const M=Math.min(k,F),N=Math.max(k,F);o[g]=w>=M&&w<=N?1:0}return{kind:"series",value:o}}case"above":case"below":{if(t.length<2||t.length>3)throw new b(`${a} expects (a, b[, tol])`);const r=$(t[0],e),l=$(t[1],e),u=t[2]?$(t[2],e):null,f=e.length,o=new Float32Array(f);for(let g=0;g<f;g++){const w=r[g],k=l[g],F=u?u[g]:0,M=Number.isFinite(F)?Math.max(0,F):0;if(!Number.isFinite(w)||!Number.isFinite(k)){o[g]=i?NaN:0;continue}o[g]=a==="above"?w>k+M?1:0:w<k-M?1:0}return{kind:"series",value:o}}case"higherhigh":{const r=t.length?Math.max(1,Math.floor(I(t[0]))):1,l=e.series.high;if(!l)throw new b("higherhigh requires high series");const u=e.length,f=new Float32Array(u);for(let o=0;o<u;o++){const g=l[o];if(!Number.isFinite(g)){f[o]=i?NaN:0;continue}const w=Math.max(0,o-r),k=bn(l,w,Math.max(0,o-1));f[o]=g>k?1:0}return{kind:"series",value:f}}case"lowerlow":{const r=t.length?Math.max(1,Math.floor(I(t[0]))):1,l=e.series.low;if(!l)throw new b("lowerlow requires low series");const u=e.length,f=new Float32Array(u);for(let o=0;o<u;o++){const g=l[o];if(!Number.isFinite(g)){f[o]=i?NaN:0;continue}const w=Math.max(0,o-r),k=pn(l,w,Math.max(0,o-1));f[o]=g<k?1:0}return{kind:"series",value:f}}case"swinghigh":{const r=t.length?Math.max(1,Math.floor(I(t[0]))):3,l=e.series.high;if(!l)throw new b("swinghigh requires high series");const u=e.length,f=new Float32Array(u);for(let o=0;o<u;o++){const g=l[o];if(!Number.isFinite(g)){f[o]=i?NaN:0;continue}let w=!0;for(let k=o-r;k<=o+r;k++){if(k===o||k<0||k>=u)continue;const F=l[k];if(Number.isFinite(F)&&F>=g){w=!1;break}}f[o]=w?1:0}return{kind:"series",value:f}}case"swinglow":{const r=t.length?Math.max(1,Math.floor(I(t[0]))):3,l=e.series.low;if(!l)throw new b("swinglow requires low series");const u=e.length,f=new Float32Array(u);for(let o=0;o<u;o++){const g=l[o];if(!Number.isFinite(g)){f[o]=i?NaN:0;continue}let w=!0;for(let k=o-r;k<=o+r;k++){if(k===o||k<0||k>=u)continue;const F=l[k];if(Number.isFinite(F)&&F<=g){w=!1;break}}f[o]=w?1:0}return{kind:"series",value:f}}case"volspike":{const r=t.length?Math.max(1,I(t[0])):1,l=e.series.volume;if(!l)throw new b("volspike requires volume series");const u=e.length,f=new Float32Array(u),o=20;for(let g=0;g<u;g++){const w=l[g];if(!Number.isFinite(w)){f[g]=i?NaN:0;continue}const k=Math.max(0,g-o+1);let F=0,M=0;for(let p=k;p<=g;p++){const v=l[p];Number.isFinite(v)&&(F+=v,M+=1)}const N=M?F/M:NaN;f[g]=Number.isFinite(N)&&w>r*N?1:0}return{kind:"series",value:f}}case"atrspike":{const r=t.length?Math.max(1,I(t[0])):1,l=e.series.high,u=e.series.low,f=e.series.close;if(!l||!u||!f)throw new b("atrspike requires high/low/close series");const o=e.length,g=new Float32Array(o),w=14,k=F=>{const M=l[F],N=u[F],p=F>0?f[F-1]:NaN;let v=Number.isFinite(M)&&Number.isFinite(N)?Math.max(0,M-N):NaN;return Number.isFinite(p)&&(v=Math.max(v,Math.abs(M-p),Math.abs(N-p))),v};for(let F=0;F<o;F++){let M=NaN,N=0;for(let _=0;_<=F;_++){const S=k(_);N+=Number.isFinite(S)?S:0,_===w-1?M=N/w:_>=w&&(M=(M*(w-1)+S)/w)}let p=NaN,v=0,y=0;for(let _=Math.max(0,F-w+1);_<=F;_++){const S=k(_);Number.isFinite(S)&&(v+=S,y+=1)}y&&(p=v/y),g[F]=Number.isFinite(M)&&Number.isFinite(p)&&M>r*p?1:0}return{kind:"series",value:g}}case"trend":{const r=n.args[0],l=r&&r.kind==="StringLiteral"?r.value:r&&r.kind==="Identifier"?r.name:"",u=String(l||"").toLowerCase()||"up",f=e.series.close;if(!f)throw new b("trend requires close series");const o=e.length,g=new Float32Array(o),w=10;for(let k=0;k<o;k++){const F=Math.max(0,k-w+1);let M=0,N=0,p=0,v=0,y=0;for(let C=F;C<=k;C++){const L=C-F,A=f[C];Number.isFinite(A)&&(M+=L,N+=A,p+=L*L,v+=L*A,y+=1)}const _=y*p-M*M,S=_===0||y===0?0:(y*v-M*N)/_;g[k]=u==="up"?S>0?1:0:S<0?1:0}return{kind:"series",value:g}}case"add":case"sub":case"mul":case"div":{if(t.length!==2)throw new b(`${a} expects 2 arguments`);const r=t[0],l=t[1];if(r.kind==="scalar"&&l.kind==="scalar"){const w=r.value,k=l.value;return a==="add"?{kind:"scalar",value:w+k}:a==="sub"?{kind:"scalar",value:w-k}:a==="mul"?{kind:"scalar",value:w*k}:{kind:"scalar",value:be(w,k,i,e)}}const u=$(r,e),f=$(l,e),o=e.length,g=new Float32Array(o);for(let w=0;w<o;w++){const k=u[w],F=f[w];a==="add"?g[w]=k+F:a==="sub"?g[w]=k-F:a==="mul"?g[w]=k*F:g[w]=be(k,F,i,e)}return{kind:"series",value:g}}case"mod":case"fmod":{if(!i)throw new b(`Unknown function "${n.callee}"`);if(t.length!==2)throw new b(`${n.callee} expects 2 arguments`);const r=t[0],l=t[1],u=a==="mod"?Zn:Xn;if(r.kind==="scalar"&&l.kind==="scalar")return{kind:"scalar",value:u(r.value,l.value,!0,e)};const f=$(r,e),o=$(l,e);return{kind:"series",value:Ce(f,o,(g,w)=>u(g,w,!0,e))}}case"pow":{if(t.length!==2)throw new b("pow expects 2 arguments");const r=t[0],l=t[1];if(r.kind==="scalar"&&l.kind==="scalar")return{kind:"scalar",value:sn(r.value,l.value,i,e)};const u=$(r,e),f=$(l,e);return{kind:"series",value:Ce(u,f,(o,g)=>sn(o,g,i,e))}}case"sqrt":case"log":case"ln":case"log10":case"exp":case"floor":case"ceil":case"round":case"sin":case"cos":case"tan":case"asin":case"acos":case"atan":case"sign":{if(t.length!==1)throw new b(`${a} expects 1 argument`);const r=a==="sqrt"?u=>Jn(u,i,e):a==="log"||a==="ln"?u=>Qn(u,i,e):a==="log10"?u=>xn(u,i,e):a==="exp"?u=>st(u,i):a==="floor"?Math.floor:a==="ceil"?Math.ceil:a==="round"?Math.round:a==="sin"?Math.sin:a==="cos"?Math.cos:a==="tan"?u=>tt(u,i):a==="asin"?u=>et(u,i,e):a==="acos"?u=>nt(u,i,e):a==="atan"?Math.atan:Math.sign,l=t[0];return l.kind==="scalar"?{kind:"scalar",value:r(l.value)}:{kind:"series",value:$e($(l,e),r)}}case"todegrees":case"toradians":{if(t.length!==1)throw new b(`${a} expects 1 argument`);const r=t[0],l=a==="todegrees"?180/Math.PI:Math.PI/180;return r.kind==="scalar"?{kind:"scalar",value:r.value*l}:{kind:"series",value:$e($(r,e),u=>u*l)}}case"atan2":{if(t.length!==2)throw new b("atan2 expects (y, x)");const r=t[0],l=t[1];if(r.kind==="scalar"&&l.kind==="scalar")return{kind:"scalar",value:Math.atan2(r.value,l.value)};const u=$(r,e),f=$(l,e);return{kind:"series",value:Ce(u,f,(o,g)=>Math.atan2(o,g))}}case"avg":{if(t.length!==2)throw new b("avg expects (a, b)");const r=t[0],l=t[1];if(r.kind==="scalar"&&l.kind==="scalar")return{kind:"scalar",value:(r.value+l.value)/2};const u=$(r,e),f=$(l,e);return{kind:"series",value:Ce(u,f,(o,g)=>(o+g)/2)}}case"clamp":{if(t.length!==3)throw new b("clamp expects (x, min, max)");const r=t[0],l=t[1],u=t[2],f=(M,N,p)=>Math.min(p,Math.max(N,M));if(r.kind==="scalar"&&l.kind==="scalar"&&u.kind==="scalar")return{kind:"scalar",value:f(r.value,l.value,u.value)};const o=$(r,e),g=$(l,e),w=$(u,e),k=e.length,F=new Float32Array(k);for(let M=0;M<k;M++)F[M]=f(o[M],g[M],w[M]);return{kind:"series",value:F}}case"cum":case"cumsum":{if(t.length!==1)throw new b(`${a} expects 1 argument`);const r=$(t[0],e),l=e.length,u=new Float32Array(l);let f=0;for(let o=0;o<l;o++){const g=r[o];Number.isFinite(g)&&(f+=g),u[o]=f}return{kind:"series",value:u}}case"barssince":{if(t.length!==1)throw new b("barssince expects (condition)");const r=$(t[0],e),l=e.length,u=new Float32Array(l);let f=NaN;for(let o=0;o<l;o++){const g=r[o];Number.isFinite(g)&&g!==0?(f=0,u[o]=0):Number.isFinite(f)?(f+=1,u[o]=f):u[o]=NaN}return{kind:"series",value:u}}case"sma":{const[r,l]=m();return{kind:"series",value:K(r,l)}}case"wma":{const[r,l]=m();return{kind:"series",value:qe(r,l)}}case"ema":{const[r,l]=m();return{kind:"series",value:z(r,l)}}case"smma":{const[r,l]=m();return{kind:"series",value:ke(r,l)}}case"rsi":{const[r,l]=m();return{kind:"series",value:ut(r,l)}}case"rma":{const[r,l]=m();return{kind:"series",value:ke(r,l)}}case"dema":{const[r,l]=m();return{kind:"series",value:ts(r,l)}}case"tema":{const[r,l]=m();return{kind:"series",value:ss(r,l)}}case"trima":{const[r,l]=m();return{kind:"series",value:is(r,l)}}case"swma":{const[r,l]=m();return{kind:"series",value:rs(r,l)}}case"hma":{const[r,l]=m();return{kind:"series",value:os(r,l)}}case"kama":{if(t.length<2||t.length>4)throw new b("kama expects (series, period[, fast, slow])");const r=$(t[0],e),l=Math.max(1,Math.floor(I(t[1]))),u=t[2]?Math.max(1,Math.floor(I(t[2]))):2,f=t[3]?Math.max(1,Math.floor(I(t[3]))):30;return{kind:"series",value:as(r,l,u,f)}}case"alma":{if(t.length<2||t.length>4)throw new b("alma expects (series, period[, offset, sigma])");const r=$(t[0],e),l=Math.max(1,Math.floor(I(t[1]))),u=t[2]?I(t[2]):.85,f=t[3]?Math.max(.1,I(t[3])):6;return{kind:"series",value:ls(r,l,u,f)}}case"t3":{if(t.length<2||t.length>3)throw new b("t3 expects (series, period[, factor])");const r=$(t[0],e),l=Math.max(1,Math.floor(I(t[1]))),u=t[2]?I(t[2]):.7;return{kind:"series",value:us(r,l,u)}}case"cmo":{const[r,l]=m();return{kind:"series",value:fs(r,l)}}case"tsi":{if(t.length!==3)throw new b("tsi expects (series, long, short)");const r=$(t[0],e),l=Math.max(1,Math.floor(I(t[1]))),u=Math.max(1,Math.floor(I(t[2])));return{kind:"series",value:hs(r,l,u)}}case"stochrsi":{if(t.length<2||t.length>4)throw new b("stochrsi expects (series, length[, smoothK, smoothD])");const r=$(t[0],e),l=Math.max(1,Math.floor(I(t[1]))),u=t[2]?Math.max(1,Math.floor(I(t[2]))):0,f=t[3]?Math.max(1,Math.floor(I(t[3]))):0;return{kind:"series",value:ms(r,l,u||void 0,f||void 0)}}case"ppo":{if(t.length!==3)throw new b("ppo expects (series, fast, slow)");const r=$(t[0],e),l=Math.max(1,Math.floor(I(t[1]))),u=Math.max(1,Math.floor(I(t[2])));return{kind:"series",value:ds(r,l,u)}}case"cog":{if(t.length!==1&&t.length!==2)throw new b("cog expects (length) or (series, length)");const r=t.length===1?e.series.close:$(t[0],e);if(!r)throw new b("cog requires a source series");const l=Math.max(1,Math.floor(I(t[t.length===1?0:1])));return{kind:"series",value:X(e,`cog:${l}:${j(n)}`,()=>_s(r,l))}}case"bbw":{if(t.length!==2&&t.length!==3)throw new b("bbw expects (length, mult) or (series, length, mult)");const r=t.length===2?e.series.close:$(t[0],e);if(!r)throw new b("bbw requires a source series");const l=Math.max(1,Math.floor(I(t[t.length===2?0:1]))),u=I(t[t.length===2?1:2]);return{kind:"series",value:X(e,`bbw:${l}:${j(n)}`,()=>Ss(r,l,u))}}case"uo":{if(t.length!==3&&t.length!==6)throw new b("uo expects (len1, len2, len3) or (high, low, close, len1, len2, len3)");const r=t.length===6?$(t[0],e):e.series.high,l=t.length===6?$(t[1],e):e.series.low,u=t.length===6?$(t[2],e):e.series.close;if(!r||!l||!u)throw new b("uo requires high/low/close series");const f=Math.max(1,Math.floor(I(t[t.length===6?3:0]))),o=Math.max(1,Math.floor(I(t[t.length===6?4:1]))),g=Math.max(1,Math.floor(I(t[t.length===6?5:2])));return{kind:"series",value:X(e,`uo:${f}:${o}:${g}:${j(n)}`,()=>As(r,l,u,f,o,g))}}case"pvi":case"nvi":{if(t.length!==0&&t.length!==2&&t.length!==3)throw new b(`${n.callee} expects () or (close, volume[, start])`);const r=t.length?$(t[0],e):e.series.close,l=t.length?$(t[1],e):e.series.volume,u=t.length===3?I(t[2]):1e3;if(!r||!l)throw new b(`${n.callee} requires close/volume series`);const f=`${a}:${j(n)}`;return{kind:"series",value:X(e,f,()=>a==="pvi"?Es(r,l,u):Is(r,l,u))}}case"kdj":{const r=t.length===6||t.length===7,l=t.length===3||t.length===4;if(!r&&!l)throw new b("kdj expects (len, smoothK, smoothD[, output]) or (high, low, close, len, smoothK, smoothD[, output])");const u=r,f=u?$(t[0],e):e.series.high,o=u?$(t[1],e):e.series.low,g=u?$(t[2],e):e.series.close;if(!f||!o||!g)throw new b("kdj requires high/low/close series");const w=u?3:0,k=Math.max(1,Math.floor(I(t[w+0]))),F=Math.max(1,Math.floor(I(t[w+1]))),M=Math.max(1,Math.floor(I(t[w+2]))),N=t[w+3]?Math.floor(I(t[w+3])):0;if(!Number.isFinite(N)||N<0||N>2)throw new b("kdj output must be 0, 1, or 2");const p=`kdj:${k}:${F}:${M}:${j(n)}`,v=De(e,p,()=>{const _=Ms(f,o,g,k,F,M);return{a:_.k,b:_.d,c:_.j}});return{kind:"series",value:N===0?v.a:N===1?v.b:v.c}}case"kst":{if(t.length<9||t.length>11)throw new b("kst expects (src, r1, r2, r3, r4, n1, n2, n3, n4[, signal, output])");const r=$(t[0],e),l=Math.max(1,Math.floor(I(t[1]))),u=Math.max(1,Math.floor(I(t[2]))),f=Math.max(1,Math.floor(I(t[3]))),o=Math.max(1,Math.floor(I(t[4]))),g=Math.max(1,Math.floor(I(t[5]))),w=Math.max(1,Math.floor(I(t[6]))),k=Math.max(1,Math.floor(I(t[7]))),F=Math.max(1,Math.floor(I(t[8]))),M=t[9]?Math.max(1,Math.floor(I(t[9]))):9,N=t[10]?Math.floor(I(t[10])):0;if(!Number.isFinite(N)||N<0||N>1)throw new b("kst output must be 0 or 1");const p=`kst:${l}:${u}:${f}:${o}:${g}:${w}:${k}:${F}:${M}:${j(n)}`,v=je(e,p,()=>{const y=$s(r,l,u,f,o,g,w,k,F,M);return{a:y.kst,b:y.signal}});return{kind:"series",value:N===0?v.a:v.b}}case"vortex":{const r=t.length===4||t.length===5,l=t.length===1||t.length===2;if(!r&&!l)throw new b("vortex expects (length[, output]) or (high, low, close, length[, output])");const u=r,f=u?$(t[0],e):e.series.high,o=u?$(t[1],e):e.series.low,g=u?$(t[2],e):e.series.close;if(!f||!o||!g)throw new b("vortex requires high/low/close series");const w=u?3:0,k=Math.max(1,Math.floor(I(t[w]))),F=t[w+1]?Math.floor(I(t[w+1])):0;if(!Number.isFinite(F)||F<0||F>1)throw new b("vortex output must be 0 or 1");const M=`vortex:${k}:${j(n)}`,N=je(e,M,()=>{const p=Ls(f,o,g,k);return{a:p.plus,b:p.minus}});return{kind:"series",value:F===0?N.a:N.b}}case"linreg":{if(t.length<2||t.length>3)throw new b("linreg expects (series, period[, offset])");const r=$(t[0],e),l=Math.max(1,Math.floor(I(t[1]))),u=t[2]?Math.floor(I(t[2])):0;return{kind:"series",value:Us(r,l,u)}}case"tr":case"trange":case"true_range":{if(t.length!==0&&t.length!==3)throw new b("tr expects () or (high, low, close)");const r=t.length===3?$(t[0],e):e.series.high,l=t.length===3?$(t[1],e):e.series.low,u=t.length===3?$(t[2],e):e.series.close;if(!r||!l||!u)throw new b("tr requires high/low/close series");const f=e.length,o=new Float32Array(f);let g=NaN;for(let w=0;w<f;w++){const k=r[w],F=l[w],M=u[w];let N=Math.max(0,k-F);Number.isFinite(g)&&(N=Math.max(N,Math.abs(k-g),Math.abs(F-g))),o[w]=N,g=M}return{kind:"series",value:o}}case"atr":{if(t.length!==1&&t.length!==4)throw new b("atr expects (length) or (high, low, close, length)");const r=I(t[t.length===1?0:3]),l=i?B(r,`atr_len:${j(n)}`,Xt,e):Math.max(1,Math.floor(r));if(!Number.isFinite(l))return{kind:"series",value:H(e.length)};const u=t.length===1?e.series.high:$(t[0],e),f=t.length===1?e.series.low:$(t[1],e),o=t.length===1?e.series.close:$(t[2],e);if(!u||!f||!o)throw new b("atr requires high/low/close series");const g=e.length,w=on(u,f,o),k=new Float32Array(g);let F=0;for(let M=0;M<g;M++)F+=w[M],M===l-1?k[M]=F/l:M>=l?k[M]=(k[M-1]*(l-1)+w[M])/l:k[M]=NaN;return{kind:"series",value:k}}case"atrp":case"natr":{if(t.length!==1&&t.length!==4)throw new b(`${n.callee} expects (length) or (high, low, close, length)`);const r=I(t[t.length===1?0:3]),l=Math.max(1,Math.floor(r));if(!Number.isFinite(l))return{kind:"series",value:H(e.length)};const u=t.length===1?e.series.high:$(t[0],e),f=t.length===1?e.series.low:$(t[1],e),o=t.length===1?e.series.close:$(t[2],e);if(!u||!f||!o)throw new b(`${n.callee} requires high/low/close series`);return{kind:"series",value:cs(u,f,o,l)}}case"stdev":case"stddev":case"dev":{const[r,l]=m();return{kind:"series",value:an(r,l)}}case"variance":case"var":{const[r,l]=m();return{kind:"series",value:Cs(r,l)}}case"zscore":{const[r,l]=m();return{kind:"series",value:Ns(r,l)}}case"correlation":case"corr":{if(t.length!==3)throw new b(`${n.callee} expects (a, b, period)`);const r=$(t[0],e),l=$(t[1],e),u=Math.max(1,Math.floor(I(t[2])));return{kind:"series",value:Rs(r,l,u)}}case"highest":{if(!i){const[f,o]=m();return{kind:"series",value:Fe(f,o)}}if(t.length!==2)throw new b("highest expects (series, period)");const r=$(t[0],e),l=I(t[1]),u=B(l,`highest_len:${j(n)}`,Gn,e);return Number.isFinite(u)?{kind:"series",value:Fe(r,u)}:{kind:"series",value:H(e.length)}}case"highestbars":{const[r,l]=m();return{kind:"series",value:ct(r,l)}}case"lowest":{if(!i){const[f,o]=m();return{kind:"series",value:ve(f,o)}}if(t.length!==2)throw new b("lowest expects (series, period)");const r=$(t[0],e),l=I(t[1]),u=B(l,`lowest_len:${j(n)}`,Kn,e);return Number.isFinite(u)?{kind:"series",value:ve(r,u)}:{kind:"series",value:H(e.length)}}case"lowestbars":{const[r,l]=m();return{kind:"series",value:ft(r,l)}}case"sum":{if(!i){const[f,o]=m();return{kind:"series",value:W(f,o)}}if(t.length!==2)throw new b("sum expects (series, period)");const r=$(t[0],e),l=I(t[1]),u=B(l,`sum_len:${j(n)}`,Wn,e);if(!Number.isFinite(u)){const f=new Float32Array(e.length);return f.fill(NaN),{kind:"series",value:f}}return{kind:"series",value:W(r,u)}}case"rising":case"falling":{if(!i)throw new b(`Unknown function "${n.callee}"`);if(t.length!==2)throw new b(`${n.callee} expects (series, length)`);const r=$(t[0],e),l=I(t[1]),u=`${a}_len:${j(n)}`,o=B(l,u,a==="rising"?Hn:Yn,e);if(!Number.isFinite(o)){const g=new Float32Array(e.length);return g.fill(NaN),{kind:"series",value:g}}return{kind:"series",value:Nn(r,o,a)}}case"lag":{if(t.length!==2)throw new b("lag expects (series, n)");const r=$(t[0],e),l=I(t[1]);if(i){const f=ce(l,"history_index",Ae,e);if(!Number.isFinite(f)){const o=new Float32Array(e.length);return o.fill(NaN),{kind:"series",value:o}}return{kind:"series",value:Ve(r,f)}}const u=Math.max(1,Math.floor(l));return{kind:"series",value:Ve(r,u)}}case"prev":{if(t.length<1||t.length>2)throw new b("prev expects (series[, n])");const r=$(t[0],e),l=I(t[1]??{kind:"scalar",value:1});if(i){const f=ce(l,"history_index",Ae,e);if(!Number.isFinite(f)){const o=new Float32Array(e.length);return o.fill(NaN),{kind:"series",value:o}}return{kind:"series",value:Ve(r,f)}}const u=Math.max(1,Math.floor(l));return{kind:"series",value:Ve(r,u)}}case"change":{if(t.length<1||t.length>2)throw new b("change expects (series[, n])");const r=$(t[0],e),l=Math.max(1,Math.floor(I(t[1]??{kind:"scalar",value:1})));return{kind:"series",value:qt(r,l)}}case"roc":{if(t.length<1||t.length>2)throw new b("roc expects (series[, n])");const r=$(t[0],e),l=Math.max(1,Math.floor(I(t[1]??{kind:"scalar",value:1})));return{kind:"series",value:Me(r,l)}}case"mom":case"momentum":{if(t.length<1||t.length>2)throw new b("mom expects (series[, n])");const r=$(t[0],e),l=Math.max(1,Math.floor(I(t[1]??{kind:"scalar",value:1})));return{kind:"series",value:jt(r,l)}}case"crossover":case"crossunder":{if(t.length<2||t.length>3)throw new b(`${n.callee} expects (series, series[, tol])`);const r=$(t[0],e),l=t[1],u=l.kind==="series",f=$(l,e),o=t[2]?Math.max(0,I(t[2])):0,g=e.length,w=new Float32Array(g);w[0]=0;for(let k=1;k<g;k++){const F=r[k-1],M=r[k],N=u?f[k-1]:f[0],p=u?f[k]:f[0];if(![F,M,N,p].every(Number.isFinite)){w[k]=0;continue}a==="crossover"?w[k]=F<=N+o&&M>p+o?1:0:w[k]=F>=N-o&&M<p-o?1:0}return{kind:"series",value:w}}case"hl2":{if(t.length!==0)throw new b("hl2 expects no arguments");const r=e.series.high,l=e.series.low;if(!r||!l)throw new b("hl2 requires high/low series");const u=e.length,f=new Float32Array(u);for(let o=0;o<u;o++)f[o]=(r[o]+l[o])/2;return{kind:"series",value:f}}case"hlc3":{if(t.length!==0)throw new b("hlc3 expects no arguments");const r=e.series.high,l=e.series.low,u=e.series.close;if(!r||!l||!u)throw new b("hlc3 requires high/low/close series");const f=e.length,o=new Float32Array(f);for(let g=0;g<f;g++)o[g]=(r[g]+l[g]+u[g])/3;return{kind:"series",value:o}}case"ohlc4":{if(t.length!==0)throw new b("ohlc4 expects no arguments");const r=e.series.open,l=e.series.high,u=e.series.low,f=e.series.close;if(!r||!l||!u||!f)throw new b("ohlc4 requires open/high/low/close series");const o=e.length,g=new Float32Array(o);for(let w=0;w<o;w++)g[w]=(r[w]+l[w]+u[w]+f[w])/4;return{kind:"series",value:g}}case"vwap":{if(t.length!==0&&t.length!==2)throw new b("vwap expects () or (close, volume)");const r=t.length===0?e.series.close:$(t[0],e),l=t.length===0?e.series.volume:$(t[1],e);if(!r||!l)throw new b("vwap requires close/volume series");const u=t.length===0?e.series.high:void 0,f=t.length===0?e.series.low:void 0,o=t.length===0?e.series.time:void 0;if(t.length===0&&(!u||!f))throw new b("vwap requires high/low/close series");const g=e.length,w=new Float32Array(g);let k=0,F=0,M=Number.NaN;for(let N=0;N<g;N++){if(t.length===0&&o){const y=o[N];if(Number.isFinite(y)){const _=Math.floor(y/864e5);(!Number.isFinite(M)||_!==M)&&(k=0,F=0,M=_)}}const p=l[N],v=t.length===0?(u[N]+f[N]+r[N])/3:r[N];if(!Number.isFinite(v)||!Number.isFinite(p)){w[N]=NaN;continue}k+=v*p,F+=p,w[N]=F===0?NaN:k/F}return{kind:"series",value:w}}case"vwma":{if(t.length!==3)throw new b("vwma expects (close, volume, period)");const r=$(t[0],e),l=$(t[1],e),u=Math.max(1,Math.floor(I(t[2]))),f=e.length,o=new Float32Array(f);let g=0,w=0;for(let k=0;k<f;k++){const F=r[k],M=l[k];if(Number.isFinite(F)&&Number.isFinite(M)&&(g+=F*M,w+=M),k>=u){const N=r[k-u],p=l[k-u];Number.isFinite(N)&&Number.isFinite(p)&&(g-=N*p,w-=p)}o[k]=k>=u-1&&w!==0?g/w:NaN}return{kind:"series",value:o}}case"evwma":{if(t.length!==3)throw new b("evwma expects (close, volume, period)");const r=$(t[0],e),l=$(t[1],e),u=Math.max(1,Math.floor(I(t[2]))),f=Ut(Y(r),Y(l),u);return{kind:"series",value:ee(f)}}case"bbands":case"bollinger":{if(!i)throw new b(`Unknown function "${n.callee}"`);if(t.length<3||t.length>4)throw new b("bbands expects (series, period, mult[, output])");const r=$(t[0],e),l=Math.max(1,Math.floor(I(t[1]))),u=I(t[2]),f=t[3]?Math.floor(I(t[3])):0;if(!Number.isFinite(f)||f<0||f>2)throw new b("bbands output must be 0, 1, or 2");const o=Rt(Y(r),l,u),g=f===0?o.mid:f===1?o.upper:o.lower;return{kind:"series",value:ee(g)}}case"keltner":case"kc":{if(t.length<2||t.length>6)throw new b("keltner expects (period, mult[, output]) or (high, low, close, period, mult[, output])");let r,l,u,f=0,o=1,g=2;if(t.length>=5?(r=$(t[0],e),l=$(t[1],e),u=$(t[2],e),f=3,o=4,g=5):(r=e.series.high,l=e.series.low,u=e.series.close),!r||!l||!u)throw new b("keltner requires high/low/close series");const w=Math.max(1,Math.floor(I(t[f]))),k=I(t[o]),F=t[g]?Math.floor(I(t[g])):0;if(!Number.isFinite(F)||F<0||F>2)throw new b("keltner output must be 0, 1, or 2");const M=Fs(r,l,u,w,k);return{kind:"series",value:F===0?M.mid:F===1?M.upper:M.lower}}case"donchian":{if(t.length<1||t.length>4)throw new b("donchian expects (period[, output]) or (high, low, period[, output])");let r,l,u=0,f=1;if(t.length>=3?(r=$(t[0],e),l=$(t[1],e),u=2,f=3):(r=e.series.high,l=e.series.low),!r||!l)throw new b("donchian requires high/low series");const o=Math.max(1,Math.floor(I(t[u]))),g=t[f]?Math.floor(I(t[f])):0;if(!Number.isFinite(g)||g<0||g>2)throw new b("donchian output must be 0, 1, or 2");const w=vs(r,l,o);return{kind:"series",value:g===0?w.upper:g===1?w.lower:w.mid}}case"supertrend":{if(t.length<2||t.length>3)throw new b("supertrend expects (factor, period[, output])");const r=I(t[0]),l=Math.max(1,Math.floor(I(t[1]))),u=t[2]?Math.floor(I(t[2])):0;if(!Number.isFinite(u)||u<0||u>1)throw new b("supertrend output must be 0 or 1");const f=e.series.high,o=e.series.low,g=e.series.close;if(!f||!o||!g)throw new b("supertrend requires high/low/close series");const w=ks(f,o,g,l,r);return{kind:"series",value:u===0?w.line:w.dir}}case"sar":{if(t.length!==0&&t.length!==3)throw new b("sar expects () or (start, increment, maximum)");const r=t.length===3?I(t[0]):.02,l=t.length===3?I(t[1]):.02,u=t.length===3?I(t[2]):.2,f=e.series.high,o=e.series.low;if(!f||!o)throw new b("sar requires high/low series");return{kind:"series",value:ys(f,o,r,l,u)}}case"macd":{if(!i)throw new b(`Unknown function "${n.callee}"`);if(t.length<4||t.length>5)throw new b("macd expects (series, fast, slow, signal[, output])");const r=$(t[0],e),l=Math.max(1,Math.floor(I(t[1]))),u=Math.max(1,Math.floor(I(t[2]))),f=Math.max(1,Math.floor(I(t[3]))),o=t[4]?Math.floor(I(t[4])):0;if(!Number.isFinite(o)||o<0||o>2)throw new b("macd output must be 0, 1, or 2");const g=Dt(r,l,u,f);return{kind:"series",value:o===0?g.line:o===1?g.signal:g.hist}}case"stoch":{if(!i)throw new b(`Unknown function "${n.callee}"`);if(t.length<5||t.length>6)throw new b("stoch expects (high, low, close, k, d[, output])");const r=$(t[0],e),l=$(t[1],e),u=$(t[2],e),f=Math.max(1,Math.floor(I(t[3]))),o=Math.max(1,Math.floor(I(t[4]))),g=t[5]?Math.floor(I(t[5])):0;if(!Number.isFinite(g)||g<0||g>1)throw new b("stoch output must be 0 or 1");const w=Ot(r,l,u,f,o);return{kind:"series",value:g===0?w.k:w.d}}case"ao":{if(t.length!==0&&t.length!==2)throw new b("ao expects () or (high, low)");const r=t.length===2?$(t[0],e):e.series.high,l=t.length===2?$(t[1],e):e.series.low;if(!r||!l)throw new b("ao requires high/low series");return{kind:"series",value:gs(r,l)}}case"trix":{const[r,l]=m();return{kind:"series",value:ws(r,l)}}case"williamsr":{if(!i)throw new b(`Unknown function "${n.callee}"`);if(t.length!==1&&t.length!==4)throw new b("williamsr expects (length) or (high, low, close, length)");const r=t.length===1?I(t[0]):I(t[3]),l=B(r,"williamsr_len",Pn,e);if(!Number.isFinite(l))return{kind:"series",value:H(e.length)};const u=t.length===1?e.series.high:$(t[0],e),f=t.length===1?e.series.low:$(t[1],e),o=t.length===1?e.series.close:$(t[2],e);if(!u||!f||!o)throw new b("williamsr requires high/low/close series");return{kind:"series",value:kn(u,f,o,l)}}case"aroon":{if(!i)throw new b(`Unknown function "${n.callee}"`);if(t.length<1||t.length>2)throw new b("aroon expects (length[, output])");const r=I(t[0]),l=B(r,"aroon_len",qn,e);if(!Number.isFinite(l))return{kind:"series",value:H(e.length)};const u=t[1]?Math.floor(I(t[1])):0;if(!Number.isFinite(u)||u<0||u>1)throw new b("aroon output must be 0 or 1");const f=e.series.high,o=e.series.low;if(!f||!o)throw new b("aroon requires high/low series");const g=Ie(f,o,l);return{kind:"series",value:u===0?g.up:g.down}}case"aroonosc":{if(!i)throw new b(`Unknown function "${n.callee}"`);if(t.length!==1)throw new b("aroonosc expects (length)");const r=I(t[0]),l=B(r,"aroonosc_len",Vn,e);if(!Number.isFinite(l))return{kind:"series",value:H(e.length)};const u=e.series.high,f=e.series.low;if(!u||!f)throw new b("aroonosc requires high/low series");return{kind:"series",value:Tt(u,f,l)}}case"dmi":{if(!i)throw new b(`Unknown function "${n.callee}"`);if(t.length<2||t.length>3)throw new b("dmi expects (length, smoothing[, output])");const r=I(t[0]),l=I(t[1]),u=B(r,"dmi_len",jn,e),f=B(l,"dmi_smooth",Dn,e);if(!Number.isFinite(u)||!Number.isFinite(f))return{kind:"series",value:H(e.length)};const o=t[2]?Math.floor(I(t[2])):0;if(!Number.isFinite(o)||o<0||o>2)throw new b("dmi output must be 0, 1, or 2");const g=e.series.high,w=e.series.low,k=e.series.close;if(!g||!w||!k)throw new b("dmi requires high/low/close series");const F=re(g,w,k,u,f);return{kind:"series",value:o===0?F.plus:o===1?F.minus:F.adx}}case"plus_di":{if(!i)throw new b(`Unknown function "${n.callee}"`);if(t.length!==1)throw new b("plus_di expects (length)");const r=I(t[0]),l=B(r,"plus_di_len",Tn,e);if(!Number.isFinite(l))return{kind:"series",value:H(e.length)};const u=e.series.high,f=e.series.low,o=e.series.close;if(!u||!f||!o)throw new b("plus_di requires high/low/close series");return{kind:"series",value:re(u,f,o,l,l).plus}}case"minus_di":{if(!i)throw new b(`Unknown function "${n.callee}"`);if(t.length!==1)throw new b("minus_di expects (length)");const r=I(t[0]),l=B(r,"minus_di_len",Bn,e);if(!Number.isFinite(l))return{kind:"series",value:H(e.length)};const u=e.series.high,f=e.series.low,o=e.series.close;if(!u||!f||!o)throw new b("minus_di requires high/low/close series");return{kind:"series",value:re(u,f,o,l,l).minus}}case"dx":{if(!i)throw new b(`Unknown function "${n.callee}"`);if(t.length!==1)throw new b("dx expects (length)");const r=I(t[0]),l=B(r,"dx_len",zn,e);if(!Number.isFinite(l))return{kind:"series",value:H(e.length)};const u=e.series.high,f=e.series.low,o=e.series.close;if(!u||!f||!o)throw new b("dx requires high/low/close series");const g=re(u,f,o,l,l);return{kind:"series",value:Fn(g.plus,g.minus)}}case"adx":{if(!i)throw new b(`Unknown function "${n.callee}"`);if(t.length!==1)throw new b("adx expects (length)");const r=I(t[0]),l=B(r,"adx_len",On,e);if(!Number.isFinite(l))return{kind:"series",value:H(e.length)};const u=e.series.high,f=e.series.low,o=e.series.close;if(!u||!f||!o)throw new b("adx requires high/low/close series");return{kind:"series",value:re(u,f,o,l,l).adx}}case"valuewhen":{if(!i)throw new b(`Unknown function "${n.callee}"`);if(t.length!==3)throw new b("valuewhen expects (condition, source, occurrence)");const r=n.args[0],l=te(r);l&&q(e,fe(r,e,"type"),Re);const u=`valuewhen_occ:${j(n)}`;if(t[2].kind!=="scalar")return q(e,u,Ue),{kind:"series",value:H(e.length)};const f=ce(t[2].value,u,Ue,e);if(!Number.isFinite(f)||l)return{kind:"series",value:H(e.length)};const o=$(t[0],e),g=$(t[1],e),w=fe(r,e,"na");return{kind:"series",value:vn(o,g,f,M=>ue(M,e.diagnostics,w))}}case"pivothigh":case"pivotlow":{if(!i)throw new b(`Unknown function "${n.callee}"`);if(t.length!==3)throw new b(`${n.callee} expects (source, left, right)`);const r=I(t[1]),l=I(t[2]),{left:u,right:f}=yn(r,l),o=$(t[0],e);return{kind:"series",value:Bt(o,u,f,a==="pivothigh"?"high":"low")}}case"year":case"month":case"dayofweek":case"hour":case"minute":case"second":{if(!i)throw new b(`Unknown function "${n.callee}"`);if(t.length!==1)throw new b(`${n.callee} expects (time)`);const r=t[0];if(r.kind==="scalar"){if(oe(r.value),a==="dayofweek")return{kind:"scalar",value:Xe(r.value)};const f=a==="year"||a==="month"?a:a==="hour"?"hour":a==="minute"?"minute":"second";return{kind:"scalar",value:Ze(r.value,f)}}const l=$(r,e);if($n(l),a==="dayofweek")return{kind:"series",value:$e(l,Xe)};const u=a==="year"||a==="month"?a:a==="hour"?"hour":a==="minute"?"minute":"second";return{kind:"series",value:$e(l,f=>Ze(f,u))}}case"timestamp":{if(!i)throw new b(`Unknown function "${n.callee}"`);if(t.length<5||t.length>6)throw new b("timestamp expects (year, month, day, hour, minute[, second])");const r=t.length===6?t[5]:{kind:"scalar",value:0};if([t[0],t[1],t[2],t[3],t[4],r].every(N=>(N==null?void 0:N.kind)==="scalar")){const N=t[0].value,p=t[1].value,v=t[2].value,y=t[3].value,_=t[4].value,S=r.value;return{kind:"scalar",value:An(N,p,v,y,_,S)}}const u=$(t[0],e),f=$(t[1],e),o=$(t[2],e),g=$(t[3],e),w=$(t[4],e),k=$(r,e);[u,f,o,g,w,k].forEach($n);const F=e.length,M=new Float32Array(F);for(let N=0;N<F;N++){const p=u[N],v=f[N],y=o[N],_=g[N],S=w[N],C=k[N];if(![p,v,y,_,S,C].every(Number.isFinite)){M[N]=NaN;continue}if(v<1||v>12)throw new b(Mn);M[N]=Date.UTC(p,v-1,y,_,S,C)}return{kind:"series",value:M}}case"timenow":{if(!i)throw new b(`Unknown function "${n.callee}"`);if(t.length!==0)throw new b("timenow expects ()");return{kind:"scalar",value:En(e)}}case"time_close":{if(!i)throw new b(`Unknown function "${n.callee}"`);if(t.length!==0)throw new b("time_close expects ()");const r=e.series.time;if(!r)throw new b("time_close requires time series");const l=Sn(e);return{kind:"series",value:$e(r,u=>Number.isFinite(u)?u+l:NaN)}}case"isin":case"session_isin":case"session.isin":{if(!i)throw new b(`Unknown function "${n.callee}"`);if(t.length!==2)throw new b("session.isin expects (time, session)");const r=n.args[1];if(!r||r.kind!=="StringLiteral")throw new b(Le);const{start:l,end:u}=Ln(r.value),f=t[0];if(f.kind==="scalar"){const w=f.value;if(!Number.isFinite(w))throw new b(Je);const k=Qe(w);return{kind:"scalar",value:xe(k,l,u)?1:0}}const o=$(f,e),g=new Float32Array(o.length);for(let w=0;w<o.length;w++){const k=o[w];if(!Number.isFinite(k))throw new b(Je);const F=Qe(k);g[w]=xe(F,l,u)?1:0}return{kind:"series",value:g}}case"cci":{if(!i)throw new b(`Unknown function "${n.callee}"`);if(t.length!==4)throw new b("cci expects (high, low, close, period)");const r=$(t[0],e),l=$(t[1],e),u=$(t[2],e),f=Math.max(1,Math.floor(I(t[3]))),o=Lt(Y(r),Y(l),Y(u),f);return{kind:"series",value:ee(o)}}case"mfi":{if(!i)throw new b(`Unknown function "${n.callee}"`);if(t.length!==5)throw new b("mfi expects (high, low, close, volume, period)");const r=$(t[0],e),l=$(t[1],e),u=$(t[2],e),f=$(t[3],e),o=Math.max(1,Math.floor(I(t[4]))),g=Ct(Y(r),Y(l),Y(u),Y(f),o);return{kind:"series",value:ee(g)}}case"obv":{if(!i)throw new b(`Unknown function "${n.callee}"`);if(t.length!==2)throw new b("obv expects (close, volume)");const r=$(t[0],e),l=$(t[1],e),u=It(Y(r),Y(l));return{kind:"series",value:ee(u)}}case"ad":{if(!i)throw new b(`Unknown function "${n.callee}"`);if(t.length!==0&&t.length!==4)throw new b("ad expects () or (high, low, close, volume)");const r=t.length===4?$(t[0],e):e.series.high,l=t.length===4?$(t[1],e):e.series.low,u=t.length===4?$(t[2],e):e.series.close,f=t.length===4?$(t[3],e):e.series.volume;if(!r||!l||!u||!f)throw new b("ad requires high/low/close/volume series");return{kind:"series",value:bs(r,l,u,f)}}case"cmf":{if(!i)throw new b(`Unknown function "${n.callee}"`);if(t.length!==1&&t.length!==5)throw new b("cmf expects (length) or (high, low, close, volume, length)");const r=Math.max(1,Math.floor(I(t[t.length===1?0:4]))),l=t.length===5?$(t[0],e):e.series.high,u=t.length===5?$(t[1],e):e.series.low,f=t.length===5?$(t[2],e):e.series.close,o=t.length===5?$(t[3],e):e.series.volume;if(!l||!u||!f||!o)throw new b("cmf requires high/low/close/volume series");return{kind:"series",value:ps(l,u,f,o,r)}}case"min":{if(t.length!==2)throw new b("min expects 2 arguments");const r=t[0],l=t[1];if(r.kind==="scalar"&&l.kind==="scalar")return{kind:"scalar",value:Math.min(r.value,l.value)};const u=$(r,e),f=$(l,e),o=e.length,g=new Float32Array(o);for(let w=0;w<o;w++)g[w]=Math.min(u[w],f[w]);return{kind:"series",value:g}}case"max":{if(t.length!==2)throw new b("max expects 2 arguments");const r=t[0],l=t[1];if(r.kind==="scalar"&&l.kind==="scalar")return{kind:"scalar",value:Math.max(r.value,l.value)};const u=$(r,e),f=$(l,e),o=e.length,g=new Float32Array(o);for(let w=0;w<o;w++)g[w]=Math.max(u[w],f[w]);return{kind:"series",value:g}}case"abs":{if(t.length!==1)throw new b("abs expects 1 argument");const r=t[0];if(r.kind==="scalar")return{kind:"scalar",value:Math.abs(r.value)};const l=r.value,u=e.length,f=new Float32Array(u);for(let o=0;o<u;o++)f[o]=Math.abs(l[o]);return{kind:"series",value:f}}default:throw new b(`Unknown function "${n.callee}"`)}}function se(n,e){var s,i;switch(n.kind){case"NumberLiteral":return{kind:"scalar",value:n.value};case"StringLiteral":return{kind:"scalar",value:x(n.value)};case"Identifier":{const a=n.name.replace(/\s+/g,"_").toLowerCase();if(a==="na"||a==="nan")return{kind:"scalar",value:NaN};if(a==="pi")return{kind:"scalar",value:Math.PI};if(a==="e")return{kind:"scalar",value:Math.E};const c=e.series[a];if(c)return{kind:"series",value:c};const t=(s=e.scalars)==null?void 0:s[a];if(typeof t=="number"&&Number.isFinite(t))return{kind:"scalar",value:t};throw e.seriesNames.has(a)?new b(`Series "${n.name}" is used before it is defined (circular or forward reference)`):new b(`Unknown identifier "${n.name}"`)}case"MemberExpression":{const a=Se(n);return a?se({kind:"Identifier",name:a},e):(rt(e,n),{kind:"scalar",value:NaN})}case"IndexExpression":return ot(e,n),{kind:"scalar",value:NaN};case"UnaryExpression":{const a=se(n.expr,e);if(n.operator==="not"){const c=((i=e.scalars)==null?void 0:i.__pinev2)===1;if(a.kind==="scalar"){const m=a.value;return{kind:"scalar",value:c?en(m):Number.isFinite(m)&&m!==0?0:1}}const t=a.value,h=new Float32Array(t.length);for(let m=0;m<t.length;m++){const d=t[m];h[m]=c?en(d):Number.isFinite(d)&&d!==0?0:1}return{kind:"series",value:h}}throw new b("Unsupported unary operator")}case"BinaryExpression":return n.operator==="and"||n.operator==="or"?ns(n,e):lt(n.operator,se(n.left,e),se(n.right,e),e);case"CallExpression":return ht(n,e);default:throw new b("Unsupported expression node")}}const X=(n,e,s)=>{if(!n.memo)return s();const i=n.memo.get(e);if(i)return i;const a=s();return n.memo.set(e,a),a},he=(n,e)=>{if(n.kind==="Identifier"){const s=n.name.replace(/\s+/g,"_").toLowerCase();return e.series[s]??null}if(n.kind==="MemberExpression"){const s=Se(n);if(!s)return null;const i=s.replace(/\s+/g,"_").toLowerCase();return e.series[i]??null}if(n.kind==="NumberLiteral")return X(e,`const:${n.value}`,()=>{const s=new Float32Array(e.length);return s.fill(n.value),s});if(n.kind==="StringLiteral"){const s=x(n.value);return X(e,`const_str:${n.value}`,()=>{const i=new Float32Array(e.length);return i.fill(s),i})}return null},je=(n,e,s)=>{if(!n.memo)return s();const i=`${e}:a`,a=n.memo.get(i);if(a)return{a,b:n.memo.get(`${e}:b`)};const c=s();return n.memo.set(i,c.a),n.memo.set(`${e}:b`,c.b),c},De=(n,e,s)=>{if(!n.memo)return s();const i=`${e}:a`,a=n.memo.get(i);if(a)return{a,b:n.memo.get(`${e}:b`),c:n.memo.get(`${e}:c`)};const c=s();return n.memo.set(i,c.a),n.memo.set(`${e}:b`,c.b),n.memo.set(`${e}:c`,c.c),c};function mt(n,e){var c;const s=n.replace(/\s+/g,"_").toLowerCase();if(s==="na"||s==="nan")return NaN;if(s==="pi")return Math.PI;if(s==="e")return Math.E;if(e.locals&&Object.prototype.hasOwnProperty.call(e.locals,s))return e.locals[s];if(e.selfKey&&e.selfOut&&s===e.selfKey){if(e.selfMode==="current"){const h=e.selfOut[e.index];if(Number.isFinite(h))return h}const t=e.index-1;return t>=0?e.selfOut[t]:NaN}const i=e.series[s];if(i)return i[e.index]??NaN;const a=(c=e.scalars)==null?void 0:c[s];if(typeof a=="number"&&Number.isFinite(a))return a;throw new b(`Unknown identifier "${n}"`)}const un=1e3,Ps=1e6,dt=(n,e,s)=>{if(!Number.isFinite(n)||!Number.isFinite(e)||!Number.isFinite(s)||s===0)return null;if(s>0){if(n>e)return 0;const i=(e-n)/s;return Math.floor(i+1+1e-12)}if(s<0){if(n<e)return 0;const i=(n-e)/Math.abs(s);return Math.floor(i+1+1e-12)}return null},G=(n,e)=>{try{return We(n)}catch(s){throw s instanceof me?new b(`Syntax error in ${e} at position ${s.position}: ${s.message}`):s}},Oe=n=>n.map(e=>e.kind==="assign"?{kind:"assign",name:e.name,expr:G(e.expr,`loop assignment "${e.name}"`),lineNo:e.lineNo}:e.kind==="if"?{kind:"if",lineNo:e.lineNo,branches:e.branches.map(s=>({cond:s.cond?G(s.cond,"loop if condition"):void 0,body:Oe(s.body),lineNo:s.lineNo}))}:e.kind==="for"?{kind:"for",lineNo:e.lineNo,varName:e.varName,startExpr:G(e.startExpr,"loop for start"),endExpr:G(e.endExpr,"loop for end"),stepExpr:G(e.stepExpr,"loop for step"),body:Oe(e.body)}:e.kind==="while"?{kind:"while",lineNo:e.lineNo,condExpr:G(e.condExpr,"loop while condition"),body:Oe(e.body)}:{kind:e.kind,lineNo:e.lineNo}),cn=(n,e)=>{for(const s of n){if(s.kind==="assign"){e.add(s.name);continue}if(s.kind==="if"){s.branches.forEach(i=>cn(i.body,e));continue}(s.kind==="for"||s.kind==="while")&&cn(s.body,e)}},qs=n=>{const e=Oe(n.body||[]),s=new Set;return cn(e,s),{id:n.id,kind:n.kind,lineNo:n.lineNo,varName:n.varName,startExpr:n.startExpr?G(n.startExpr,"loop start"):void 0,endExpr:n.endExpr?G(n.endExpr,"loop end"):void 0,stepExpr:n.stepExpr?G(n.stepExpr,"loop step"):void 0,condExpr:n.condExpr?G(n.condExpr,"loop condition"):void 0,body:e,targets:Array.from(s)}},js=(n,e,s)=>{if((!n||!n.length)&&!s)return;const i=e==null?void 0:e.__loop_max_iters,a=typeof i=="number"&&Number.isFinite(i),c=a&&i<=0?Number.POSITIVE_INFINITY:a?Math.min(Ps,Math.max(1,Math.floor(i))):un,t=new Map;return(n||[]).forEach(h=>{if(!h||typeof h!="object")return;const m=String(h.id||"").trim();m&&t.set(m,qs(h))}),{plans:t,maxIters:c,hasCustomMax:a,running:new Set}},Te=n=>n.map(e=>e.kind==="assign"?{kind:"assign",name:e.name,op:e.op,decl:e.decl,expr:G(e.expr,`function assignment "${e.name}"`),lineNo:e.lineNo}:e.kind==="return"?{kind:"return",expr:G(e.expr,"function return"),lineNo:e.lineNo}:e.kind==="if"?{kind:"if",lineNo:e.lineNo,branches:e.branches.map(s=>({cond:s.cond?G(s.cond,"function if condition"):void 0,body:Te(s.body),lineNo:s.lineNo}))}:e.kind==="for"?{kind:"for",lineNo:e.lineNo,varName:e.varName,startExpr:G(e.startExpr,"function for start"),endExpr:G(e.endExpr,"function for end"),stepExpr:G(e.stepExpr,"function for step"),body:Te(e.body)}:e.kind==="while"?{kind:"while",lineNo:e.lineNo,condExpr:G(e.condExpr,"function while condition"),body:Te(e.body)}:{kind:e.kind,lineNo:e.lineNo}),fn=(n,e)=>{for(const s of n){if(s.kind==="assign"){if(s.decl==="var"||s.decl==="varip"){const i=s.name.replace(/\s+/g,"_").toLowerCase();e.add(i)}continue}if(s.kind==="if"){s.branches.forEach(i=>fn(i.body,e));continue}(s.kind==="for"||s.kind==="while")&&fn(s.body,e)}},Ds=n=>{const e=Te(n.body||[]),s=new Set;return fn(e,s),{name:n.name,args:n.args||[],lineNo:n.lineNo,body:e,statefulVars:s}},Os=n=>{if(!n||!n.length)return;const e=new Map;return n.forEach(s=>{if(!s||typeof s!="object")return;const i=String(s.name||"").trim();if(i)try{e.set(i.toLowerCase(),Ds(s))}catch{}}),{funcs:e,callState:new WeakMap,running:new Set}},ye=(n,e,s,i,a)=>R(n,{...e,locals:s,selfKey:i,selfOut:a,selfMode:"current"}),hn=(n,e,s)=>{for(const i of n){if(i.kind==="assign"){const a=i.name.replace(/\s+/g,"_").toLowerCase();let c=e.series[a];c||(c=new Float32Array(e.length),c.fill(NaN),e.series[a]=c);const t=ye(i.expr,e,s,a,c);c[e.index]=t;continue}if(i.kind==="break")return"break";if(i.kind==="continue")return"continue";if(i.kind==="if"){let a=!1;for(const c of i.branches){if(a)break;if(c.cond){const h=ye(c.cond,e,s);if(!ue(h,e.diagnostics,`loop_cond_na:${i.lineNo}`))continue}a=!0;const t=hn(c.body,e,s);if(t!=="none")return t}continue}if(i.kind==="for"){Be({kind:"for",varName:i.varName,startExpr:i.startExpr,endExpr:i.endExpr,stepExpr:i.stepExpr,body:i.body,lineNo:i.lineNo},e,s);continue}if(i.kind==="while"){Be({kind:"while",condExpr:i.condExpr,body:i.body,lineNo:i.lineNo},e,s);continue}}return"none"},Be=(n,e,s)=>{const i=e.loopRuntime,a=(i==null?void 0:i.maxIters)??un,c=(i==null?void 0:i.hasCustomMax)??!1,t=`loop_max:${n.lineNo}`,h=`Loop exceeded max iterations (${a})`;if(n.kind==="for"){const r=Object.prototype.hasOwnProperty.call(s,n.varName)?s[n.varName]:void 0,l=ye(n.startExpr,e,s),u=ye(n.endExpr,e,s),f=ye(n.stepExpr,e,s);if(!Number.isFinite(f)||f===0){q(e,`loop_step_zero:${n.lineNo}`,"for-loop step must not be 0");return}const o=dt(l,u,f),g=Number.isFinite(a)?a:null;let w=null,k=!1;c&&g!=null?o==null?(w=g,k=!0):(w=Math.min(g,o),k=o>g):o!=null&&(w=o);const F=f>0;let M=l,N=0;for(;(w==null||N<w)&&!(!Number.isFinite(M)||!Number.isFinite(u)||F&&M>u+1e-12||!F&&M<u-1e-12);){s[n.varName]=M;const p=hn(n.body,e,s);if(p==="break")break;M+=f,N+=1}k&&w!=null&&N>=w&&q(e,t,h),r===void 0?delete s[n.varName]:s[n.varName]=r;return}let m=0;const d=Number.isFinite(a)?a:null;for(;d==null||m<d;){const r=ye(n.condExpr,e,s);if(!ue(r,e.diagnostics,`loop_cond_na:${n.lineNo}`))break;const u=hn(n.body,e,s);if(u==="break")break;m+=1}d!=null&&m>=d&&q(e,t,h)},Ts=(n,e)=>{const s=e.locals?{...e.locals}:{},i=e.scalars??{};n.targets.forEach(c=>{const t=c.replace(/\s+/g,"_").toLowerCase();let h=e.series[t];h||(h=new Float32Array(e.length),h.fill(NaN),e.series[t]=h);const m=h[e.index];if(Number.isFinite(m))return;const d=i[t];if(typeof d=="number"&&Number.isFinite(d)){h[e.index]=d;return}if(e.index>0){const r=h[e.index-1];Number.isFinite(r)&&(h[e.index]=r)}}),n.kind==="for"?n.varName&&n.startExpr&&n.endExpr&&n.stepExpr&&Be({kind:"for",varName:n.varName,startExpr:n.startExpr,endExpr:n.endExpr,stepExpr:n.stepExpr,body:n.body,lineNo:n.lineNo??0},{...e,locals:s},s):n.condExpr&&Be({kind:"while",condExpr:n.condExpr,body:n.body,lineNo:n.lineNo??0},{...e,locals:s},s);const a={};return n.targets.forEach(c=>{const t=c.replace(/\s+/g,"_").toLowerCase(),h=e.series[t];a[t]=h?h[e.index]??NaN:NaN}),a},de=(n,e,s)=>R(n,{...e,locals:s,selfMode:"current"}),ze=(n,e,s,i,a,c)=>{const t=(h,m)=>q(e,h,m);for(const h of n){if(h.kind==="assign"){const m=h.name.replace(/\s+/g,"_").toLowerCase(),d=de(h.expr,e,s);h.decl==="var"||h.decl==="varip"||a.has(m)?h.decl&&h.op==="="?(i.inited.has(m)||(i.vars[m]=d,i.inited.add(m)),s[m]=i.vars[m]??NaN):(!i.inited.has(m)&&h.op===":="&&t(`fn_var_uninit:${m}`,`Function var "${h.name}" is used before initialization`),i.vars[m]=d,i.inited.add(m),s[m]=d):(h.op===":="&&!Object.prototype.hasOwnProperty.call(s,m)&&t(`fn_local_uninit:${m}`,`Function local "${h.name}" is used before initialization`),s[m]=d);continue}if(h.kind==="return")return{kind:"return",value:de(h.expr,e,s)};if(h.kind==="break"){if(!c){t(`fn_break_outside:${h.lineNo}`,"break used outside of a loop");continue}return{kind:"break"}}if(h.kind==="continue"){if(!c){t(`fn_continue_outside:${h.lineNo}`,"continue used outside of a loop");continue}return{kind:"continue"}}if(h.kind==="if"){let m=!1;for(const d of h.branches){if(m)break;if(d.cond){const l=de(d.cond,e,s);if(!ue(l,e.diagnostics,`fn_cond_na:${h.lineNo}`))continue}m=!0;const r=ze(d.body,e,s,i,a,c);if(r.kind!=="none")return r}continue}if(h.kind==="for"){const m=gt({kind:"for",varName:h.varName,startExpr:h.startExpr,endExpr:h.endExpr,stepExpr:h.stepExpr,body:h.body,lineNo:h.lineNo},e,s,i,a);if(m.kind==="return")return m;continue}if(h.kind==="while"){const m=gt({kind:"while",condExpr:h.condExpr,body:h.body,lineNo:h.lineNo},e,s,i,a);if(m.kind==="return")return m;continue}}return{kind:"none"}},gt=(n,e,s,i,a)=>{const c=e.loopRuntime,t=(c==null?void 0:c.maxIters)??un,h=(c==null?void 0:c.hasCustomMax)??!1,m=`fn_loop_max:${n.lineNo}`,d=`Loop exceeded max iterations (${t})`;if(n.kind==="for"){const u=n.varName.replace(/\s+/g,"_").toLowerCase(),f=Object.prototype.hasOwnProperty.call(s,u),o=s[u],g=de(n.startExpr,e,s),w=de(n.endExpr,e,s),k=de(n.stepExpr,e,s);if(!Number.isFinite(k)||k===0)return q(e,`fn_loop_step_zero:${n.lineNo}`,"for-loop step must not be 0"),{kind:"none"};const F=dt(g,w,k),M=Number.isFinite(t)?t:null;let N=null,p=!1;h&&M!=null?F==null?(N=M,p=!0):(N=Math.min(M,F),p=F>M):F!=null&&(N=F);const v=k>0;let y=g,_=0;for(;(N==null||_<N)&&!(!Number.isFinite(y)||!Number.isFinite(w)||v&&y>w+1e-12||!v&&y<w-1e-12);){s[u]=y;const S=ze(n.body,e,s,i,a,!0);if(S.kind==="return")return S;if(S.kind==="break")break;y+=k,_+=1,S.kind}return p&&N!=null&&_>=N&&q(e,m,d),f?s[u]=o:delete s[u],{kind:"none"}}let r=0;const l=Number.isFinite(t)?t:null;for(;l==null||r<l;){const u=de(n.condExpr,e,s);if(!ue(u,e.diagnostics,`fn_loop_cond_na:${n.lineNo}`))break;const o=ze(n.body,e,s,i,a,!0);if(o.kind==="return")return o;if(o.kind==="break")break;r+=1,o.kind}return l!=null&&r>=l&&q(e,m,d),{kind:"none"}},wt=(n,e,s)=>{const i=s.funcRuntime;if(!i)return NaN;const a=i.callState.get(e)??(()=>{const d={vars:{},inited:new Set};return i.callState.set(e,d),d})();if(a.lastIndex===s.index)return a.lastValue??NaN;const c=n.name.toLowerCase();if(i.running.has(c))return q(s,`fn_recursion:${c}`,`Function "${n.name}" is recursive`),NaN;i.running.add(c);const t={};n.args.forEach((d,r)=>{const l=d.replace(/\s+/g,"_").toLowerCase(),u=e.args[r];t[l]=u?R(u,s):NaN}),n.statefulVars.forEach(d=>{Object.prototype.hasOwnProperty.call(a.vars,d)&&(t[d]=a.vars[d])});const h=ze(n.body,s,t,a,n.statefulVars,!1);i.running.delete(c);const m=h.kind==="return"?h.value:NaN;return a.lastIndex=s.index,a.lastValue=m,m};function Nt(n){const e=n.match(/^(line|label|box|table)_get_([a-z0-9_]+)$/i);return e?{kind:e[1].toLowerCase(),prop:e[2].toLowerCase()}:null}function bt(n){const e=n.match(/^strategy_(closedtrades|opentrades)_([a-z0-9_]+)$/i);return e?{kind:e[1].toLowerCase(),prop:e[2].toLowerCase()}:null}function pt(n,e){return e?n==="session.isin"?"session_isin":n.startsWith("ta_")?n.slice(3):n.startsWith("math_")?n.slice(5):n:n}const Bs={profit_pct:"profit_percent",pnl:"profit",net_pnl:"net_profit",net_pnl_pct:"net_profit_percent",net_pnl_percent:"net_profit_percent",fee:"fees",max_profit:"max_runup",max_profit_pct:"max_runup_percent",max_profit_percent:"max_runup_percent",max_runup_pct:"max_runup_percent",max_drawdown_pct:"max_drawdown_percent",max_loss:"max_drawdown",max_loss_pct:"max_drawdown_percent",max_loss_percent:"max_drawdown_percent"};function zs(n){const e=n.toLowerCase();return Bs[e]??e}function kt(n,e,s,i,a){const c=zs(s),t=n.strategy;if(!t)return NaN;if(a<0)return NaN;if(e==="closedtrades"){const C=t.closedTrades||[];if(!C.length)return 0;const L=n.series.strategy_closedtrades,A=L?L[i]:NaN,U=(typeof A=="number"&&Number.isFinite(A)?Math.floor(A):0)-1-a;if(U<0||U>=C.length)return 0;const E=C[U],D=Number.isFinite(E.entryPrice)&&Number.isFinite(E.qty)&&E.entryPrice>0&&E.qty>0?E.entryPrice*E.qty:NaN,O=Number.isFinite(E.netPnl)?E.netPnl:Number.isFinite(E.pnl)?E.pnl-(E.fees??0):NaN,V=Number.isFinite(D)&&D!==0?O/D*100:NaN;switch(c){case"entry_price":return E.entryPrice;case"entry_time":return E.entryTimestamp;case"entry_bar_index":return E.entryIndex;case"exit_price":return E.exitPrice;case"exit_time":return E.exitTimestamp;case"exit_bar_index":return E.exitIndex;case"size":return E.qty;case"profit":return Number.isFinite(E.pnl)?E.pnl:0;case"profit_percent":return Number.isFinite(E.pnlPct)?E.pnlPct:0;case"net_profit":return Number.isFinite(O)?O:0;case"net_profit_percent":return Number.isFinite(V)?V:0;case"fees":return Number.isFinite(E.fees)?E.fees:0;case"entry_fee":return Number.isFinite(E.entryFee)?E.entryFee:0;case"exit_fee":return Number.isFinite(E.exitFee)?E.exitFee:0;case"max_runup":return typeof E.mfePct!="number"||!Number.isFinite(E.mfePct)?0:E.mfePct/100*E.entryPrice*E.qty;case"max_runup_percent":return typeof E.mfePct=="number"&&Number.isFinite(E.mfePct)?E.mfePct:0;case"max_drawdown":return typeof E.maePct!="number"||!Number.isFinite(E.maePct)?0:E.maePct/100*E.entryPrice*E.qty;case"max_drawdown_percent":return typeof E.maePct=="number"&&Number.isFinite(E.maePct)?E.maePct:0;case"is_long":return E.side==="long"?1:0;case"is_short":return E.side==="short"?1:0;case"entry_id":return x(String(E.entryOrderId??E.entrySignalId??""));case"exit_id":return x(String(E.exitOrderId??E.exitSignalId??""));default:return 0}}const h=t.openTradesByBar||[];if(i<0||i>=h.length)return 0;const m=h[i]||[];if(a>=m.length)return 0;const d=m[a],r=n.series.close,l=r&&Number.isFinite(r[i])?r[i]:NaN,u=d.qty,f=d.entryPrice,o=f>0&&u>0?f*u:NaN,g=typeof d.entryFee=="number"&&Number.isFinite(d.entryFee)?d.entryFee:0,w=Number.isFinite(l)&&Number.isFinite(f)?d.side==="long"?(l-f)*u:(f-l)*u:NaN,k=Number.isFinite(o)&&o!==0?w/o*100:NaN,F=Number.isFinite(w)&&Number.isFinite(g)?w-g:NaN,M=Number.isFinite(o)&&o!==0?F/o*100:NaN,N=d.maxFav,p=d.maxAdv,v=Number.isFinite(f)&&Number.isFinite(u)&&Number.isFinite(N)?d.side==="long"?(N-f)*u:(f-N)*u:NaN,y=Number.isFinite(f)&&f>0&&Number.isFinite(N)?d.side==="long"?(N-f)/f*100:(f-N)/f*100:NaN,_=Number.isFinite(f)&&Number.isFinite(u)&&Number.isFinite(p)?d.side==="long"?(p-f)*u:(f-p)*u:NaN,S=Number.isFinite(f)&&f>0&&Number.isFinite(p)?d.side==="long"?(p-f)/f*100:(f-p)/f*100:NaN;switch(c){case"entry_price":return f;case"entry_time":return d.entryTimestamp;case"entry_bar_index":return d.entryIndex;case"size":return u;case"profit":return Number.isFinite(w)?w:0;case"profit_percent":return Number.isFinite(k)?k:0;case"net_profit":return Number.isFinite(F)?F:0;case"net_profit_percent":return Number.isFinite(M)?M:0;case"fees":return Number.isFinite(g)?g:0;case"entry_fee":return Number.isFinite(g)?g:0;case"max_runup":return Number.isFinite(v)?v:0;case"max_runup_percent":return Number.isFinite(y)?y:0;case"max_drawdown":return Number.isFinite(_)?_:0;case"max_drawdown_percent":return Number.isFinite(S)?S:0;case"is_long":return d.side==="long"?1:0;case"is_short":return d.side==="short"?1:0;case"entry_id":return x(String(d.entryOrderId??d.entrySignalId??""));default:return 0}}function R(n,e){var i,a,c,t,h,m,d,r,l,u;const s=((i=e.scalars)==null?void 0:i.__pinev2)===1;switch(n.kind){case"NumberLiteral":return n.value;case"StringLiteral":return x(n.value);case"Identifier":return mt(n.name,e);case"MemberExpression":{const f=Se(n);return f?mt(f,e):(rt(e,n),NaN)}case"IndexExpression":return ot(e,n),NaN;case"UnaryExpression":{if(n.operator==="not"){const f=R(n.expr,e);return s?en(f):Number.isFinite(f)&&f!==0?0:1}return NaN}case"BinaryExpression":{if(n.operator==="and"||n.operator==="or"){if(s){const k=R(n.left,e),F=le(k);if(n.operator==="and"){if(F===0)return 0;const N=R(n.right,e);return we(k,N)}if(F===1)return 1;const M=R(n.right,e);return Ne(k,M)}const g=R(n.left,e),w=R(n.right,e);return n.operator==="and"?Number.isFinite(g)&&g!==0&&Number.isFinite(w)&&w!==0?1:0:Number.isFinite(g)&&g!==0||Number.isFinite(w)&&w!==0?1:0}const f=R(n.left,e),o=R(n.right,e);if(s&&tn(n.operator)&&(!Number.isFinite(f)||!Number.isFinite(o)))return NaN;switch(n.operator){case"+":return f+o;case"-":return f-o;case"*":return f*o;case"/":return be(f,o,s,e);case"%":return o===0?NaN:f%o;case">":return Number.isFinite(f)&&Number.isFinite(o)&&f>o?1:0;case"<":return Number.isFinite(f)&&Number.isFinite(o)&&f<o?1:0;case">=":return Number.isFinite(f)&&Number.isFinite(o)&&f>=o?1:0;case"<=":return Number.isFinite(f)&&Number.isFinite(o)&&f<=o?1:0;case"==":return Number.isFinite(f)&&Number.isFinite(o)&&Math.abs(f-o)<1e-9?1:0;case"!=":return Number.isFinite(f)&&Number.isFinite(o)&&Math.abs(f-o)>=1e-9?1:0;default:return NaN}}case"CallExpression":{const f=e.funcRuntime;if(f){const N=f.funcs.get(n.callee.toLowerCase());if(N)return wt(N,n,e)}const o=pt(n.callee.toLowerCase(),s);if(o==="__loop_exec"){const N=C=>C?C.kind==="StringLiteral"?C.value:C.kind==="Identifier"?C.name:null:null,p=N(n.args[0]);if(!p)return q(e,`loop_exec_missing:${j(n)}`,"__loop_exec requires loop id"),NaN;const v=e.loopRuntime;if(!v)return q(e,`loop_runtime_missing:${p}`,"Loop runtime not configured"),NaN;const y=v.plans.get(p);if(!y)return q(e,`loop_missing:${p}`,`Unknown loop "${p}"`),NaN;if(y.lastIndex!==e.index){if(v.running.has(p))return q(e,`loop_recursion:${p}`,`Loop "${p}" is recursive`),NaN;v.running.add(p);const C=Ts(y,e);y.lastIndex=e.index,y.lastValues=C,v.running.delete(p)}const _=N(n.args[1]);if(!_)return 0;const S=_.replace(/\s+/g,"_").toLowerCase();return((a=y.lastValues)==null?void 0:a[S])??NaN}const g=Nt(o);if(g&&e.draw){const N=n.args[0];let p="";if(N&&N.kind==="Identifier"&&(p=N.name),N&&N.kind==="StringLiteral"&&(p=N.value),!p)return NaN;const v=e.draw.get(g.kind,g.prop,p,e.index);return typeof v=="string"?x(v):typeof v=="number"&&Number.isFinite(v)?v:NaN}const w=bt(o);if(w){if(!e.strategy)return NaN;if(!n.args.length)throw new b(`${n.callee} expects (index)`);const N=R(n.args[0],e),p=Number.isFinite(N)?Math.floor(N):NaN;return Number.isFinite(p)?kt(e,w.kind,w.prop,e.index,p):NaN}const k=n.args[0],F=n.args[1];if(o==="__hist_index"||o==="__arr_index"){if(n.args.length!==1)throw new b(`${n.callee} expects (index)`);const N=R(k,e);return s?ce(N,o==="__hist_index"?"history_index":"array_index",o==="__hist_index"?Ae:Rn,e):N}if(o==="__arr_index_str"){if(n.args.length!==1)throw new b(`${n.callee} expects (index)`);const N=R(k,e);if(!s)return N;const p=`arr_idx_str:${j(n)}`;return Pe(N,p,e)}if(o==="__arr_set_guard"){if(n.args.length!==2)throw new b(`${n.callee} expects (index, size)`);if(!s)return 1;const N=R(k,e),p=R(F,e),v=`arr_set_guard:${j(n)}`;return rn(N,p,v,e)}if(o==="__arr_str_valid"){if(n.args.length!==1)throw new b(`${n.callee} expects (value)`);if(!s)return 1;const N=te(n.args[0]);return N||q(e,`arr_str_val:${j(n)}`,Un),N?1:0}if(o==="__str_num"){if(n.args.length!==1)throw new b(`${n.callee} expects (value)`);return R(k,e)}if(o==="nz"){if(n.args.length<1||n.args.length>2)throw new b("nz expects (x[, fallback])");const N=R(k,e);return Number.isFinite(N)?N:n.args.length===2?R(F,e):0}if(o==="between"){if(n.args.length!==3)throw new b("between expects (x, a, b)");const N=R(k,e),p=R(F,e),v=R(n.args[2],e);if(!Number.isFinite(N)||!Number.isFinite(p)||!Number.isFinite(v))return s?NaN:0;const y=Math.min(p,v),_=Math.max(p,v);return N>=y&&N<=_?1:0}if(o==="above"||o==="below"){if(n.args.length<2||n.args.length>3)throw new b(`${n.callee} expects (a, b[, tol])`);const N=R(k,e),p=R(F,e),v=n.args.length===3?R(n.args[2],e):0,y=Number.isFinite(v)?Math.max(0,v):0;return!Number.isFinite(N)||!Number.isFinite(p)?s?NaN:0:o==="above"?N>p+y?1:0:N<p-y?1:0}if(o==="higherhigh"){const N=n.args.length>=1?Math.max(1,Math.floor(R(n.args[0],e))):1,p=e.series.high;if(!p)throw new b("higherhigh requires high series");const v=p[e.index];if(!Number.isFinite(v))return s?NaN:0;const y=Math.max(0,e.index-N),_=bn(p,y,Math.max(0,e.index-1));return v>_?1:0}if(o==="lowerlow"){const N=n.args.length>=1?Math.max(1,Math.floor(R(n.args[0],e))):1,p=e.series.low;if(!p)throw new b("lowerlow requires low series");const v=p[e.index];if(!Number.isFinite(v))return s?NaN:0;const y=Math.max(0,e.index-N),_=pn(p,y,Math.max(0,e.index-1));return v<_?1:0}if(o==="swinghigh"){const N=n.args.length>=1?Math.max(1,Math.floor(R(n.args[0],e))):3,p=e.series.high;if(!p)throw new b("swinghigh requires high series");const v=p[e.index];if(!Number.isFinite(v))return s?NaN:0;for(let y=e.index-N;y<=e.index+N;y++){if(y===e.index||y<0||y>=p.length)continue;const _=p[y];if(Number.isFinite(_)&&_>=v)return 0}return 1}if(o==="swinglow"){const N=n.args.length>=1?Math.max(1,Math.floor(R(n.args[0],e))):3,p=e.series.low;if(!p)throw new b("swinglow requires low series");const v=p[e.index];if(!Number.isFinite(v))return s?NaN:0;for(let y=e.index-N;y<=e.index+N;y++){if(y===e.index||y<0||y>=p.length)continue;const _=p[y];if(Number.isFinite(_)&&_<=v)return 0}return 1}if(o==="volspike"){const N=n.args.length>=1?Math.max(1,R(n.args[0],e)):1,p=e.series.volume;if(!p)throw new b("volspike requires volume series");const v=p[e.index];if(!Number.isFinite(v))return s?NaN:0;const _=Math.max(0,e.index-20+1);let S=0,C=0;for(let A=_;A<=e.index;A++){const P=p[A];Number.isFinite(P)&&(S+=P,C+=1)}const L=C?S/C:NaN;return Number.isFinite(L)&&v>N*L?1:0}if(o==="atrspike"){const N=n.args.length>=1?Math.max(1,R(n.args[0],e)):1,p=e.series.high,v=e.series.low,y=e.series.close;if(!p||!v||!y)throw new b("atrspike requires high/low/close series");const _=U=>{const E=p[U],D=v[U],O=U>0?y[U-1]:NaN;let V=Number.isFinite(E)&&Number.isFinite(D)?Math.max(0,E-D):NaN;return Number.isFinite(O)&&(V=Math.max(V,Math.abs(E-O),Math.abs(D-O))),V};let S=NaN,C=0;for(let U=0;U<=e.index;U++){const E=_(U);C+=Number.isFinite(E)?E:0,U===13?S=C/14:U>=14&&(S=(S*13+E)/14)}let L=NaN,A=0,P=0;for(let U=Math.max(0,e.index-13);U<=e.index;U++){const E=_(U);Number.isFinite(E)&&(A+=E,P+=1)}return P&&(L=A/P),Number.isFinite(S)&&Number.isFinite(L)&&S>N*L?1:0}if(o==="trend"){const N=n.args[0],p=N&&N.kind==="StringLiteral"?N.value:N&&N.kind==="Identifier"?N.name:"",v=String(p||"").toLowerCase()||"up",y=e.series.close;if(!y)throw new b("trend requires close series");const S=Math.max(0,e.index-10+1);let C=0,L=0,A=0,P=0,U=0;for(let O=S;O<=e.index;O++){const V=O-S,ie=y[O];Number.isFinite(ie)&&(C+=V,L+=ie,A+=V*V,P+=V*ie,U+=1)}const E=U*A-C*C,D=E===0||U===0?0:(U*P-C*L)/E;return v==="up"?D>0?1:0:D<0?1:0}if(o==="iff"||o==="iif"||o==="if"){if(n.args.length!==3)throw new b(`${n.callee} expects (cond, a, b)`);if(s){const L=pe(n.args[1]),A=pe(n.args[2]);if(L!==A)return q(e,"ternary_type",Cn),NaN}const N=n.args[0],p=s&&te(N),v=s?fe(N,e,"na"):void 0;p&&q(e,fe(N,e,"type"),Re);const y=R(k,e),_=p?!1:nn(y,e,v),S=R(n.args[1],e),C=R(n.args[2],e);return _?S:C}if(o==="tostring"||o==="format"||o==="upper"||o==="lower"||o==="trim"||o==="replace"||o==="replace_all"||o==="contains"||o==="startswith"||o==="endswith"||o==="length"||o==="substring"||o==="repeat"){const N=y=>Number.isFinite(y)?String(y):"",p=y=>x(y),v=y=>{var C;const _=n.args[y];if(!_)return"";if(_.kind==="StringLiteral")return _.value;if(_.kind==="Identifier"){const L=_.name.replace(/\s+/g,"_").toLowerCase(),A=(C=e.strings)==null?void 0:C[L];if(typeof A=="string")return A}const S=R(_,e);return N(S)};if(o==="tostring"){if(n.args.length<1||n.args.length>2)throw new b("tostring expects (x[, format])");const y=R(n.args[0],e),_=n.args[1];let S="";if(_){if(_.kind==="StringLiteral")S=_.value;else if(_.kind==="Identifier"){const L=_.name.replace(/\s+/g,"_").toLowerCase(),A=(c=e.strings)==null?void 0:c[L];typeof A=="string"&&(S=A)}}const C=Pt(y,S||void 0);return p(C)}if(o==="format"){if(n.args.length<1)throw new b("format expects (fmt, ...)");const y=v(0),_=n.args.slice(1).map(C=>wn(R(C,e))),S=y.replace(/\{(\d+)\}/g,(C,L)=>_[Number(L)]??"");return p(S.replace(/{{/g,"{").replace(/}}/g,"}"))}if(o==="upper")return p(v(0).toUpperCase());if(o==="lower")return p(v(0).toLowerCase());if(o==="trim")return p(v(0).trim());if(o==="replace"||o==="replace_all"){if(n.args.length<3)throw new b("replace expects (s, from, to)");const y=v(0),_=v(1),S=v(2);return p(y.split(_).join(S))}if(o==="contains"){if(n.args.length<2)throw new b("contains expects (s, sub)");const y=v(0),_=v(1);return y.includes(_)?1:0}if(o==="startswith"){if(n.args.length<2)throw new b("startswith expects (s, sub)");const y=v(0),_=v(1);return y.startsWith(_)?1:0}if(o==="endswith"){if(n.args.length<2)throw new b("endswith expects (s, sub)");const y=v(0),_=v(1);return y.endsWith(_)?1:0}if(o==="length"){if(n.args.length!==1)throw new b("length expects (s)");return v(0).length}if(o==="substring"){if(n.args.length<2)throw new b("substring expects (s, from[, to])");const y=v(0),_=R(n.args[1],e),S=n.args.length>2?R(n.args[2],e):NaN,C=Math.max(0,Math.floor(_)),L=Number.isFinite(S)?Math.max(C,Math.floor(S)):void 0;return p(L==null?y.slice(C):y.slice(C,L))}if(o==="repeat"){if(n.args.length<2)throw new b("repeat expects (s, count)");const y=v(0),_=Math.max(0,Math.floor(R(n.args[1],e)));return p(y.repeat(_))}}if(o==="add"||o==="sub"||o==="mul"||o==="div"){if(n.args.length!==2)throw new b(`${n.callee} expects 2 arguments`);const N=R(k,e),p=R(F,e);return o==="add"?N+p:o==="sub"?N-p:o==="mul"?N*p:be(N,p,s,e)}if(o==="mod"||o==="fmod"){if(!s)throw new b(`Unknown function "${n.callee}"`);if(n.args.length!==2)throw new b(`${n.callee} expects 2 arguments`);const N=R(k,e),p=R(F,e);return o==="mod"?Zn(N,p,!0,e):Xn(N,p,!0,e)}if(o==="min"||o==="max"){if(n.args.length!==2)throw new b(`${n.callee} expects 2 arguments`);const N=R(k,e),p=R(F,e);return o==="min"?Math.min(N,p):Math.max(N,p)}if(o==="abs"){if(n.args.length!==1)throw new b("abs expects 1 argument");return Math.abs(R(k,e))}if(o==="pow"){if(n.args.length!==2)throw new b("pow expects 2 arguments");const N=R(k,e),p=R(F,e);return sn(N,p,s,e)}if(o==="sqrt"||o==="log"||o==="ln"||o==="log10"||o==="exp"||o==="floor"||o==="ceil"||o==="round"||o==="sin"||o==="cos"||o==="tan"||o==="asin"||o==="acos"||o==="atan"||o==="sign"){if(n.args.length!==1)throw new b(`${n.callee} expects 1 argument`);const N=R(k,e);switch(o){case"sqrt":return Jn(N,s,e);case"log":case"ln":return Qn(N,s,e);case"log10":return xn(N,s,e);case"exp":return st(N,s);case"floor":return Math.floor(N);case"ceil":return Math.ceil(N);case"round":return Math.round(N);case"sin":return Math.sin(N);case"cos":return Math.cos(N);case"tan":return tt(N,s);case"asin":return et(N,s,e);case"acos":return nt(N,s,e);case"atan":return Math.atan(N);default:return Math.sign(N)}}if(o==="cum"||o==="cumsum"){if(n.args.length!==1)throw new b(`${n.callee} expects 1 argument`);const N=k;if(N.kind!=="Identifier")throw new b(`${n.callee} expects a series identifier`);const p=N.name.replace(/\s+/g,"_").toLowerCase(),v=e.series[p];if(!v)throw new b(`Unknown identifier "${N.name}"`);let y=0;for(let _=0;_<=e.index;_++){const S=v[_];Number.isFinite(S)&&(y+=S)}return y}if(o==="barssince"){if(n.args.length!==1)throw new b("barssince expects (condition)");const N=k;if(N.kind!=="Identifier")throw new b("barssince expects a series identifier");const p=N.name.replace(/\s+/g,"_").toLowerCase(),v=e.series[p];if(!v)throw new b(`Unknown identifier "${N.name}"`);for(let y=e.index;y>=0;y--){const _=v[y];if(Number.isFinite(_)&&_!==0)return e.index-y}return NaN}if(o==="tr"){if(n.args.length!==0&&n.args.length!==3)throw new b("tr expects () or (high, low, close)");const N=(A,P)=>{if(!A){const D=e.series[P];if(!D)throw new b(`Unknown identifier "${P}"`);return D}if(A.kind!=="Identifier")throw new b("tr expects series identifiers");const U=A.name.replace(/\s+/g,"_").toLowerCase(),E=e.series[U];if(!E)throw new b(`Unknown identifier "${A.name}"`);return E},p=N(n.args[0],"high"),v=N(n.args[1],"low"),y=N(n.args[2],"close"),_=p[e.index],S=v[e.index],C=e.index>0?y[e.index-1]:NaN;let L=Math.max(0,_-S);return Number.isFinite(C)&&(L=Math.max(L,Math.abs(_-C),Math.abs(S-C))),L}if(o==="prev"||o==="lag"||o==="change"){if(n.args.length!==2)throw new b(`${n.callee} expects (series, n)`);const N=k;if(N.kind!=="Identifier")throw new b(`${n.callee} expects first argument to be a series identifier`);const p=N.name.replace(/\s+/g,"_").toLowerCase(),v=R(F,e),y=s?ce(v,"history_index",Ae,e):Math.max(1,Math.floor(v));if(!Number.isFinite(y))return NaN;const _=e.index-y,S=A=>{if(A<0)return NaN;if(e.selfKey&&e.selfOut&&p===e.selfKey)return e.selfOut[A]??NaN;const P=e.series[p];if(!P)throw new b(`Unknown identifier "${N.name}"`);return P[A]??NaN};if(o==="prev"||o==="lag")return S(_);const C=S(e.index),L=S(_);return Number.isFinite(C)&&Number.isFinite(L)?C-L:NaN}if(o==="sum"){if(n.args.length!==2)throw new b("sum expects (series, period)");const N=he(k,e);if(!N)throw new b("sum expects first argument to be a series identifier");const p=R(F,e),v=s?B(p,`sum_len:${j(n)}`,Wn,e):Math.max(1,Math.floor(p));return Number.isFinite(v)?X(e,`sum:${v}:${j(k)}`,()=>W(N,v))[e.index]??NaN:NaN}if(o==="highest"||o==="lowest"){if(n.args.length!==2)throw new b(`${n.callee} expects (series, period)`);const N=he(k,e);if(!N)throw new b(`${n.callee} expects first argument to be a series identifier`);const p=R(F,e),v=`${o}_len:${j(n)}`,_=s?B(p,v,o==="highest"?Gn:Kn,e):Math.max(1,Math.floor(p));return Number.isFinite(_)?X(e,`${o}:${_}:${j(k)}`,()=>o==="highest"?Fe(N,_):ve(N,_))[e.index]??NaN:NaN}if(o==="rising"||o==="falling"){if(!s)throw new b(`Unknown function "${n.callee}"`);if(n.args.length!==2)throw new b(`${n.callee} expects (series, length)`);const N=he(k,e);if(!N)throw new b(`${n.callee} expects first argument to be a series identifier`);const p=R(F,e),v=`${o}_len:${j(n)}`,_=B(p,v,o==="rising"?Hn:Yn,e);return Number.isFinite(_)?X(e,`${o}:${_}:${j(k)}`,()=>Nn(N,_,o))[e.index]??NaN:NaN}if(o==="crossover"||o==="crossunder"){if(n.args.length<2||n.args.length>3)throw new b(`${n.callee} expects (series, series[, tol])`);const N=k;if(N.kind!=="Identifier")throw new b(`${n.callee} expects first argument to be a series identifier`);const p=N.name.replace(/\s+/g,"_").toLowerCase(),v=e.series[p];if(!v)throw new b(`Unknown identifier "${N.name}"`);const y=n.args[1];let _=null,S=NaN;if(y.kind==="Identifier"){const E=y.name.replace(/\s+/g,"_").toLowerCase();if(_=e.series[E]||null,!_){const D=Number(y.name);S=Number.isFinite(D)?D:NaN}}else S=R(y,e);const C=n.args[2]?Math.max(0,R(n.args[2],e)):0;if(e.index<=0)return 0;const L=v[e.index-1],A=v[e.index],P=_?_[e.index-1]:S,U=_?_[e.index]:S;return[L,A,P,U].every(Number.isFinite)?o==="crossover"?L<=P+C&&A>U+C?1:0:L>=P-C&&A<U-C?1:0:0}if(o==="williamsr"){if(!s)throw new b(`Unknown function "${n.callee}"`);if(n.args.length!==1&&n.args.length!==4)throw new b("williamsr expects (length) or (high, low, close, length)");const N=n.args.length===1?R(n.args[0],e):R(n.args[3],e),p=B(N,"williamsr_len",Pn,e);if(!Number.isFinite(p))return NaN;const v=n.args.length===1?e.series.high:he(n.args[0],e),y=n.args.length===1?e.series.low:he(n.args[1],e),_=n.args.length===1?e.series.close:he(n.args[2],e);if(!v||!y||!_)throw new b("williamsr requires high/low/close series");const S=n.args.length===1?`williamsr:${p}`:`williamsr:${p}:${n.args.map(L=>L.kind==="Identifier"?L.name:L.kind==="NumberLiteral"||L.kind==="StringLiteral"?L.value:"expr").join("|")}`;return X(e,S,()=>kn(v,y,_,p))[e.index]??NaN}if(o==="aroon"){if(!s)throw new b(`Unknown function "${n.callee}"`);if(n.args.length<1||n.args.length>2)throw new b("aroon expects (length[, output])");const N=R(n.args[0],e),p=B(N,"aroon_len",qn,e);if(!Number.isFinite(p))return NaN;const v=n.args[1]?Math.floor(R(n.args[1],e)):0;if(!Number.isFinite(v)||v<0||v>1)throw new b("aroon output must be 0 or 1");const y=e.series.high,_=e.series.low;if(!y||!_)throw new b("aroon requires high/low series");const S=`aroon:${p}`,C=je(e,S,()=>{const A=Ie(y,_,p);return{a:A.up,b:A.down}});return(v===0?C.a:C.b)[e.index]??NaN}if(o==="aroonosc"){if(!s)throw new b(`Unknown function "${n.callee}"`);if(n.args.length!==1)throw new b("aroonosc expects (length)");const N=R(n.args[0],e),p=B(N,"aroonosc_len",Vn,e);if(!Number.isFinite(p))return NaN;const v=e.series.high,y=e.series.low;if(!v||!y)throw new b("aroonosc requires high/low series");const _=`aroon:${p}`,S=je(e,_,()=>{const A=Ie(v,y,p);return{a:A.up,b:A.down}}),C=S.a[e.index],L=S.b[e.index];return Number.isFinite(C)&&Number.isFinite(L)?C-L:NaN}if(o==="dmi"){if(!s)throw new b(`Unknown function "${n.callee}"`);if(n.args.length<2||n.args.length>3)throw new b("dmi expects (length, smoothing[, output])");const N=R(n.args[0],e),p=R(n.args[1],e),v=B(N,"dmi_len",jn,e),y=B(p,"dmi_smooth",Dn,e);if(!Number.isFinite(v)||!Number.isFinite(y))return NaN;const _=n.args[2]?Math.floor(R(n.args[2],e)):0;if(!Number.isFinite(_)||_<0||_>2)throw new b("dmi output must be 0, 1, or 2");const S=e.series.high,C=e.series.low,L=e.series.close;if(!S||!C||!L)throw new b("dmi requires high/low/close series");const A=`dmi:${v}:${y}`,P=De(e,A,()=>{const E=re(S,C,L,v,y);return{a:E.plus,b:E.minus,c:E.adx}});return(_===0?P.a:_===1?P.b:P.c)[e.index]??NaN}if(o==="plus_di"||o==="minus_di"||o==="dx"){if(!s)throw new b(`Unknown function "${n.callee}"`);if(n.args.length!==1)throw new b(`${n.callee} expects (length)`);const N=R(n.args[0],e),y=B(N,o==="plus_di"?"plus_di_len":o==="minus_di"?"minus_di_len":"dx_len",o==="plus_di"?Tn:o==="minus_di"?Bn:zn,e);if(!Number.isFinite(y))return NaN;const _=e.series.high,S=e.series.low,C=e.series.close;if(!_||!S||!C)throw new b(`${o} requires high/low/close series`);const L=`dmi:${y}:${y}`,A=De(e,L,()=>{const U=re(_,S,C,y,y);return{a:U.plus,b:U.minus,c:U.adx}});return o==="plus_di"?A.a[e.index]??NaN:o==="minus_di"?A.b[e.index]??NaN:X(e,`dx:${y}`,()=>Fn(A.a,A.b))[e.index]??NaN}if(o==="adx"){if(!s)throw new b(`Unknown function "${n.callee}"`);if(n.args.length!==1)throw new b("adx expects (length)");const N=R(n.args[0],e),p=B(N,"adx_len",On,e);if(!Number.isFinite(p))return NaN;const v=e.series.high,y=e.series.low,_=e.series.close;if(!v||!y||!_)throw new b("adx requires high/low/close series");const S=`dmi:${p}:${p}`;return De(e,S,()=>{const L=re(v,y,_,p,p);return{a:L.plus,b:L.minus,c:L.adx}}).c[e.index]??NaN}if(o==="valuewhen"){if(!(((t=e.scalars)==null?void 0:t.__pinev2)===1))throw new b(`Unknown function "${n.callee}"`);if(n.args.length!==3)throw new b("valuewhen expects (condition, source, occurrence)");const p=n.args[0],v=te(p);v&&q(e,fe(p,e,"type"),Re);const y=n.args[2],_=`valuewhen_occ:${j(n)}`;if(es(y,e))return q(e,_,Ue),NaN;const S=R(y,e),C=ce(S,_,Ue,e);if(!Number.isFinite(C)||v)return NaN;const L=fe(p,e,"na"),A=D=>ue(D,e.diagnostics,L),P=he(p,e),U=he(n.args[1],e);if(P&&U)return X(e,`valuewhen:${C}:${j(p)}:${j(n.args[1])}`,()=>vn(P,U,C,A))[e.index]??NaN;let E=0;for(let D=e.index;D>=0;D--){const O={...e,index:D},V=R(p,O);if(A(V)){if(E===C)return R(n.args[1],O);E+=1}}return NaN}if(o==="pivothigh"||o==="pivotlow"){if(!(((h=e.scalars)==null?void 0:h.__pinev2)===1))throw new b(`Unknown function "${n.callee}"`);if(n.args.length!==3)throw new b(`${n.callee} expects (source, left, right)`);const p=R(n.args[1],e),v=R(n.args[2],e),{left:y,right:_}=yn(p,v),S=e.index-_;if(S-y<0)return NaN;const C=E=>R(n.args[0],{...e,index:E}),L=C(S);if(!Number.isFinite(L))return NaN;const A=S-y,P=S+_,U=o==="pivothigh";for(let E=A;E<=P;E++){const D=C(E);if(!Number.isFinite(D))return NaN;if(U){if(D>L)return NaN}else if(D<L)return NaN}return L}if(o==="isin"||o==="session_isin"||o==="session.isin"){if(!(((m=e.scalars)==null?void 0:m.__pinev2)===1))throw new b(`Unknown function "${n.callee}"`);if(n.args.length!==2)throw new b("session.isin expects (time, session)");const p=n.args[1];if(!p||p.kind!=="StringLiteral")throw new b(Le);const{start:v,end:y}=Ln(p.value),_=R(n.args[0],e);if(!Number.isFinite(_))throw new b(Je);const S=Qe(_);return xe(S,v,y)?1:0}if(o==="year"||o==="month"||o==="dayofweek"||o==="hour"||o==="minute"||o==="second"){if(!(((d=e.scalars)==null?void 0:d.__pinev2)===1))throw new b(`Unknown function "${n.callee}"`);if(n.args.length!==1)throw new b(`${n.callee} expects (time)`);const p=R(n.args[0],e);return oe(p),o==="dayofweek"?Xe(p):Ze(p,o==="year"||o==="month"?o:o==="hour"?"hour":o==="minute"?"minute":"second")}if(o==="timestamp"){if(!(((r=e.scalars)==null?void 0:r.__pinev2)===1))throw new b(`Unknown function "${n.callee}"`);if(n.args.length<5||n.args.length>6)throw new b("timestamp expects (year, month, day, hour, minute[, second])");const p=R(n.args[0],e),v=R(n.args[1],e),y=R(n.args[2],e),_=R(n.args[3],e),S=R(n.args[4],e),C=n.args[5]?R(n.args[5],e):0;return An(p,v,y,_,S,C)}if(o==="timenow"){if(!(((l=e.scalars)==null?void 0:l.__pinev2)===1))throw new b(`Unknown function "${n.callee}"`);if(n.args.length!==0)throw new b("timenow expects ()");return En(e)}if(o==="time_close"){if(!(((u=e.scalars)==null?void 0:u.__pinev2)===1))throw new b(`Unknown function "${n.callee}"`);if(n.args.length!==0)throw new b("time_close expects ()");const p=e.series.time;if(!p)throw new b("time_close requires time series");const v=Sn(e),y=p[e.index];return Number.isFinite(y)?y+v:NaN}const M={length:e.length,series:e.series,seriesNames:new Set(Object.keys(e.series)),scalars:e.scalars,strings:e.strings,diagnostics:e.diagnostics,draw:e.draw,strategy:e.strategy,loopRuntime:e.loopRuntime,funcRuntime:e.funcRuntime};try{const N=`call:${j(n)}`;return X(e,N,()=>{const v=ht(n,M);if(v.kind==="series")return v.value;const y=new Float32Array(e.length);return y.fill(v.value),y})[e.index]??NaN}catch(N){if(N instanceof b)throw N}throw new b(`Unknown function "${n.callee}"`)}default:return NaN}}function Vs(n,e,s,i,a,c){var g;const t=Object.entries(e),h=((g=t[0])==null?void 0:g[1].length)??0;for(const[,w]of t)if(w.length!==h)throw new b("All base series must have the same length");const m=(()=>{if(!s||typeof s!="object")return;const w={};return Object.entries(s).forEach(([k,F])=>{const M=k.replace(/\s+/g,"_").toLowerCase();if(typeof F=="number"&&Number.isFinite(F)){w[M]=F;return}if(typeof F=="string"){const N=Number(F);w[M]=Number.isFinite(N)?N:x(F)}}),Object.keys(w).length?w:void 0})(),d=(()=>{if(!s||typeof s!="object")return;const w={};return Object.entries(s).forEach(([k,F])=>{typeof F=="string"&&(w[k.replace(/\s+/g,"_").toLowerCase()]=F)}),Object.keys(w).length?w:void 0})(),r=js(c==null?void 0:c.loopPlans,m,!!(c!=null&&c.userFunctions)),l=Os(c==null?void 0:c.userFunctions);let u;try{u=We(n)}catch(w){throw w instanceof me?new b(`Syntax error at position ${w.position}: ${w.message}`):w}const f=new Float32Array(h),o=new Map;for(let w=0;w<h;w++){const k={series:e,scalars:m,strings:d,diagnostics:a,memo:o,length:h,index:w,strategy:i,loopRuntime:r,funcRuntime:l};f[w]=R(u,k)}return f}function Ve(n,e){const s=n.length,i=new Float32Array(s);for(let a=0;a<s;a++){const c=a-e;i[a]=c>=0?n[c]:NaN}return i}const Ft=n=>/[A-Za-z_$]/.test(n),_e=n=>/[A-Za-z0-9_$]/.test(n),Gs=/^[-+]?(?:\d+(?:\.\d*)?|\.\d+)(?:[eE][-+]?\d+)?/,Ks=/[-+]?(?:\d+(?:\.\d*)?|\.\d+)(?:[eE][-+]?\d+)?$/,vt=(n,e)=>{let s=e;for(;s>=0&&/\s/.test(n[s]);)s-=1;return s},yt=(n,e)=>{let s=e;for(;s<n.length&&/\s/.test(n[s]);)s+=1;return s},Ws=(n,e)=>{let s=1;for(let i=e-1;i>=0;i-=1){const a=n[i];if(a===")")s+=1;else if(a==="("&&(s-=1,s===0))return i}return-1},_t=(n,e)=>{let s=1;for(let i=e+1;i<n.length;i+=1){const a=n[i];if(a==="(")s+=1;else if(a===")"&&(s-=1,s===0))return i}return-1},Hs=(n,e)=>{const s=vt(n,e-1);if(s<0)return null;const i=s+1,a=n[s];if(a===")"){const t=Ws(n,s);if(t<0)return null;let h=t,m=vt(n,h-1);if(m>=0&&_e(n[m])){let d=m;for(;d>=0&&_e(n[d]);)d-=1;h=d+1}return{start:h,end:i}}if(_e(a)){let t=s;for(;t-1>=0&&_e(n[t-1]);)t-=1;return{start:t,end:i}}const c=Ks.exec(n.slice(0,i));return c?{start:i-c[0].length,end:i}:null},Ys=(n,e)=>{let s=yt(n,e);if(s>=n.length)return null;const i=n[s];if(i==="("){const c=_t(n,s);return c<0?null:{start:s,end:c+1}}if(Ft(i)){let c=s+1;for(;c<n.length&&_e(n[c]);)c+=1;const t=yt(n,c);if(n[t]==="("){const h=_t(n,t);return h<0?null:{start:s,end:h+1}}return{start:s,end:c}}const a=Gs.exec(n.slice(s));return a?{start:s,end:s+a[0].length}:null};function Xs(n){const e=String(n||""),s=e.length;if(!/crosses/i.test(e))return e;const i=[];let a=null,c=0;for(;c<s;){const m=e[c];if(a){m===a&&e[c-1]!=="\\"&&(a=null),c+=1;continue}if(m==="'"||m==='"'){a=m,c+=1;continue}if(Ft(m)){let d=c+1;for(;d<s&&_e(e[d]);)d+=1;const l=e.slice(c,d).toLowerCase();if(l==="crossesabove"||l==="crossesbelow"){const u=Hs(e,c),f=Ys(e,d);if(u&&f){i.push({start:u.start,end:f.end,left:u,right:f,fn:l==="crossesabove"?"crossover":"crossunder"}),c=f.end;continue}}c=d;continue}c+=1}if(!i.length)return e;let t="",h=0;for(const m of i){t+=e.slice(h,m.start);const d=e.slice(m.left.start,m.left.end).trim(),r=e.slice(m.right.start,m.right.end).trim();t+=`${m.fn}(${d}, ${r})`,h=m.end}return t+=e.slice(h),t}const Ge=n=>/[A-Za-z_$]/.test(n),Ke=n=>/[A-Za-z0-9_$]/.test(n);function Zs(n){return String(n||"").replace(/\u00A0/g," ")}function Mt(n){const e=String(n||"");let s="",i=null,a=!1;for(let c=0;c<e.length;c++){const t=e[c],h=e[c+1];if(i){if(s+=t,a){a=!1;continue}if(t==="\\"){a=!0;continue}t===i&&(i=null);continue}if(t==="'"||t==='"'){i=t,s+=t;continue}if(t==="/"&&h==="/"){for(c+=1;c+1<e.length;){const m=e[c+1];if(m===`
`||m==="\r")break;c+=1}continue}s+=t}return s}function Js(n,e){const s=String(n||""),i=s.length;let a="",c=null,t=0;for(;t<i;){const h=s[t];if(c){a+=h,h===c&&s[t-1]!=="\\"&&(c=null),t+=1;continue}if(h==="'"||h==='"'){c=h,a+=h,t+=1;continue}if(Ge(h)){let m=t+1;for(;m<i&&Ke(s[m]);)m+=1;const d=s.slice(t,m),r=d.toLowerCase();let l=m;for(;l<i&&/\s/.test(s[l]);)l+=1;if(s[l]==="."){let u=l+1;for(;u<i&&/\s/.test(s[u]);)u+=1;if(u<i&&Ge(s[u])){let f=u+1;for(;f<i&&Ke(s[f]);)f+=1;const o=s.slice(u,f),g=o.toLowerCase();if(r==="strategy"&&(g==="closedtrades"||g==="opentrades")){let k=f;for(;k<i&&/\s/.test(s[k]);)k+=1;if(s[k]==="."){let F=k+1;for(;F<i&&/\s/.test(s[F]);)F+=1;if(F<i&&Ge(s[F])){let M=F+1;for(;M<i&&Ke(s[M]);)M+=1;const N=s.slice(F,M);a+=`strategy_${g}_${N}`,t=M;continue}}}if(r==="barstate"||r==="timeframe"||r==="syminfo"||r==="strategy"){a+=`${r}_${o}`,t=f;continue}if(e){if(r==="ta"||r==="math"||r==="session"||r==="color"){a+=`${r}_${o}`,t=f;continue}}else if(r==="ta"||r==="math"){a+=o,t=f;continue}}}a+=d,t=m;continue}a+=h,t+=1}return a}function Qs(n,e){const s=String(n||"");let i="",a=null,c=0;for(;c<s.length;){const t=s[c];if(a){i+=t,t===a&&s[c-1]!=="\\"&&(a=null),c+=1;continue}if(t==="'"||t==='"'){a=t,i+=t,c+=1;continue}if(Ge(t)){let h=c+1;for(;h<s.length&&Ke(s[h]);)h+=1;const m=s.slice(c,h);let d=c-1;for(;d>=0&&/\s/.test(s[d]);)d-=1;if(d>=0&&s[d]==="."){i+=m,c=h;continue}let r=h;for(;r<s.length&&/\s/.test(s[r]);)r+=1;if(s[r]==="["&&e){let l=0,u=r,f=null;for(;u<s.length;u++){const o=s[u];if(f){o===f&&s[u-1]!=="\\"&&(f=null);continue}if(o==="'"||o==='"'){f=o;continue}if(o==="[")l+=1;else if(o==="]"&&(l-=1,l===0))break}if(u<s.length&&l===0){const o=s.slice(r+1,u).trim();if(o){i+=`prev(${m}, __hist_index(${o}))`,c=u+1;continue}}}else if(s[r]==="["){let l=r+1;for(;l<s.length&&/\s/.test(s[l]);)l+=1;let u=1;s[l]==="-"&&(u=-1,l+=1);let f=l;for(;f<s.length&&/[0-9]/.test(s[f]);)f+=1;const o=s.slice(l,f);for(;f<s.length&&/\s/.test(s[f]);)f+=1;if(o&&s[f]==="]"){const g=u*Number(o);if(Number.isFinite(g)&&g>=1){i+=`prev(${m}, ${Math.floor(g)})`,c=f+1;continue}if(Number.isFinite(g)&&g===0){i+=m,c=f+1;continue}}}i+=m,c=h;continue}i+=t,c+=1}return i}function xs(n){if(!n)return 0;let e=2166136261;for(let i=0;i<n.length;i++)e^=n.charCodeAt(i),e=Math.imul(e,16777619);const s=e>>>0;return s===0?1:s}function ei(n){const e=String(n||"");let s="",i=0;for(;i<e.length;){const a=e[i];if(a==='"'||a==="'"){const c=a;i+=1;let t="",h=!1;for(;i<e.length;){const m=e[i];if(h){t+=m,h=!1,i+=1;continue}if(m==="\\"){h=!0,i+=1;continue}if(m===c){i+=1;break}t+=m,i+=1}s+=String(xs(t));continue}s+=a,i+=1}return s}function ni(n,e){const s=!!(e!=null&&e.pineV2);let i=Zs(String(n||""));return i=Mt(i),i=Js(i,s),s||(i=ei(i)),i=Qs(i,s),{expr:i}}function ti(n){return n==="entry_long"||n==="exit_long"||n==="entry_short"||n==="exit_short"||n==="alert"||n==="cancel"||n==="cancel_all"}self.onmessage=n=>{var S,C;const e=n.data,s=[],i=[];if(!e||!e.signals||!e.condSeries){const L={id:(e==null?void 0:e.id)||"unknown",signals:[],errors:["Invalid request"]};self.postMessage(L);return}const a=e.condSeries,c=e.params&&typeof e.params=="object"?e.params:void 0,t=Array.isArray(e.userFunctions)?e.userFunctions:void 0,h=(c==null?void 0:c.__pinev2)===1,m=L=>String(L||"").replace(/\$\{([^}]+)\}/g,(A,P)=>{var E;const U=(c==null?void 0:c[P])??(c==null?void 0:c[(E=P==null?void 0:P.toLowerCase)==null?void 0:E.call(P)]);return U==null?A:String(U)}),d=L=>{const A=String(L||"").replace(/\bstr\./gi,"");return ni(A,{pineV2:h}).expr},r=L=>{const A=m(L);let P=Mt(String(A||"")).replace(/#.*$/,"").split(";")[0].replace(/[,;]+\s*$/,"").replace(/\b(and|or)\b\s*$/i,"").replace(/\bcrosses\s+above\b/gi,"crossesAbove").replace(/\bcrosses\s+below\b/gi,"crossesBelow");return Xs(d(P))},l=e.bars||[],u=l.length||(((S=Object.values(a)[0])==null?void 0:S.length)??0),f={};Object.entries(a).forEach(([L,A])=>{const P=L.replace(/\s+/g,"_").toLowerCase();if(A instanceof Float32Array){f[P]=A;return}const U=new Float32Array(u);for(let E=0;E<u;E++)U[E]=(A==null?void 0:A[E])??NaN;f[P]=U});const o=new Map,g=new Map,w=new Map,k=new Map,F=new Set,M="condition must be bool or number",N=(L,A)=>{const P=A!=null&&A.when?r(L):d(m(L));if(!P)return null;const U=o.get(P);if(U)return U;try{const E=Vs(P,f,c,void 0,void 0,{userFunctions:t});return o.set(P,E),E}catch(E){return i.push(`Expression error for signal: ${(E==null?void 0:E.message)||String(E)}`),null}},p=L=>{const A=r(L);if(!A)return null;const P=w.get(A);if(P)return P;try{const U=We(A);return w.set(A,U),U}catch{return null}},v=L=>{const A=r(L);if(!A)return!1;const P=k.get(A);if(P!=null)return P;const U=p(L),E=U?te(U):!1;return k.set(A,E),E},y=L=>{const A=r(L);if(!A)return null;const P=g.get(A);if(P)return P;if(h&&v(L)){F.has(A)||(i.push(M),F.add(A));const O=new Uint8Array(u);return g.set(A,O),O}const U=N(L,{when:!0});if(!U)return null;const E=new Uint8Array(u),D=h?`cond_na:${A}`:"";for(let O=0;O<u;O++){const V=U[O];E[O]=h?ue(V,void 0,D)?1:0:Number.isFinite(V)&&V!==0?1:0}return g.set(A,E),E};for(let L=0;L<e.signals.length;L++){const A=e.signals[L];if(!ti(String(A==null?void 0:A.type))){i.push(`Unknown signal type: ${String(A==null?void 0:A.type)}`);continue}const P=String((A==null?void 0:A.id)||L),U=(A==null?void 0:A.orderId)!=null&&String(A.orderId).trim()?String(A.orderId).trim():void 0,E=String((A==null?void 0:A.whenExpr)||"").trim(),D=String((A==null?void 0:A.when)||"").trim();if(!E&&!D){i.push(`Empty condition for ${A.type}`);continue}let O;if(E){const T=y(E);if(!T)continue;O=T}else{const T=y(D);if(!T)continue;O=T}const V=String((A==null?void 0:A.cooldownExpr)||"").trim(),ie=V?N(V):null;if(ie){for(let T=0;T<u;T++){const Z=ie[T];if(Number.isFinite(Z)&&(!Number.isInteger(Z)||Z<0)){i.push(`cooldownExpr must be a non-negative integer for ${A.type}`),O=null;break}}if(!O)continue}const mn=A==null?void 0:A.cooldownBars,si=typeof mn=="number"&&Number.isFinite(mn)?Math.max(0,Math.floor(mn)):0,$t=String((A==null?void 0:A.scoreExpr)||"").trim(),Ee=$t?N($t):null;if(Ee){for(let T=0;T<u;T++){const Z=Ee[T];if(Number.isFinite(Z)&&(!Number.isInteger(Z)||Z<0||Z>10)){i.push(`scoreExpr must be an integer 0..10 for ${A.type}`),O=null;break}}if(!O)continue}const dn=A==null?void 0:A.score,ii=typeof dn=="number"&&Number.isFinite(dn)?dn:null;let At=0;for(let T=0;T<u;T++){const Z=ie&&Number.isFinite(ie[T])?Math.max(0,Math.floor(ie[T])):si;if(Z>0&&T<At||!O[T])continue;const ri=((C=l[T])==null?void 0:C.timestamp)??Date.now(),St=Ee&&Number.isFinite(Ee[T])?Ee[T]:ii;s.push({type:A.type,index:T,timestamp:ri,signalId:P,orderId:U,order:A.order,score:St??null}),Z>0&&(At=T+Z)}}const _={id:e.id,signals:s,errors:i.length?i:void 0};self.postMessage(_)}})();
